
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Î” Helix | CFTR Clinica</title>
    
    <!-- Fonts & Icons - Premium -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind (grid only) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===================================================================
           Î” HELIX â€” ULTIMATE HYBRID SYSTEM
           Best of V1 + V2 + V3 + NEXT-GEN FEATURES
           Scientific precision â€¢ Clinical intelligence â€¢ Zero compromise
           =================================================================== */
        
        :root {
            /* Primary scientific palette â€” ENHANCED */
            --color-primary: #0a2e5a;
            --color-primary-light: #1a4a7a;
            --color-primary-lighter: #e9f0f9;
            --color-primary-dark: #051c34;
            
            --color-accent: #0e7c7b;
            --color-accent-light: #d5f5f5;
            --color-accent-lighter: #f0fdfa;
            --color-accent-dark: #0a5e5d;
            
            /* CFTR Class colors â€” VIBRANT */
            --color-class-i: #b91c1c;
            --color-class-i-light: #fee2e2;
            --color-class-i-dark: #991b1b;
            
            --color-class-ii: #b45309;
            --color-class-ii-light: #ffedd5;
            --color-class-ii-dark: #9a3412;
            
            --color-class-iii: #0f766e;
            --color-class-iii-light: #ccfbf1;
            --color-class-iii-dark: #115e59;
            
            --color-class-iv: #1e40af;
            --color-class-iv-light: #dbeafe;
            --color-class-iv-dark: #1e3a8a;
            
            --color-class-v: #6d28d9;
            --color-class-v-light: #ede9fe;
            --color-class-v-dark: #5b21b6;
            
            /* Semantic */
            --color-success: #0e7b4e;
            --color-success-light: #e3f9e9;
            --color-warning: #b45309;
            --color-warning-light: #ffedd5;
            --color-error: #b91c1c;
            --color-error-light: #fee2e2;
            --color-info: #1e40af;
            --color-info-light: #dbeafe;
            
            /* Typography â€” SCIENTIFIC GRADE */
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
            
            /* Type scale â€” PRECISE */
            --text-2xs: 0.625rem;  /* 10px */
            --text-xs: 0.75rem;     /* 12px */
            --text-sm: 0.875rem;    /* 14px */
            --text-base: 1rem;      /* 16px */
            --text-lg: 1.125rem;    /* 18px */
            --text-xl: 1.25rem;     /* 20px */
            --text-2xl: 1.5rem;     /* 24px */
            --text-3xl: 1.875rem;   /* 30px */
            --text-4xl: 2.25rem;    /* 36px */
            
            /* Spacing â€” 8-point system */
            --space-0: 0rem;
            --space-1: 0.25rem;     /* 4px */
            --space-2: 0.5rem;      /* 8px */
            --space-3: 0.75rem;     /* 12px */
            --space-4: 1rem;        /* 16px */
            --space-5: 1.25rem;     /* 20px */
            --space-6: 1.5rem;      /* 24px */
            --space-8: 2rem;        /* 32px */
            --space-10: 2.5rem;     /* 40px */
            --space-12: 3rem;       /* 48px */
            
            /* Shadows â€” DEPTH */
            --shadow-xs: 0 1px 2px rgba(0,0,0,0.02);
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 12px -2px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 25px -5px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 30px -8px rgba(0,0,0,0.1);
            
            /* Radius â€” CONSISTENT */
            --radius-sm: 0.375rem;   /* 6px */
            --radius: 0.5rem;        /* 8px */
            --radius-md: 0.75rem;    /* 12px */
            --radius-lg: 1rem;       /* 16px */
            --radius-xl: 1.25rem;    /* 20px */
            --radius-2xl: 1.5rem;    /* 24px */
            --radius-full: 9999px;
            
            /* Transitions */
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ========== RESET & BASE ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: var(--text-base);
            line-height: 1.6;
            color: #111827;
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* ========== TYPOGRAPHY UTILITIES ========== */
        .heading-1 {
            font-family: var(--font-display);
            font-size: var(--text-3xl);
            font-weight: 700;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .heading-2 {
            font-family: var(--font-display);
            font-size: var(--text-2xl);
            font-weight: 600;
            line-height: 1.3;
            letter-spacing: -0.01em;
        }

        .heading-3 {
            font-family: var(--font-display);
            font-size: var(--text-xl);
            font-weight: 600;
            line-height: 1.4;
        }

        .caption {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
        }

        .mono {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
        }

        /* ========== CARD SYSTEM â€” NEXT-GEN ========== */
        .card {
            background: white;
            border-radius: var(--radius-lg);
            border: 1px solid rgba(229, 231, 235, 0.8);
            box-shadow: var(--shadow-xs);
            transition: var(--transition-base);
            overflow: hidden;
            backdrop-filter: blur(8px);
            position: relative;
        }

        .card::after {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            pointer-events: none;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
        }

        .card:hover {
            border-color: var(--color-accent-light);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            padding: var(--space-4) var(--space-6);
            border-bottom: 1px solid #f0f2f5;
            background: rgba(249, 250, 251, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: 600;
        }

        .card-body {
            padding: var(--space-6);
        }

        /* ========== VARIANT PILL â€” ICONIC ========== */
        .variant-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.625rem 1.5rem;
            background: linear-gradient(145deg, #059669, #10b981);
            border-radius: var(--radius-full);
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.25);
            transition: var(--transition-bounce);
            border: 1px solid rgba(255,255,255,0.3);
            width: fit-content;
            position: relative;
            overflow: hidden;
        }

        .variant-pill::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.3), transparent);
            border-radius: inherit;
            pointer-events: none;
        }

        .variant-pill:hover {
            transform: scale(1.03) translateY(-2px);
            box-shadow: 0 12px 28px rgba(5, 150, 105, 0.35);
        }

        .variant-pill i {
            font-size: 1.125rem;
            color: white;
            margin-right: 0.875rem;
            opacity: 0.95;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .variant-pill-content {
            display: flex;
            flex-direction: column;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        /* Custom scrollbar for evidence lists */
.custom-scrollbar::-webkit-scrollbar {
    width: 4px;
}

.custom-scrollbar::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 20px;
}

.custom-scrollbar::-webkit-scrollbar-thumb {
    background: #6d28d9;
    border-radius: 20px;
    opacity: 0.5;
}

.custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: #5b21b6;
}

        .variant-pill-primary {
            font-weight: 700;
            font-size: 1.35rem;
            letter-spacing: -0.01em;
            line-height: 1.2;
        }

        .variant-pill-secondary {
            font-size: 0.75rem;
            opacity: 0.95;
            font-weight: 500;
        }

        /* ========== DATA POINT â€” ULTIMATE ========== */
        .data-point {
            position: relative;
            padding: var(--space-4);
            background: white;
            border: 1px solid #edf2f7;
            border-radius: var(--radius);
            transition: var(--transition-base);
            box-shadow: var(--shadow-xs);
        }

        .data-point:hover {
            border-color: var(--color-accent);
            background: #fafcfc;
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .data-point.missing {
            background: linear-gradient(145deg, #fffbeb, #fef3c7);
            border-color: #fde68a;
        }

        .data-point.missing:hover {
            border-color: var(--color-warning);
            background: #fef9e7;
        }

        .data-label {
            font-size: var(--text-2xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            color: #6b7280;
            margin-bottom: var(--space-2);
            display: flex;
            align-items: center;
            gap: var(--space-1);
        }

        .data-value {
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            font-weight: 500;
            color: #111827;
            word-break: break-word;
            line-height: 1.5;
        }

        /* ANNOTATION TRIGGER â€” ALWAYS VISIBLE, BEAUTIFUL */
        .annotation-trigger {
            position: absolute;
            top: var(--space-2);
            right: var(--space-2);
            width: 32px;
            height: 32px;
            border-radius: var(--radius);
            background: white;
            border: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 0.875rem;
            z-index: 15;
            opacity: 1;
            box-shadow: var(--shadow-xs);
        }

        .annotation-trigger:hover {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(14,124,123,0.3);
        }

        .data-point.missing .annotation-trigger {
            background: #ffedd5;
            color: var(--color-warning);
            border-color: #fed7aa;
        }

        .data-point.missing .annotation-trigger:hover {
            background: var(--color-warning);
            color: white;
            border-color: var(--color-warning);
        }

        /* ========== BADGES â€” SCIENTIFIC, VIBRANT ========== */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
            padding: 0.25rem 0.75rem;
            border-radius: var(--radius-full);
            font-size: var(--text-2xs);
            font-weight: 700;
            line-height: 1;
            letter-spacing: 0.03em;
            text-transform: uppercase;
            border: 1px solid;
            backdrop-filter: blur(2px);
        }

        .badge-class-i {
            background: var(--color-class-i-light);
            color: var(--color-class-i-dark);
            border-color: #fecaca;
        }

        .badge-class-ii {
            background: var(--color-class-ii-light);
            color: var(--color-class-ii-dark);
            border-color: #fed7aa;
        }

        .badge-class-iii {
            background: var(--color-class-iii-light);
            color: var(--color-class-iii-dark);
            border-color: #bbf7d0;
        }

        .badge-class-iv {
            background: var(--color-class-iv-light);
            color: var(--color-class-iv-dark);
            border-color: #bfdbfe;
        }

        .badge-class-v {
            background: var(--color-class-v-light);
            color: var(--color-class-v-dark);
            border-color: #ddd6fe;
        }

        .badge-exceptional {
            background: linear-gradient(145deg, #fffbeb, #fef3c7);
            color: #92400e;
            border-color: #fbbf24;
            border-width: 2px;
            position: relative;
        }

        .badge-exceptional i {
            color: #d97706;
        }

        /* ========== VARIANT LIST â€” PERFECTED ========== */
        .variant-list {
            max-height: calc(100vh - 450px);
            overflow-y: auto;
            scroll-behavior: smooth;
            scrollbar-width: thin;
            scrollbar-color: var(--color-accent-light) #f1f5f9;
        }

        .variant-list::-webkit-scrollbar {
            width: 5px;
        }

        .variant-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: var(--radius-full);
        }

        .variant-list::-webkit-scrollbar-thumb {
            background: var(--color-accent-light);
            border-radius: var(--radius-full);
        }

        .variant-list::-webkit-scrollbar-thumb:hover {
            background: var(--color-accent);
        }

        .variant-item {
            padding: var(--space-4) var(--space-5);
            border-bottom: 1px solid #f1f5f9;
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
        }

        .variant-item:hover {
            background: #f8fafc;
        }

        .variant-item.selected {
            background: linear-gradient(145deg, #f0fdfa, #e6f7f5);
            border-left: 4px solid var(--color-accent);
        }

        .variant-name {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            color: #0f172a;
            letter-spacing: -0.01em;
            line-height: 1.3;
        }

        .variant-subtitle {
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: #64748b;
            margin-top: var(--space-1);
        }

        .search-highlight {
            background: rgba(14, 124, 123, 0.15);
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 700;
            color: var(--color-accent-dark);
            border-bottom: 2px solid var(--color-accent);
        }

        /* ========== NOMENCLATURE GRID â€” COMPACT, ELEGANT ========== */
        .nomenclature-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: var(--space-4);
            margin-bottom: var(--space-6);
        }

        @media (max-width: 640px) {
            .nomenclature-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ========== VIEW TOGGLE â€” PREMIUM ========== */
        .view-toggle {
            display: flex;
            gap: var(--space-2);
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: var(--radius-lg);
            padding: 0.375rem;
            box-shadow: var(--shadow-xs);
        }

        .view-toggle-btn {
            padding: 0.5rem 1.25rem;
            font-size: var(--text-sm);
            font-weight: 600;
            color: #475569;
            border-radius: var(--radius);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .view-toggle-btn.active {
            background: var(--color-accent);
            color: white;
            box-shadow: 0 2px 8px rgba(14,124,123,0.25);
        }

        .view-toggle-btn:not(.active):hover {
            background: #f8fafc;
            color: #0f172a;
        }

        .view-count {
            background: rgba(255,255,255,0.25);
            padding: 0.125rem 0.5rem;
            border-radius: var(--radius-full);
            font-size: 0.75rem;
            font-weight: 600;
        }

        .view-toggle-btn.active .view-count {
            background: rgba(255,255,255,0.3);
        }

        /* ========== SEARCH â€” ELEVATED ========== */
        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: var(--space-3) var(--space-3) var(--space-3) 2.75rem;
            font-family: var(--font-sans);
            font-size: var(--text-base);
            border: 1.5px solid #e2e8f0;
            border-radius: var(--radius-full);
            background: white;
            transition: var(--transition-base);
            box-shadow: var(--shadow-xs);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 4px rgba(14,124,123,0.1);
        }

        .search-icon {
            position: absolute;
            left: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            font-size: 1rem;
        }

        .search-clear {
            position: absolute;
            right: var(--space-3);
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: var(--space-1);
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-clear:hover {
            background: #f1f5f9;
            color: #475569;
        }

        /* ========== MODAL â€” CINEMATIC ========== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: var(--space-4);
            animation: fadeIn 200ms ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal {
            background: white;
            border-radius: var(--radius-2xl);
            max-width: 650px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            animation: modalRise 400ms cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        @keyframes modalRise {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            padding: var(--space-5) var(--space-6);
            border-bottom: 1px solid #f1f5f9;
            background: #f8fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            backdrop-filter: blur(8px);
            z-index: 10;
        }

        .modal-body {
            padding: var(--space-6);
        }

        .modal-footer {
            padding: var(--space-5) var(--space-6);
            border-top: 1px solid #f1f5f9;
            background: #f8fafc;
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3);
            position: sticky;
            bottom: 0;
            backdrop-filter: blur(8px);
        }

        /* ========== FORM ELEMENTS â€” POLISHED ========== */
        .form-group {
            margin-bottom: var(--space-5);
        }

        .form-label {
            display: block;
            font-size: var(--text-2xs);
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.075em;
            color: #475569;
            margin-bottom: var(--space-2);
        }

        .form-control {
            width: 100%;
            padding: var(--space-3) var(--space-4);
            font-family: var(--font-sans);
            font-size: var(--text-base);
            border: 1.5px solid #e2e8f0;
            border-radius: var(--radius-lg);
            background: white;
            transition: var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 4px rgba(14,124,123,0.1);
        }

        .form-control.mono {
            font-family: var(--font-mono);
        }

        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23475569' stroke-linecap='round' stroke-linewidth='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right var(--space-3) center;
            background-repeat: no-repeat;
            background-size: 1.25rem;
            padding-right: var(--space-10);
        }

        /* ========== BUTTONS â€” ULTRA-RESPONSIVE ========== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            padding: 0.625rem 1.25rem;
            font-size: var(--text-sm);
            font-weight: 600;
            border-radius: var(--radius-lg);
            border: 1.5px solid transparent;
            cursor: pointer;
            transition: var(--transition-bounce);
            min-height: 44px;
            letter-spacing: 0.01em;
            box-shadow: var(--shadow-xs);
        }

        .btn-primary {
            background: linear-gradient(145deg, var(--color-accent), var(--color-accent-dark));
            color: white;
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, var(--color-accent-dark), #0a4e4d);
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(14,124,123,0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: white;
            border-color: #e2e8f0;
            color: #334155;
        }

        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #94a3b8;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: transparent;
            border: 1.5px solid var(--color-accent);
            color: var(--color-accent);
        }

        .btn-outline:hover {
            background: var(--color-accent);
            color: white;
            transform: translateY(-2px);
        }

        .btn-sm {
            padding: 0.375rem 0.875rem;
            font-size: var(--text-xs);
            min-height: 36px;
        }

        .btn-danger {
            background: white;
            border-color: #fee2e2;
            color: #b91c1c;
        }

        .btn-danger:hover {
            background: #fee2e2;
            border-color: #b91c1c;
            color: #991b1b;
        }

        /* ========== MISSING COUNT â€” PROMINENT ========== */
        .missing-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 24px;
            border-radius: var(--radius-full);
            background: linear-gradient(145deg, var(--color-warning), #d97706);
            color: white;
            font-size: 0.75rem;
            font-weight: 700;
            padding: 0 0.5rem;
            box-shadow: 0 2px 6px rgba(180,83,9,0.3);
        }

        /* ========== EVIDENCE CHAIN â€” ELEGANT ========== */
        .evidence-step {
            padding: 0.375rem 1rem;
            background: #f8fafc;
            border-radius: var(--radius-full);
            font-family: var(--font-mono);
            font-size: var(--text-xs);
            color: #334155;
            border: 1px solid #e2e8f0;
            box-shadow: var(--shadow-xs);
            transition: var(--transition-fast);
        }

        .evidence-step:hover {
            background: white;
            border-color: var(--color-accent);
            transform: translateY(-1px);
        }

        .evidence-arrow {
            color: #94a3b8;
            font-size: 0.75rem;
        }

        /* ========== NOTIFICATION â€” TOAST OF EXCELLENCE ========== */
        .notification {
            position: fixed;
            bottom: var(--space-6);
            right: var(--space-6);
            padding: var(--space-4) var(--space-6);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            display: flex;
            align-items: center;
            gap: var(--space-3);
            max-width: 420px;
            animation: slideInRight 300ms cubic-bezier(0.34, 1.56, 0.64, 1);
            border-left: 6px solid;
            z-index: 99999;
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255,255,255,0.5);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .notification.success { border-left-color: var(--color-success); }
        .notification.error { border-left-color: var(--color-error); }
        .notification.warning { border-left-color: var(--color-warning); }
        .notification.info { border-left-color: var(--color-primary); }

        /* ========== UTILITIES â€” COMPREHENSIVE ========== */
        .hidden { display: none !important; }
        .invisible { visibility: hidden !important; }
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; }

        .text-accent { color: var(--color-accent); }
        .bg-accent-light { background: var(--color-accent-light); }
        .bg-accent-lighter { background: var(--color-accent-lighter); }

        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            :root {
                --text-3xl: 1.75rem;
                --text-2xl: 1.5rem;
                --text-xl: 1.25rem;
            }
            
            .variant-pill-primary { font-size: 1.1rem; }
            .variant-pill { padding: 0.5rem 1rem; }
            .view-toggle { flex-wrap: wrap; }
            .modal { margin: var(--space-2); }
        }

        /* ========== ANIMATIONS ========== */
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 0 0 rgba(14,124,123,0.2); }
            50% { box-shadow: 0 0 0 6px rgba(14,124,123,0.1); }
        }

        .animate-pulse-glow {
            animation: pulse-glow 2s infinite;
        }

        @keyframes spin-slow {
            to { transform: rotate(360deg); }
        }

        .animate-spin-slow {
            animation: spin-slow 2s linear infinite;
        }

        /* ========== PRINT STYLES ========== */
        @media print {
            .no-print { display: none !important; }
            .card { break-inside: avoid; border: 1px solid #ddd; }
        }
        /* ========== FIXED VARIANT LIST â€” PERFECT HEIGHT ========== */
.variant-list {
    flex: 1 1 auto;
    overflow-y: auto;
    min-height: 0;
    scrollbar-width: thin;
    scrollbar-color: #b45309 #f1f5f9;
}

.variant-list::-webkit-scrollbar {
    width: 5px;
}

.variant-list::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: var(--radius-full);
}

.variant-list::-webkit-scrollbar-thumb {
    background: #b45309;
    border-radius: var(--radius-full);
    opacity: 0.7;
}

.variant-list::-webkit-scrollbar-thumb:hover {
    background: #9a3412;
}

/* Search focus glow */
.search-input-focused {
    border-color: #b45309 !important;
    box-shadow: 0 0 0 4px rgba(180, 83, 9, 0.15) !important;
}

/* Remove duplicate icons in filter buttons */
.btn i:first-child {
    margin-right: 0.25rem;
}

/* Ensure card body uses flex properly */
.card-body.flex-1 {
    display: flex !important;
    flex-direction: column !important;
    min-height: 0 !important;
}

        /* ========== FIXED VARIANT LIST â€” PERFECT HEIGHT ========== */
        .variant-list {
            flex: 1 1 auto;
            overflow-y: auto;
            min-height: 0;
            scrollbar-width: thin;
            scrollbar-color: #b45309 #f1f5f9;
        }

        .variant-list::-webkit-scrollbar {
            width: 5px;
        }

        .variant-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: var(--radius-full);
        }

        .variant-list::-webkit-scrollbar-thumb {
            background: #b45309;
            border-radius: var(--radius-full);
            opacity: 0.7;
        }

        .variant-list::-webkit-scrollbar-thumb:hover {
            background: #9a3412;
        }

        /* Search focus glow */
        .search-input-focused {
            border-color: #b45309 !important;
            box-shadow: 0 0 0 4px rgba(180, 83, 9, 0.15) !important;
        }

        /* Remove duplicate icons in filter buttons */
        .btn i:first-child {
            margin-right: 0.25rem;
        }

        /* Ensure card body uses flex properly */
        .card-body.flex-1 {
            display: flex !important;
            flex-direction: column !important;
            min-height: 0 !important;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .variant-list {
                max-height: 350px;
            }
        }
                /* ========== BONUS: SMOOTH SCROLL FOR SELECTED VARIANTS ========== */
        .variant-item.selected {
            background: linear-gradient(145deg, #f0fdfa, #e6f7f5);
            border-left: 4px solid var(--color-accent);
            scroll-margin: 8px; /* Adds padding when scrolled to */
            animation: highlight-pulse 1.5s ease;
        }

        @keyframes highlight-pulse {
            0%, 100% { 
                background: linear-gradient(145deg, #f0fdfa, #e6f7f5); 
                box-shadow: inset 0 0 0 0 rgba(14,124,123,0.1);
            }
            50% { 
                background: linear-gradient(145deg, #ffffff, #f0fdfa);
                box-shadow: inset 0 0 0 2px rgba(14,124,123,0.2);
            }
        }

        /* Smooth scrolling for the entire list */
        .variant-list {
            scroll-behavior: smooth;
        }
    </style>
    
</head>
<body>
    <!-- ===================================================================
         HEADER â€” ULTIMATE EDITION
         =================================================================== -->
    <header class="bg-white/90 border-b border-gray-200/80 sticky top-0 z-50 backdrop-blur-xl" style="background: rgba(255,255,255,0.8);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-20">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-[#0a2e5a] to-[#1a4a7a] flex items-center justify-center shadow-lg shadow-[#0a2e5a]/20">
                        <i class="fas fa-dna text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="heading-2 text-[#0a2e5a] mb-0 leading-none tracking-tight">Î” Helix</h1>
                        <p class="caption text-gray-600 mb-0 flex items-center gap-1">
                            <i class="fas fa-microscope text-[0.65rem]"></i>
                            CFTR Clinical
                        </p>
                    </div>
                    <div class="hidden lg:flex items-center gap-1 ml-6 px-4 py-1.5 bg-gray-100/80 rounded-full">
                        <i class="fas fa-shield-alt text-[#0e7c7b] text-xs"></i>
                        <span class="text-xs font-semibold text-gray-700">HIPAA â€¢ GCP â€¢ ISO 27001</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="relative group">
                        <button onclick="showDashboard()" class="btn btn-secondary hidden md:flex">
                            <i class="fas fa-chart-pie"></i>
                            <span>Analytics</span>
                        </button>
                        <span class="absolute -top-2 -right-2 w-2 h-2 bg-[#0e7c7b] rounded-full animate-pulse"></span>
                    </div>
                    <button onclick="exportReport()" class="btn btn-secondary hidden md:flex">
                        <i class="fas fa-download"></i>
                        <span>Export</span>
                    </button>
                    <button onclick="showImportModal()" class="btn btn-primary shadow-lg shadow-[#0e7c7b]/20">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span class="hidden sm:inline">Import</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ===================================================================
         MAIN CONTENT â€” ULTIMATE
         =================================================================== -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- ========== STATS GRID â€” LIVE, RICH ========== -->
        <div class="grid grid-cols-2 lg:grid-cols-6 gap-4 mb-8">
            <div class="card col-span-2 lg:col-span-1">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="caption mb-1 flex items-center gap-1">
                                <i class="fas fa-database"></i>
                                Total Variants
                            </p>
                            <p class="heading-1 text-[#0a2e5a] mb-0" id="statTotal">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#e9f0f9] flex items-center justify-center">
                            <i class="fas fa-dna text-[#0a2e5a]"></i>
                        </div>
                    </div>
                    <div class="text-xs text-gray-500 mt-2 flex items-center gap-1" id="statContext">
                        <i class="fas fa-circle text-[4px] text-[#0e7c7b]"></i> All variants
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        
                        <div>
                            <p class="caption mb-1">Class I</p>
                            <p class="heading-1 text-[#b91c1c] mb-0" id="statClassI">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#fee2e2] flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-[#b91c1c]"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" id="classIPercentage">â€”% of total</p>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="caption mb-1">Class II</p>
                            <p class="heading-1 text-[#b45309] mb-0" id="statClassII">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#ffedd5] flex items-center justify-center">
                            <i class="fas fa-flask text-[#b45309]"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="caption mb-1">Class III</p>
                            <p class="heading-1 text-[#0f766e] mb-0" id="statClassIII">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#ccfbf1] flex items-center justify-center">
                            <i class="fas fa-bolt text-[#0f766e]"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="caption mb-1">Class IV/V</p>
                            <p class="heading-1 text-[#1e40af] mb-0" id="statClassIVV">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#dbeafe] flex items-center justify-center">
                            <i class="fas fa-chart-line text-[#1e40af]"></i>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card col-span-2 lg:col-span-1 bg-gradient-to-br from-[#f0fdfa] to-white border-[#0e7c7b]/20">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="caption mb-1 text-[#0e7c7b]">
                                <i class="fas fa-bolt"></i>
                                Exceptional
                            </p>
                            <p class="heading-1 text-[#b45309] mb-0" id="statExceptional">â€”</p>
                        </div>
                        <div class="w-10 h-10 rounded-xl bg-[#ffedd5] flex items-center justify-center">
                            <i class="fas fa-star text-[#b45309]"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-1" id="exceptionalPercentage">â€”% of Class I</p>
                </div>
            </div>
        </div>

        <!-- ========== VIEW TOGGLE â€” COMPLETE ========== -->
        <div class="card mb-8">
            <div class="card-body">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl bg-[#0e7c7b]/10 flex items-center justify-center">
                            <i class="fas fa-sliders-h text-[#0e7c7b]"></i>
                        </div>
                        <div>
                            <p class="caption mb-0.5">CURRENT VIEW</p>
                            <p class="heading-3 text-gray-900 mb-0" id="currentModeText">All Variants</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 px-4 py-2.5 bg-gray-50/80 rounded-xl border border-gray-200">
    <i class="fas fa-database text-gray-500"></i>
    <span class="text-sm font-semibold text-gray-800">
        <span id="viewTotal">â€”</span> total variants   <!-- âœ… CHANGED TO viewTotal -->
    </span>
    <span class="w-px h-6 bg-gray-300"></span>
    <span class="text-sm font-medium text-gray-600">
        <span id="completeCount">â€”</span> complete
    </span>
</div>

                </div>
                
                <div class="view-toggle">
                    <button onclick="setDataView('all')" class="view-toggle-btn active" id="allViewBtn">
                        <i class="fas fa-database"></i>
                        All Variants
                        <span class="view-count" id="allCount">â€”</span>
                    </button>
                    <button onclick="setDataView('complete')" class="view-toggle-btn" id="completeViewBtn">
                        <i class="fas fa-check-circle"></i>
                        Complete Clinical
                        <span class="view-count" id="completeCountBtn">â€”</span>
                    </button>
                    <button onclick="setDataView('clinical')" class="view-toggle-btn" id="clinicalViewBtn">
                        <i class="fas fa-clipboard-check"></i>
                        Clinical Data
                        <span class="view-count" id="clinicalCountBtn">â€”</span>
                    </button>
                    <button onclick="setDataView('exceptional')" class="view-toggle-btn" id="exceptionalViewBtn">
                        <i class="fas fa-bolt"></i>
                        Exceptional
                        <span class="view-count" id="exceptionalCount">â€”</span>
                    </button>
                    <button onclick="setDataView('responsive')" class="view-toggle-btn" id="responsiveViewBtn">
                        <i class="fas fa-check"></i>
                        ETI Responsive
                        <span class="view-count" id="responsiveCount">â€”</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- ========== MAIN GRID â€” ULTIMATE ========== -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
<!-- LEFT COLUMN â€” VARIANT EXPLORER DELUXE â€” FIXED HEIGHT -->
<div class="lg:col-span-3">
    <div class="card h-full flex flex-col" style="min-height: 600px;">
        <div class="card-header bg-gradient-to-r from-[#f9fafb] to-white">
            <i class="fas fa-list-ul text-[#0a2e5a]"></i>
            <span>Variant Explorer</span>
            <span class="ml-auto text-xs bg-gray-200 px-2 py-1 rounded-full" id="variantCountHeader">â€”</span>
        </div>
        
        <div class="card-body flex-1" style="display: flex; flex-direction: column; min-height: 0; padding: var(--space-4);">
            
            <!-- SEARCH â€” IMPROVED VISIBILITY -->
            <div class="search-wrapper" style="flex-shrink: 0; margin-bottom: 1rem;">
                <div style="position: relative;">
                    <i class="fas fa-search" style="position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #b45309; font-size: 1rem; z-index: 5;"></i>
                    <input 
                        type="text" 
                        id="searchInput"
                        style="width: 100%; padding: 0.875rem 1rem 0.875rem 2.75rem; font-family: var(--font-sans); font-size: 1rem; border: 2px solid #e2e8f0; border-radius: var(--radius-full); background: white; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.02);"
                        placeholder="ðŸ” Search by name, cDNA, protein, class..."
                        autocomplete="off"
                        onfocus="this.style.borderColor='#b45309'; this.style.boxShadow='0 0 0 4px rgba(180,83,9,0.1)';"
                        onblur="this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.02)';"
                    >
                    <button class="search-clear hidden" id="searchClear" style="position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: #b45309; cursor: pointer; padding: 0.25rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-times-circle" style="font-size: 1.25rem;"></i>
                    </button>
                </div>
                <!-- Subtle glow hint -->
                <div style="font-size: 0.7rem; color: #b45309; margin-top: 0.25rem; margin-left: 0.75rem; opacity: 0.8;">
                    <i class="fas fa-lightbulb mr-1"></i> Try "G542X", "class I", "exceptional"
                </div>
            </div>
            
            <!-- Quick Filters â€” PREMIUM -->
            <div class="flex gap-2 mb-4" style="flex-shrink: 0;">
                <button onclick="filterVariants('all')" 
                        id="filterAll"
                        class="flex-1 px-3 py-2.5 text-sm font-semibold rounded-xl border-2 transition-all"
                        style="border-color: #0e7c7b; color: #0e7c7b; background: rgba(14,124,123,0.05);">
                    <i class="fas fa-list-ul mr-1"></i>All
                </button>
                <button onclick="filterVariants('missing')" 
                        id="filterMissing"
                        class="flex-1 px-3 py-2.5 text-sm font-semibold rounded-xl border-2 border-gray-200 hover:border-[#b45309] hover:text-[#b45309] transition-all">
                    <i class="fas fa-exclamation-triangle mr-1"></i>Missing
                </button>
            </div>
            
            <!-- List Metadata â€” RICH -->
            <div class="flex items-center justify-between text-xs bg-gray-50/80 p-3 rounded-xl border border-gray-200 mb-3" style="flex-shrink: 0;">
                <span class="text-gray-700 font-medium flex items-center gap-1.5">
                    <i class="fas fa-dna text-[#0e7c7b]"></i>
                    <span id="variantCount" class="font-bold text-gray-900">â€”</span> variants
                </span>
                <span id="viewBadge" class="px-3 py-1.5 bg-[#0e7c7b] text-white rounded-full text-xs font-bold shadow-sm">
                    All
                </span>
            </div>
            
            <!-- VARIANT LIST â€” TAKES ALL REMAINING SPACE -->
            <div class="variant-list" id="variantList" style="flex: 1 1 auto; overflow-y: auto; min-height: 0; scrollbar-width: thin; scrollbar-color: #b45309 #f1f5f9; margin: 0 0 0.5rem 0; padding-right: 0.25rem;">
                <!-- Dynamically rendered -->
            </div>
            
            <!-- Pagination â€” ELEGANT â€” NOW INSIDE CARD-BODY -->
            <div class="border-t border-gray-200 px-4 py-3 flex justify-between items-center bg-gray-50/80 rounded-b-lg" id="paginationControls" style="display: none; flex-shrink: 0; margin-top: 0.25rem;">
                <button onclick="previousPage()" class="btn btn-secondary btn-sm" id="prevBtn" style="padding: 0.375rem 1rem; font-size: 0.75rem;">
                    <i class="fas fa-chevron-left mr-1"></i> Prev
                </button>
                <span class="text-xs font-medium text-gray-700">
                    Page <span id="currentPage" class="font-bold text-[#0e7c7b]">1</span> / <span id="totalPages" class="font-bold">1</span>
                </span>
                <button onclick="nextPage()" class="btn btn-secondary btn-sm" id="nextBtn" style="padding: 0.375rem 1rem; font-size: 0.75rem;">
                    Next <i class="fas fa-chevron-right ml-1"></i>
                </button>
            </div>
            
        </div> <!-- end card-body -->
    </div>
</div>   

            <!-- RIGHT COLUMN â€” VARIANT DETAIL ULTIMATE -->
            <div class="lg:col-span-9">
                <div id="variantDetails">
                    <!-- Empty State â€” BEAUTIFUL -->
                    <div id="emptyState" class="card py-16">
                        <div class="text-center max-w-lg mx-auto">
                            <div class="w-24 h-24 rounded-3xl bg-gradient-to-br from-[#0e7c7b]/10 to-[#0e7c7b]/5 mx-auto mb-6 flex items-center justify-center">
                                <i class="fas fa-dna text-5xl text-[#0e7c7b]/40"></i>
                            </div>
                            <h2 class="heading-2 text-gray-900 mb-3">No Variant Selected</h2>
                            <p class="text-gray-600 mb-8 text-lg">Select a variant from the explorer to view comprehensive clinical intelligence, annotations, and therapeutic predictions.</p>
                            <div class="flex flex-wrap justify-center gap-3">
                                <button onclick="quickSearch('G542X')" class="btn btn-outline shadow-sm">
                                    <span class="font-mono font-semibold">G542X</span>
                                </button>
                                <button onclick="quickSearch('F508del')" class="btn btn-outline shadow-sm">
                                    <span class="font-mono font-semibold">F508del</span>
                                </button>
                                <button onclick="quickSearch('W1282X')" class="btn btn-outline shadow-sm">
                                    <span class="font-mono font-semibold">W1282X</span>
                                </button>
                                <button onclick="quickSearch('G551D')" class="btn btn-outline shadow-sm">
                                    <span class="font-mono font-semibold">G551D</span>
                                </button>
                            </div>
                            <p class="text-xs text-gray-400 mt-8">
                                <i class="fas fa-shield-alt mr-1"></i>
                                Powered by Î” Helix MAP
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- ===================================================================
         IMPORT MODAL â€” ULTIMATE
         =================================================================== -->
    <div id="importModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="heading-3 text-gray-900 flex items-center gap-2">
                        <i class="fas fa-cloud-upload-alt text-[#0e7c7b]"></i>
                        Import Clinical Data
                    </h2>
                    <p class="caption mt-1 ml-1">Add new variants or update existing records</p>
                </div>
                <button onclick="closeImportModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <!-- Tabs â€” PREMIUM -->
                <div class="tabs border-b border-gray-200 pb-3 mb-6 flex gap-2">
                    <button id="jsonTabBtn" class="tab active" onclick="switchImportTab('json')">
                        <i class="fas fa-code"></i> JSON Import
                    </button>
                    <button id="formTabBtn" class="tab" onclick="switchImportTab('form')">
                        <i class="fas fa-edit"></i> Manual Entry
                    </button>
                    <button id="bulkTabBtn" class="tab" onclick="switchImportTab('bulk')">
                        <i class="fas fa-layer-group"></i> Bulk Import
                    </button>
                </div>
                
                <!-- JSON Import Panel â€” ENHANCED -->
                <div id="jsonImportPanel">
                    <div class="bg-gradient-to-r from-[#f0fdfa] to-white rounded-xl p-5 border border-[#0e7c7b]/20 mb-6">
                        <p class="caption mb-3 flex items-center gap-2 text-[#0e7c7b]">
                            <i class="fas fa-info-circle"></i>
                            Expected JSON Format
                        </p>
                        <pre class="mono text-xs bg-white p-4 rounded-xl border border-gray-200 overflow-x-auto shadow-sm">
{
  "variant_legacy_name": "G542X",
  "variant_protein_name": "p.Gly542X",
  "variant_cDNA_name": "c.1624G>T",
  "variant_final_determination": "CF-causing",
  "cftr_class": "I",
  "eti_prediction": "responsive"
}</pre>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label flex items-center gap-1">
                            <i class="fas fa-file-code"></i>
                            JSON Data
                        </label>
                        <textarea id="jsonInput" 
                                  class="form-control font-mono text-sm"
                                  rows="8"
                                  placeholder='Paste your JSON here...'
                                  spellcheck="false"></textarea>
                    </div>
                    
                    <div id="importResults" class="space-y-3"></div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="clearImportForm()" class="btn btn-secondary">Clear</button>
                        <button onclick="validateImport()" class="btn btn-secondary">Validate</button>
                        <button onclick="executeJsonImport()" class="btn btn-primary" id="executeImportBtn" disabled>
                            <i class="fas fa-cloud-upload-alt"></i> Import Data
                        </button>
                    </div>
                </div>
                
                <!-- Manual Entry Panel â€” COMPREHENSIVE -->
                <div id="formImportPanel" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="form-group">
                            <label class="form-label">Legacy Name *</label>
                            <input type="text" id="formLegacyName" class="form-control font-mono" placeholder="e.g., G542X">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Protein Name *</label>
                            <input type="text" id="formProteinName" class="form-control font-mono" placeholder="e.g., p.Gly542X">
                        </div>
                        <div class="form-group">
                            <label class="form-label">cDNA Name *</label>
                            <input type="text" id="formCdnaName" class="form-control font-mono" placeholder="e.g., c.1624G>T">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Determination *</label>
                            <select id="formDetermination" class="form-control">
                                <option value="">Select determination</option>
                                <option value="CF-causing">CF-causing</option>
                                <option value="Probably responsive to ETI">Probably responsive to ETI</option>
                                <option value="Variant of unknown significance">VUS</option>
                                <option value="Likely CF-causing">Likely CF-causing</option>
                                <option value="Non CF-causing">Non CF-causing</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50/80 rounded-xl p-5 border border-gray-200 mt-4">
                        <p class="caption mb-4 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-[#0e7c7b]"></i> Optional Clinical Data
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="form-label">CFTR Class</label>
                                <select id="formClass" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="I">Class I</option>
                                    <option value="II">Class II</option>
                                    <option value="III">Class III</option>
                                    <option value="IV">Class IV</option>
                                    <option value="V">Class V</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Class Subtype</label>
                                <select id="formClassSubtype" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="standard">Standard</option>
                                    <option value="exceptional">Exceptional</option>
                                    <option value="true">True Class I</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Confidence</label>
                                <select id="formConfidence" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="High">High</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Low">Low</option>
                                    <option value="Confirmed">Confirmed</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ETI Response</label>
                                <select id="formEtiResponse" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="responsive">Responsive</option>
                                    <option value="non_responsive">Non-responsive</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Evidence Level</label>
                                <select id="formEvidenceLevel" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="High">High</option>
                                    <option value="Moderate">Moderate</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">Recommendation</label>
                                <input type="text" id="formRecommendation" class="form-control" placeholder="e.g., Consider ETI">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="clearManualForm()" class="btn btn-secondary">Clear Form</button>
                        <button onclick="submitManualForm()" class="btn btn-primary">Save Variant</button>
                    </div>
                </div>
                
                <!-- Bulk Import Panel â€” NEXT-GEN -->
                <div id="bulkImportPanel" class="hidden">
                    <div class="bg-gradient-to-r from-[#f0fdfa] to-white rounded-xl p-5 border border-[#0e7c7b]/20 mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-xl bg-[#0e7c7b]/10 flex items-center justify-center">
                                <i class="fas fa-file-csv text-[#0e7c7b]"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-gray-900">Bulk CSV Import</p>
                                <p class="text-xs text-gray-600">Upload multiple variants at once</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-[#0e7c7b] transition-colors cursor-pointer" id="dropZone">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                        <p class="text-gray-700 font-medium">Drag & drop CSV file here</p>
                        <p class="text-xs text-gray-500 mt-1">or click to browse</p>
                        <input type="file" id="csvFileInput" class="hidden" accept=".csv">
                    </div>
                    
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="downloadTemplate()" class="btn btn-secondary">
                            <i class="fas fa-download"></i> Template
                        </button>
                        <button onclick="processBulkImport()" class="btn btn-primary">
                            <i class="fas fa-cloud-upload-alt"></i> Import CSV
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <span class="text-xs text-gray-500 flex-1 flex items-center gap-1">
                    <i class="fas fa-shield-alt text-[#0e7c7b]"></i>
                    All data validated against ACMG/CFTR2 standards
                </span>
                <button onclick="closeImportModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- ===================================================================
         ANNOTATION MODAL â€” ULTIMATE
         =================================================================== -->
    <div id="annotationModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 520px;">
            <div class="modal-header">
                <div>
                    <h3 class="heading-3 text-gray-900 flex items-center gap-2" id="annotationTitle">
                        <i class="fas fa-pencil-alt text-[#0e7c7b]"></i>
                        Annotate Data
                    </h3>
                    <p class="caption mt-1 ml-1" id="annotationField"></p>
                </div>
                <button onclick="closeAnnotationModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" id="annotationContent">
                <!-- Dynamic content -->
            </div>
            <div class="modal-footer">
                <button onclick="closeAnnotationModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveAnnotation()" class="btn btn-primary">Save Annotation</button>
            </div>
        </div>
    </div>

    <!-- ===================================================================
         DASHBOARD MODAL â€” ULTIMATE
         =================================================================== -->
    <div id="dashboardModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 900px;">
            <div class="modal-header">
                <h3 class="heading-3 text-gray-900 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-[#0e7c7b]"></i>
                    Î” Helix Analytics â€” Clinical Intelligence Dashboard
                </h3>
                <button onclick="closeDashboard()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="card-body">
                            <p class="caption mb-3 flex items-center gap-1">
                                <i class="fas fa-dna"></i>
                                CFTR Class Distribution
                            </p>
                            <canvas id="classChart" height="220"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <p class="caption mb-3 flex items-center gap-1">
                                <i class="fas fa-prescription-bottle-alt"></i>
                                ETI Response Prediction
                            </p>
                            <canvas id="responseChart" height="220"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                    <div class="card">
                        <div class="card-body">
                            <p class="caption mb-3">Data Completeness</p>
                            <canvas id="completionChart" height="180"></canvas>
                        </div>
                    </div>
                    <div class="card bg-gradient-to-br from-[#f0fdfa] to-white">
                        <div class="card-body">
                            <p class="caption mb-3 text-[#0e7c7b]">Exceptional Cases</p>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-4xl font-bold text-[#b45309]" id="dashboardExceptional">â€”</p>
                                    <p class="text-sm text-gray-600 mt-1">Class I responsive to ETI</p>
                                </div>
                                <div class="w-16 h-16 rounded-full bg-[#ffedd5] flex items-center justify-center">
                                    <i class="fas fa-star text-2xl text-[#b45309]"></i>
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-gray-200">
                                <p class="text-xs text-gray-500">
                                    <span id="exceptionalPercentile">â€”</span>% of Class I variants show exceptional response
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="exportFullReport()" class="btn btn-primary">
                    <i class="fas fa-file-csv"></i> Export Full Report
                </button>
                <button onclick="refreshDashboardStats()" class="btn btn-secondary">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- ===================================================================
         DELETE CONFIRMATION MODAL â€” ULTIMATE
         =================================================================== -->
    <div id="deleteModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="heading-3 text-gray-900 flex items-center gap-2 text-[#b91c1c]">
                    <i class="fas fa-exclamation-triangle"></i>
                    Delete Variant
                </h3>
                <button onclick="closeDeleteModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="bg-[#fee2e2] rounded-xl p-5 border border-[#b91c1c]/20">
                    <p class="text-sm font-medium text-[#b91c1c] mb-2">Are you absolutely sure?</p>
                    <p class="text-sm text-gray-700">
                        This will permanently delete <span id="deleteVariantName" class="font-mono font-bold"></span> 
                        and all associated clinical data. This action cannot be undone.
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeDeleteModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="confirmDeleteVariant()" class="btn" style="background: #b91c1c; color: white;">
                    <i class="fas fa-trash-alt"></i> Delete Permanently
                </button>
            </div>
        </div>
    </div>
 <!-- ========== ðŸ‘‡ INSERT VALIDATION MODAL HERE ========== -->
    <!-- ===================================================================
         VALIDATION MODAL â€” SIMPLE & CLEAN
         =================================================================== -->
    <div id="validationModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-header">
                <h3 class="heading-3 text-gray-900 flex items-center gap-2 text-[#0e7c7b]">
                    <i class="fas fa-check-circle"></i>
                    Validate Variant
                </h3>
                <button onclick="closeValidationModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="bg-[#f0fdfa] rounded-xl p-5 mb-4 border border-[#0e7c7b]/20">
                    <p class="text-sm text-gray-700">
                        Add your validation to <span id="validateVariantName" class="font-mono font-bold text-[#0e7c7b]"></span>
                    </p>
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-user-md text-[#0e7c7b]"></i>
                        Your Name *
                    </label>
                    <input type="text" id="clinicianName" class="form-control" placeholder="e.g., Dr. Sarah Chen">
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-stethoscope text-[#0e7c7b]"></i>
                        Your Role *
                    </label>
                    <div class="flex gap-2 relative">
                        <input type="text" 
                               id="clinicianRoleInput" 
                               class="form-control flex-1" 
                               placeholder="e.g., Pulmonologist, Geneticist..."
                               list="existingRoles"
                               autocomplete="off">
                        <button type="button" 
                                onclick="showExistingRoles()"
                                class="btn btn-secondary px-3"
                                title="View existing roles">
                            <i class="fas fa-chevron-down"></i>
                        </button>
                    </div>
                    <datalist id="existingRoles"></datalist>
                    <div id="roleSuggestions" class="absolute hidden" style="z-index: 1000;"></div>
                </div>
                
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-pencil-alt text-[#0e7c7b]"></i>
                        Notes (optional)
                    </label>
                    <textarea id="validationNotes" class="form-control" rows="2" placeholder="Any comments..."></textarea>
                </div>
                
                <div id="validationMessage" class="text-sm mt-2"></div>
            </div>
            <div class="modal-footer">
                <button onclick="closeValidationModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="submitValidation()" class="btn btn-primary" id="submitValidationBtn">
                    <i class="fas fa-check-circle mr-1"></i> Validate
                </button>
            </div>
        </div>
    </div>
        <!-- ===================================================================
         ALL EVIDENCE MODAL - SCROLLABLE POPUP
         =================================================================== -->
    <div id="allEvidenceModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="heading-3 text-gray-900 flex items-center gap-2">
                    <i class="fas fa-link text-[#6d28d9]"></i>
                    All Evidence Sources
                </h3>
                <button onclick="closeAllEvidenceModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body max-h-[60vh] overflow-y-auto custom-scrollbar" id="allEvidenceList">
                <!-- Dynamically populated -->
                <div class="text-center py-10">
                    <i class="fas fa-spinner fa-spin text-[#6d28d9] text-2xl"></i>
                    <p class="text-sm text-gray-500 mt-2">Loading evidence...</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button onclick="closeAllEvidenceModal()" class="btn btn-secondary">Close</button>
                <button onclick="showEvidenceModal(currentVariantName, currentVariantId)" class="btn btn-primary bg-[#6d28d9] hover:bg-[#5b21b6]">
                    <i class="fas fa-plus mr-1"></i> Add New Link
                </button>
            </div>
        </div>
    </div>
        <!-- ===================================================================
         ADD EVIDENCE MODAL
         =================================================================== -->
    <div id="addEvidenceModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 550px;">
            <div class="modal-header">
                <h3 class="heading-3 text-gray-900 flex items-center gap-2">
                    <i class="fas fa-plus-circle text-[#6d28d9]"></i>
                    Add Evidence Link
                </h3>
                <button onclick="closeAddEvidenceModal()" class="w-9 h-9 rounded-xl hover:bg-gray-200 transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="bg-[#f5f0ff] rounded-xl p-4 mb-6 border border-[#6d28d9]/20">
                    <p class="text-sm text-gray-700">
                        Adding evidence to <span id="evidenceVariantName" class="font-mono font-bold text-[#6d28d9]"></span>
                    </p>
                </div>
                
                <!-- Source Type Selection -->
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-tag text-[#6d28d9]"></i>
                        Source Type *
                    </label>
                    <div class="grid grid-cols-4 gap-2">
                        <button type="button" onclick="selectEvidenceType('pubmed')" id="type-pubmed" class="type-btn px-3 py-2 text-sm rounded-lg border-2 border-gray-200 hover:border-[#6d28d9] hover:text-[#6d28d9] transition-all flex flex-col items-center gap-1">
                            <i class="fas fa-book-open"></i>
                            <span>PubMed</span>
                        </button>
                        <button type="button" onclick="selectEvidenceType('cftr2')" id="type-cftr2" class="type-btn px-3 py-2 text-sm rounded-lg border-2 border-gray-200 hover:border-[#6d28d9] hover:text-[#6d28d9] transition-all flex flex-col items-center gap-1">
                            <i class="fas fa-dna"></i>
                            <span>CFTR2</span>
                        </button>
                        <button type="button" onclick="selectEvidenceType('clinvar')" id="type-clinvar" class="type-btn px-3 py-2 text-sm rounded-lg border-2 border-gray-200 hover:border-[#6d28d9] hover:text-[#6d28d9] transition-all flex flex-col items-center gap-1">
                            <i class="fas fa-clinic-medical"></i>
                            <span>ClinVar</span>
                        </button>
                        <button type="button" onclick="selectEvidenceType('other')" id="type-other" class="type-btn px-3 py-2 text-sm rounded-lg border-2 border-gray-200 hover:border-[#6d28d9] hover:text-[#6d28d9] transition-all flex flex-col items-center gap-1">
                            <i class="fas fa-link"></i>
                            <span>Other</span>
                        </button>
                    </div>
                    <input type="hidden" id="evidenceType" value="">
                </div>
                
                <!-- Title -->
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-heading text-[#6d28d9]"></i>
                        Title *
                    </label>
                    <input type="text" id="evidenceTitle" class="form-control" placeholder="e.g., Smith et al. 2023 - CFTR modulator study">
                </div>
                
                <!-- URL -->
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-link text-[#6d28d9]"></i>
                        URL *
                    </label>
                    <input type="url" id="evidenceUrl" class="form-control" placeholder="https://pubmed.ncbi.nlm.nih.gov/12345678/">
                </div>
                
                <!-- Source (Display name) -->
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-database text-[#6d28d9]"></i>
                        Source Name (optional)
                    </label>
                    <input type="text" id="evidenceSource" class="form-control" placeholder="e.g., PubMed, CFTR2, Journal Name">
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label class="form-label flex items-center gap-1">
                        <i class="fas fa-pencil-alt text-[#6d28d9]"></i>
                        Notes (optional)
                    </label>
                    <textarea id="evidenceNotes" class="form-control" rows="2" placeholder="Any additional notes about this evidence..."></textarea>
                </div>
                
                <div id="evidenceMessage" class="text-sm mt-2"></div>
            </div>
            
            <div class="modal-footer">
                <button onclick="closeAddEvidenceModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="saveEvidenceLink()" class="btn btn-primary bg-[#6d28d9] hover:bg-[#5b21b6]" id="saveEvidenceBtn">
                    <i class="fas fa-save mr-1"></i> Save Evidence
                </button>
            </div>
        </div>
    </div>
    <!-- ===================================================================
         NOTIFICATION CONTAINER
         =================================================================== -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-[99999] space-y-3"></div>

    <!-- ===================================================================
         JAVASCRIPT â€” ULTIMATE HYBRID ENGINE
         =================================================================== -->
  <script>
        // ===================================================================
        // Î” HELIX | CFTR CLINICAL INTELLIGENCE SYSTEM
        // ULTIMATE HYBRID EDITION â€” Best of All Worlds + Next-Gen Features
        // Version: 10.1.0-PRODUCTION with Validation System
        // ===================================================================

// ===================================================================
// Î” HELIX | CFTR CLINICAL INTELLIGENCE SYSTEM
// COMPLETE PRODUCTION BUILD v10.1 - WITH VALIDATION SYSTEM
// ===================================================================
// âœ… VALIDATION SYSTEM - Name, Role (free text), Notes
// âœ… DYNAMIC BADGES - Shows validation count automatically
// âœ… ROLE SUGGESTIONS - Learns from existing entries
// âœ… VALIDATION HISTORY - Click to expand, shows all validators
// âœ… STATS - Total, unique validators, unique roles
// ===================================================================

// ========== CONFIGURATION - SINGLE SOURCE OF TRUTH ==========
const CONFIG = {
    SUPABASE: {
        URL: 'https://oxlkisjwfarseyqgeyuw.supabase.co',
        KEY: 'sb_publishable_vKCe5bc1Qr20_LI_awKIYw_CqSFrblh'
    },
    UI: {
        ITEMS_PER_PAGE: 20,
        SEARCH_DELAY: 200,
        NOTIFICATION_DURATION: 4500,
        MIN_SEARCH_CHARS: 2,
        DEBOUNCE_RENDER: 50
    },
    FEATURES: {
        ENABLE_BULK_IMPORT: true,
        ENABLE_DELETE: true,
        ENABLE_EXPORT: true,
        ENABLE_DASHBOARD: true,
        ENABLE_VALIDATION: true
    },
    CLASSES: {
        COLORS: {
            I: '#b91c1c',
            II: '#b45309',
            III: '#0f766e',
            IV: '#1e40af',
            V: '#6d28d9'
        },
        LABELS: {
            I: 'Class I - Nonsense/Frameshift',
            II: 'Class II - Processing',
            III: 'Class III - Gating',
            IV: 'Class IV - Conductance',
            V: 'Class V - Splicing'
        }
    },
    VERSION: '10.1.0-PRODUCTION'
};

// ========== STATE - IMMUTABLE MASTER + MUTABLE VIEW ==========
const STATE = {
    // ---------- MASTER DATA - NEVER FILTERED, NEVER MUTATED DIRECTLY ----------
    variants: [],                    // Complete dataset from Supabase
    variantsById: new Map(),        // O(1) lookup by ID
    variantsByLegacyName: new Map(), // O(1) lookup by name
    
    // ---------- SEARCH INDEX - OPTIMIZED FULL-TEXT ----------
    searchIndex: {
        termMap: null,              // term -> Set(variantIds)
        variantMap: null,           // id -> variant
        stats: {                    // performance metrics
            variantCount: 0,
            termCount: 0,
            buildTime: 0,
            lastBuilt: null
        }
    },
    
    // ---------- MASTER STATISTICS - CALCULATED FROM MASTER DATA ONLY ----------
    masterStats: {
        total: 0,
        complete: 0,
        clinical: 0,
        classI: 0,
        classII: 0,      // âš ï¸ WILL BE 7 - NEVER OVERWRITTEN
        classIII: 0,     // âš ï¸ WILL BE 12 - NEVER OVERWRITTEN
        classIV: 0,
        classV: 0,
        exceptional: 0,
        responsive: 0,
        nonResponsive: 0,
        unknown: 0,
        validated: 0,    // NEW: Count of variants with at least one validation
        lastCalculated: null
    },
    
    // ---------- VALIDATION DATA ----------
    existingRoles: [],               // For role suggestions
    validationCache: new Map(),      // Cache validation histories
    
    // ---------- VIEW STATE - MUTABLE, BASED ON FILTERS/SEARCH ----------
    view: {
        filteredVariants: [],       // Current filtered/sorted list
        selectedVariant: null,      // Currently selected variant
        activeFilter: 'all',        // all | missing
        dataViewMode: 'all',        // all | complete | clinical | exceptional | responsive
        currentPage: 1,
        searchQuery: '',
        renderVersion: 0,           // Increments on each render
        lastUpdate: null
    },
    
    // ---------- UI STATE ----------
    ui: {
        charts: {},                 // Chart.js instances
        notificationQueue: [],      // Pending notifications
        isLoading: false,
        annotationContext: null,    // Current annotation modal context
        deleteContext: null,        // Current delete modal context
        validationContext: null,    // Current validation modal context
        validatedJson: null,        // Validated import JSON
        searchTimeout: null,        // Debounced search timer
        renderTimeout: null         // Debounced render timer
    },
    
    // ---------- SYSTEM ----------
    system: {
        initialized: false,
        initStartTime: null,
        initEndTime: null,
        errorCount: 0,
        lastError: null,
        apiCalls: 0
    }
};

// ===================================================================
// ðŸš€ DATABASE OPERATIONS - SUPABASE CRUD
// ===================================================================

/**
 * Load all variants from Supabase 'variants' table
 * This is the SINGLE SOURCE OF TRUTH for all variant data
 * @returns {Promise<boolean>} Success status
 */
async function loadVariants() {
    const startTime = performance.now();
    STATE.system.initStartTime = new Date();
    STATE.ui.isLoading = true;
    
    try {
        showLoadingState('ðŸ”¬ Initializing Î” Helix Clinical Intelligence...');
        
        // ---------- LOAD ALL VARIANTS WITH PAGINATION ----------
        let allVariants = [];
        let offset = 0;
        const limit = 1000;
        let hasMore = true;
        
        while (hasMore) {
            const response = await fetch(
                `${CONFIG.SUPABASE.URL}/rest/v1/variants?select=*,evidence_links(*)&order=legacy_name.asc&limit=${limit}&offset=${offset}`,
                {
                    headers: {
                        'apikey': CONFIG.SUPABASE.KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    }
                }
            );
            
            STATE.system.apiCalls++;
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            allVariants = [...allVariants, ...data];
            
            hasMore = data.length === limit;
            offset += limit;
        }
        
        // ---------- LOAD MASTER DATA ----------
        STATE.variants = allVariants;
        
        // ---------- BUILD LOOKUP MAPS (O(1) ACCESS) ----------
        STATE.variantsById = new Map(STATE.variants.map(v => [v.id, v]));
        STATE.variantsByLegacyName = new Map(
            STATE.variants.map(v => [v.legacy_name, v])
        );
        
        // ---------- VERIFY CRITICAL VARIANTS ----------
        const criticalChecks = {
            F508del: STATE.variants.some(v => v.legacy_name === 'F508del'),
            G551D: STATE.variants.some(v => v.legacy_name === 'G551D'),
            G542X: STATE.variants.some(v => v.legacy_name === 'G542X'),
            N1303K: STATE.variants.some(v => v.legacy_name === 'N1303K'),
            '1001+11C/T': STATE.variants.some(v => v.legacy_name === '1001+11C/T')
        };
        
        console.log('âœ… CRITICAL VARIANTS:', criticalChecks);
        console.log(`âœ… LOADED ${STATE.variants.length} variants from 'variants' table`);
        
        // ---------- BUILD SEARCH INDEX (FULL-TEXT) ----------
        buildSearchIndex();
        
        // ---------- LOAD EXISTING ROLES FOR VALIDATION ----------
        await loadExistingRoles();
        
        // ---------- CALCULATE MASTER STATISTICS ----------
        calculateMasterStats();
        
        // ---------- INITIALIZE VIEW WITH ALL VARIANTS ----------
        STATE.view.filteredVariants = [...STATE.variants];
        STATE.view.dataViewMode = 'all';
        STATE.view.activeFilter = 'all';
        STATE.view.currentPage = 1;
        
        // ---------- RENDER UI ----------
        renderViewUI();
        renderVariantList();
        
        // ---------- SYSTEM READY ----------
        STATE.system.initialized = true;
        STATE.system.initEndTime = new Date();
        STATE.ui.isLoading = false;
        
        const initTime = (performance.now() - startTime).toFixed(0);
        showNotification(`âœ“ System ready â€¢ ${STATE.variants.length} variants â€¢ ${initTime}ms`, 'success', 3000);
        
        // ---------- PRELOAD CHARTS (DEFERRED) ----------
        if (CONFIG.FEATURES.ENABLE_DASHBOARD) {
            setTimeout(preloadCharts, 500);
        }
        
        return true;
        
    } catch (error) {
        STATE.system.errorCount++;
        STATE.system.lastError = error;
        STATE.ui.isLoading = false;
        
        console.error('âŒ FATAL: Failed to load variants:', error);
        showNotification('âŒ Database connection failed', 'error', 0);
        
        const container = document.getElementById('variantList');
        if (container) {
            container.innerHTML = `
                <div class="p-10 text-center">
                    <div class="w-20 h-20 bg-red-100 rounded-2xl mx-auto mb-5 flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                    </div>
                    <p class="text-gray-800 font-semibold text-lg">Database Connection Failed</p>
                    <p class="text-sm text-gray-500 mt-2">${escapeHTML(error.message)}</p>
                    <button onclick="location.reload()" class="btn btn-primary mt-5">
                        <i class="fas fa-sync-alt mr-2"></i> Retry
                    </button>
                </div>
            `;
        }
        
        return false;
    }
}

// ===================================================================
// ðŸ“Š MASTER STATISTICS - CALCULATED FROM MASTER DATA ONLY
// ===================================================================

function calculateMasterStats() {
    const v = STATE.variants;
    
    STATE.masterStats = {
        total: v.length,
        complete: v.filter(v => v?.data_status === 'complete_clinical').length,
        clinical: v.filter(v => v?.data_status === 'complete_clinical' || v?.data_status === 'partial_clinical').length,
        
        classI: v.filter(v => v?.cftr_class === 'I').length,
        classII: v.filter(v => v?.cftr_class === 'II').length,
        classIII: v.filter(v => v?.cftr_class === 'III').length,
        classIV: v.filter(v => v?.cftr_class === 'IV').length,
        classV: v.filter(v => v?.cftr_class === 'V').length,
        
        exceptional: v.filter(v => v?.class_subtype === 'exceptional').length,
        responsive: v.filter(v => v?.eti_prediction === 'responsive').length,
        nonResponsive: v.filter(v => v?.eti_prediction === 'non_responsive').length,
        unknown: v.filter(v => !v?.eti_prediction || v?.eti_prediction === 'unknown').length,
        
        validated: v.filter(v => v?.validation_count > 0).length, // NEW
        lastCalculated: new Date()
    };
    
    console.log('ðŸ“Š MASTER STATS CALCULATED:', {
        total: STATE.masterStats.total,
        classII: STATE.masterStats.classII,
        classIII: STATE.masterStats.classIII,
        validated: STATE.masterStats.validated
    });
    
    updateMasterStatsUI();
}

function updateMasterStatsUI() {
    const s = STATE.masterStats;
    
    safeSetText('statTotal', s.total.toLocaleString());
    safeSetText('statClassI', s.classI.toLocaleString());
    safeSetText('statClassII', s.classII.toLocaleString());
    safeSetText('statClassIII', s.classIII.toLocaleString());
    safeSetText('statClassIVV', (s.classIV + s.classV).toLocaleString());
    safeSetText('statExceptional', s.exceptional.toLocaleString());
    
    if (s.total > 0) {
        safeSetText('classIPercentage', ((s.classI / s.total) * 100).toFixed(1) + '%');
        safeSetText('exceptionalPercentage', 
            s.classI > 0 ? ((s.exceptional / s.classI) * 100).toFixed(1) + '%' : '0%');
    }
    
    safeSetText('allCount', s.total.toLocaleString());
    safeSetText('completeCount', s.complete.toLocaleString());
    safeSetText('clinicalCount', s.clinical.toLocaleString());
    safeSetText('exceptionalCount', s.exceptional.toLocaleString());
    safeSetText('responsiveCount', s.responsive.toLocaleString());
    safeSetText('completeCountBtn', s.complete.toLocaleString());
    safeSetText('clinicalCountBtn', s.clinical.toLocaleString());
    
    safeSetText('dashboardExceptional', s.exceptional.toLocaleString());
    if (s.classI > 0) {
        safeSetText('exceptionalPercentile', ((s.exceptional / s.classI) * 100).toFixed(1) + '%');
    }
    
    safeSetText('statContext', `All variants â€¢ ${s.total.toLocaleString()} total variants`);
    
    const viewNames = {
        all: 'All Variants',
        complete: 'Complete Clinical',
        clinical: 'Clinical Data', 
        exceptional: 'Exceptional Cases',
        responsive: 'ETI Responsive'
    };
    safeSetText('currentModeText', 
        `${viewNames[STATE.view?.dataViewMode || 'all']} (${s.total.toLocaleString()} total)`);
}

// ===================================================================
// ðŸ” SEARCH ENGINE - OPTIMIZED FULL-TEXT SEARCH
// ===================================================================

function buildSearchIndex() {
    console.time('ðŸ”¨ Search index build');
    
    const termMap = new Map();
    const variantMap = STATE.variantsById;
    
    STATE.variants.forEach(variant => {
        const terms = new Set();
        
        if (variant.legacy_name) {
            const name = variant.legacy_name;
            terms.add(name.toLowerCase());
            terms.add(name.toUpperCase());
            
            const numbers = name.match(/\d+/g);
            if (numbers) numbers.forEach(n => terms.add(n));
            
            if (name.includes('del')) {
                const base = name.replace('del', '');
                const numOnly = base.replace(/[A-Za-z]/g, '');
                terms.add(base);
                terms.add(`del${numOnly}`);
                terms.add(`delta${numOnly}`);
                terms.add(`Î”${numOnly}`);
            }
            
            if (name.includes('X')) {
                const base = name.replace('X', '');
                terms.add(`${base}*`);
                terms.add(name.replace('X', 'Ter'));
            }
            
            if (name.includes('+')) {
                terms.add(name.split('+')[0]);
            }
        }
        
        if (variant.protein_name) {
            const prot = variant.protein_name;
            terms.add(prot.toLowerCase());
            terms.add(prot.replace('p.', ''));
            
            const match = prot.match(/p\.([A-Z][a-z]{2})(\d+)([A-Za-z*X]+)/);
            if (match) {
                const threeToOne = {
                    'Ala':'A','Arg':'R','Asn':'N','Asp':'D','Cys':'C',
                    'Glu':'E','Gln':'Q','Gly':'G','His':'H','Ile':'I',
                    'Leu':'L','Lys':'K','Met':'M','Phe':'F','Pro':'P',
                    'Ser':'S','Thr':'T','Trp':'W','Tyr':'Y','Val':'V',
                    'Ter':'X','*':'X'
                };
                const oneLetter = threeToOne[match[1]] || match[1].charAt(0);
                terms.add(`${oneLetter}${match[2]}${match[3]}`);
                terms.add(match[2]);
            }
        }
        
        if (variant.cdna_name) {
            const cdna = variant.cdna_name;
            terms.add(cdna.toLowerCase());
            terms.add(cdna.replace('c.', ''));
            
            const numbers = cdna.match(/\d+/g);
            if (numbers) numbers.forEach(n => terms.add(n));
        }
        
        if (variant.alt_names) {
            variant.alt_names.split(/[,;/\s]+/).forEach(alt => {
                if (alt?.trim()) terms.add(alt.trim().toLowerCase());
            });
        }
        
        if (variant.cftr_class) {
            terms.add(`class${variant.cftr_class}`);
            terms.add(`class ${variant.cftr_class}`);
            terms.add(variant.cftr_class);
        }
        
        if (variant.eti_prediction) {
            terms.add(variant.eti_prediction);
            if (variant.eti_prediction === 'responsive') {
                terms.add('responder');
                terms.add('works');
                terms.add('responsive to eti');
            } else if (variant.eti_prediction === 'non_responsive') {
                terms.add('nonresponder');
                terms.add('resistant');
                terms.add('non-responsive');
            }
        }
        
        if (variant.class_subtype === 'exceptional') {
            terms.add('exceptional');
            terms.add('exceptional responder');
            terms.add('breakthrough');
        }
        if (variant.class_subtype === 'true') {
            terms.add('true class i');
            terms.add('nonsense');
        }
        
        terms.forEach(term => {
            const key = String(term).toLowerCase().trim();
            if (key && key.length >= CONFIG.UI.MIN_SEARCH_CHARS) {
                if (!termMap.has(key)) {
                    termMap.set(key, new Set());
                }
                termMap.get(key).add(variant.id);
            }
        });
    });
    
    STATE.searchIndex = {
        termMap,
        variantMap,
        stats: {
            variantCount: STATE.variants.length,
            termCount: termMap.size,
            buildTime: performance.now() - (window.performance?.timeOrigin || 0),
            lastBuilt: new Date()
        }
    };
    
    console.timeEnd('ðŸ”¨ Search index build');
    console.log(`ðŸ“Š Index: ${STATE.searchIndex.stats.termCount} terms, ${STATE.searchIndex.stats.variantCount} variants`);
}

function searchVariants(query) {
    if (!query || query.length < CONFIG.UI.MIN_SEARCH_CHARS || !STATE.searchIndex.termMap) {
        return STATE.variants;
    }
    
    const q = query.toLowerCase().trim();
    const matchedIds = new Set();
    const scores = new Map();
    
    const variations = [
        q,
        q.replace(/^p\./, ''),
        q.replace(/^c\./, ''),
        q.replace(/^g\./, ''),
        ...(q.match(/\d+/g) || [])
    ].filter((v, i, a) => v && v.length >= 2 && a.indexOf(v) === i);
    
    variations.forEach(term => {
        if (STATE.searchIndex.termMap.has(term)) {
            const ids = STATE.searchIndex.termMap.get(term);
            ids.forEach(id => {
                matchedIds.add(id);
                const score = term === q ? 100 : /^\d+$/.test(term) ? 50 : 10;
                scores.set(id, (scores.get(id) || 0) + score);
            });
        }
    });
    
    return Array.from(matchedIds)
        .map(id => ({ 
            variant: STATE.searchIndex.variantMap.get(id), 
            score: scores.get(id) || 0 
        }))
        .sort((a, b) => b.score - a.score)
        .map(r => r.variant);
}

// ===================================================================
// ðŸ”„ VIEW MANAGEMENT - FILTER, SORT, PAGINATE
// ===================================================================

function applyFilterChain() {
    let filtered = [...STATE.variants];
    
    if (STATE.view.searchQuery && STATE.view.searchQuery.length >= CONFIG.UI.MIN_SEARCH_CHARS) {
        filtered = searchVariants(STATE.view.searchQuery);
    }
    
    switch (STATE.view.dataViewMode) {
        case 'complete':
            filtered = filtered.filter(v => v?.data_status === 'complete_clinical');
            break;
        case 'clinical':
            filtered = filtered.filter(v => 
                v?.data_status === 'complete_clinical' || v?.data_status === 'partial_clinical'
            );
            break;
        case 'exceptional':
            filtered = filtered.filter(v => v?.class_subtype === 'exceptional');
            break;
        case 'responsive':
            filtered = filtered.filter(v => v?.eti_prediction === 'responsive');
            break;
    }
    
    if (STATE.view.activeFilter === 'missing') {
        filtered = filtered.filter(v => hasMissingData(v));
    }
    
    STATE.view.filteredVariants = filtered;
    STATE.view.currentPage = 1;
    STATE.view.renderVersion++;
    
    renderVariantList();
    updatePagination();
    renderViewUI();
}

function setDataView(mode) {
    if (STATE.view.dataViewMode === mode) return;
    
    STATE.view.dataViewMode = mode;
    STATE.view.currentPage = 1;
    
    ['all', 'complete', 'clinical', 'exceptional', 'responsive'].forEach(m => {
        const btn = document.getElementById(`${m}ViewBtn`);
        if (btn) btn.classList.toggle('active', m === mode);
    });
    
    const viewNames = {
        all: 'All Variants',
        complete: 'Complete Clinical',
        clinical: 'Clinical Data',
        exceptional: 'Exceptional Cases',
        responsive: 'ETI Responsive'
    };
    safeSetText('currentModeText', `${viewNames[mode]} (${STATE.masterStats.total.toLocaleString()} total)`);
    
    applyFilterChain();
}

function filterVariants(filter) {
    STATE.view.activeFilter = filter;
    STATE.view.currentPage = 1;
    
    const allBtn = document.getElementById('filterAll');
    const missingBtn = document.getElementById('filterMissing');
    
    if (allBtn && missingBtn) {
        if (filter === 'all') {
            allBtn.style.borderColor = '#0e7c7b';
            allBtn.style.color = '#0e7c7b';
            allBtn.style.background = 'rgba(14,124,123,0.05)';
            allBtn.style.fontWeight = '600';
            
            missingBtn.style.borderColor = '#e2e8f0';
            missingBtn.style.color = '#374151';
            missingBtn.style.background = 'transparent';
            missingBtn.style.fontWeight = '400';
        } else {
            allBtn.style.borderColor = '#e2e8f0';
            allBtn.style.color = '#374151';
            allBtn.style.background = 'transparent';
            allBtn.style.fontWeight = '400';
            
            missingBtn.style.borderColor = '#b45309';
            missingBtn.style.color = '#b45309';
            missingBtn.style.background = 'rgba(180,83,9,0.05)';
            missingBtn.style.fontWeight = '600';
        }
    }
    
    applyFilterChain();
}

function selectVariant(name) {
    const variant = STATE.variantsByLegacyName.get(name);
    if (variant) {
        STATE.view.selectedVariant = variant;
        renderVariantDetails(variant);
        renderVariantList();
    }
}

function clearSearch() {
    STATE.view.searchQuery = '';
    const input = document.getElementById('searchInput');
    if (input) {
        input.value = '';
        document.getElementById('searchClear')?.classList.add('hidden');
    }
    applyFilterChain();
}

function quickSearch(name) {
    const input = document.getElementById('searchInput');
    if (input) {
        input.value = name;
        STATE.view.searchQuery = name;
        applyFilterChain();
        setTimeout(() => selectVariant(name), 300);
    }
}

// ===================================================================
// ðŸ–¨ï¸ RENDERERS - UI UPDATE FUNCTIONS
// ===================================================================

function renderVariantList() {
    const container = document.getElementById('variantList');
    if (!container) return;
    
    const start = (STATE.view.currentPage - 1) * CONFIG.UI.ITEMS_PER_PAGE;
    const end = start + CONFIG.UI.ITEMS_PER_PAGE;
    const pageVariants = STATE.view.filteredVariants.slice(start, end);
    
    if (pageVariants.length === 0) {
        container.innerHTML = `
            <div class="p-10 text-center">
                <div class="w-20 h-20 bg-gray-100 rounded-2xl mx-auto mb-5 flex items-center justify-center">
                    <i class="fas fa-dna text-3xl text-gray-400"></i>
                </div>
                <p class="text-gray-800 font-semibold text-lg">No variants found</p>
                <p class="text-sm text-gray-500 mt-2">
                    ${STATE.view.searchQuery ? 'Try a different search term' : 'No variants match current filters'}
                </p>
                <button onclick="clearSearch()" class="btn btn-outline mt-5">
                    <i class="fas fa-times mr-2"></i> Clear Search
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = pageVariants.map(v => {
        const isSelected = STATE.view.selectedVariant?.id === v.id;
        const missingCount = countMissingFields(v);
        
        let displayName = escapeHTML(v.legacy_name || '');
        
        if (STATE.view.searchQuery) {
            try {
                const re = new RegExp(`(${escapeRegExp(STATE.view.searchQuery)})`, 'gi');
                displayName = displayName.replace(re, '<span class="search-highlight">$1</span>');
            } catch (e) {}
        }
        
        // âœ… NEW: Validation badge
        const validationBadge = v.validation_count > 0 ? 
            `<span class="text-xs bg-[#0e7c7b] text-white px-2 py-0.5 rounded-full ml-2">
                <i class="fas fa-check-circle mr-0.5"></i>${v.validation_count}
            </span>` : '';
        
        const classBadge = v.cftr_class ? 
            `<span class="badge badge-class-${v.cftr_class.toLowerCase()}">
                <i class="fas fa-dna"></i>Class ${v.cftr_class}
            </span>` : '';
        
        const etiIcon = v.eti_prediction === 'responsive' ? 
            '<span class="text-[#0f766e] text-xs ml-2"><i class="fas fa-check-circle"></i> Responds</span>' :
            v.eti_prediction === 'non_responsive' ? 
            '<span class="text-[#b91c1c] text-xs ml-2"><i class="fas fa-times-circle"></i> Non-responsive</span>' : '';
        
        const subtypeBadge = v.class_subtype === 'exceptional' ? 
            '<span class="text-xs font-bold text-[#b45309] ml-2"><i class="fas fa-bolt"></i> EXCEPTIONAL</span>' :
            v.class_subtype === 'true' ? 
            '<span class="text-xs font-bold text-[#b91c1c] ml-2"><i class="fas fa-exclamation"></i> TRUE CLASS I</span>' : '';
        
        return `
            <div class="variant-item ${isSelected ? 'selected' : ''}" 
                 onclick="selectVariant('${escapeHTML(v.legacy_name)}')">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex-1">
                        <div class="flex items-center flex-wrap gap-2">
                            <h4 class="variant-name">${displayName}${validationBadge}</h4>
                            ${etiIcon}${subtypeBadge}
                        </div>
                        ${v.protein_name ? 
                            `<p class="variant-subtitle">${escapeHTML(v.protein_name)}</p>` : ''}
                    </div>
                    ${classBadge}
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="text-xs text-gray-600 truncate max-w-[180px]">
                        ${escapeHTML(v.final_determination || '')}
                    </span>
                    ${missingCount ? 
                        `<span class="missing-count">${missingCount}</span>` : ''}
                </div>
            </div>
        `;
    }).join('');
    
    safeSetText('variantCount', STATE.view.filteredVariants.length.toLocaleString());
    safeSetText('variantCountHeader', STATE.view.filteredVariants.length.toLocaleString());
}
    

function renderViewUI() {
    const f = STATE.view.filteredVariants;
    const s = STATE.masterStats;
    
    safeSetText('variantCount', f.length.toLocaleString());
    safeSetText('variantCountHeader', f.length.toLocaleString());
    safeSetText('viewTotal', f.length.toLocaleString());
    
    const viewNames = { 
        all: 'All', 
        complete: 'Complete', 
        clinical: 'Clinical', 
        exceptional: 'Exceptional', 
        responsive: 'Responsive' 
    };
    const viewColors = {
        all: 'bg-gray-600',
        complete: 'bg-[#0e7c7b]',
        clinical: 'bg-[#0a2e5a]',
        exceptional: 'bg-[#b45309]',
        responsive: 'bg-[#0f766e]'
    };
    
    const badge = document.getElementById('viewBadge');
    if (badge) {
        badge.textContent = viewNames[STATE.view.dataViewMode] || 'All';
        badge.className = `px-3 py-1.5 rounded-full text-xs font-bold text-white shadow-sm ${viewColors[STATE.view.dataViewMode] || 'bg-gray-600'}`;
    }
    
    const ctxMessages = {
        all: 'All variants',
        complete: 'Complete clinical only',
        clinical: 'Complete + Partial clinical',
        exceptional: 'Exceptional Class I cases',
        responsive: 'ETI responsive variants'
    };
    
    safeSetText('statContext', 
        `${ctxMessages[STATE.view.dataViewMode] || 'All variants'} â€¢ Showing ${f.length.toLocaleString()} of ${s.total.toLocaleString()} total`);
}

function updatePagination() {
    const totalPages = Math.ceil(STATE.view.filteredVariants.length / CONFIG.UI.ITEMS_PER_PAGE);
    const controls = document.getElementById('paginationControls');
    
    if (!controls) return;
    
    if (totalPages > 1) {
        controls.style.display = 'flex';
        safeSetText('currentPage', STATE.view.currentPage);
        safeSetText('totalPages', totalPages);
        
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        
        if (prevBtn) {
            prevBtn.disabled = STATE.view.currentPage === 1;
            prevBtn.style.opacity = STATE.view.currentPage === 1 ? '0.5' : '1';
        }
        if (nextBtn) {
            nextBtn.disabled = STATE.view.currentPage === totalPages;
            nextBtn.style.opacity = STATE.view.currentPage === totalPages ? '0.5' : '1';
        }
    } else {
        controls.style.display = 'none';
    }
}

function previousPage() {
    if (STATE.view.currentPage > 1) {
        STATE.view.currentPage--;
        renderVariantList();
        updatePagination();
    }
}

function nextPage() {
    const totalPages = Math.ceil(STATE.view.filteredVariants.length / CONFIG.UI.ITEMS_PER_PAGE);
    if (STATE.view.currentPage < totalPages) {
        STATE.view.currentPage++;
        renderVariantList();
        updatePagination();
    }
}

// ===================================================================
// âœ… VALIDATION SYSTEM - ENHANCED WITH DYNAMIC ROLES
// ===================================================================

/**
 * Load existing roles for suggestions
 */
async function loadExistingRoles() {
    try {
        // Try to load from validator_roles table if it exists
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/validator_roles?order=usage_count.desc&limit=20`,
            {
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                }
            }
        );
        
        if (response.ok) {
            const roles = await response.json();
            STATE.existingRoles = roles;
            
            // Update datalist
            const datalist = document.getElementById('existingRoles');
            if (datalist && roles.length > 0) {
                datalist.innerHTML = roles.map(r => 
                    `<option value="${escapeHTML(r.role_name)}">${escapeHTML(r.role_name)} (${r.usage_count})</option>`
                ).join('');
            }
        } else {
            // Fallback: load from validation_history directly
            const historyResponse = await fetch(
                `${CONFIG.SUPABASE.URL}/rest/v1/validation_history?select=clinician_role&order=created_at.desc`,
                {
                    headers: {
                        'apikey': CONFIG.SUPABASE.KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                    }
                }
            );
            
            if (historyResponse.ok) {
                const history = await historyResponse.json();
                const roleCounts = new Map();
                history.forEach(h => {
                    if (h.clinician_role) {
                        roleCounts.set(h.clinician_role, (roleCounts.get(h.clinician_role) || 0) + 1);
                    }
                });
                
                STATE.existingRoles = Array.from(roleCounts.entries())
                    .map(([role, count]) => ({ role_name: role, usage_count: count }))
                    .sort((a, b) => b.usage_count - a.usage_count)
                    .slice(0, 20);
                
                const datalist = document.getElementById('existingRoles');
                if (datalist) {
                    datalist.innerHTML = STATE.existingRoles.map(r => 
                        `<option value="${escapeHTML(r.role_name)}">${escapeHTML(r.role_name)} (${r.usage_count})</option>`
                    ).join('');
                }
            }
        }
    } catch (error) {
        console.error('âŒ Failed to load roles:', error);
        // Non-critical error, continue
    }
}

/**
 * Show validation modal
 */
function showValidationModal(variantName, variantId) {
    STATE.ui.validationContext = { variantName, variantId };
    document.getElementById('validateVariantName').textContent = variantName;
    document.getElementById('clinicianName').value = '';
    document.getElementById('clinicianRoleInput').value = '';
    document.getElementById('validationNotes').value = '';
    document.getElementById('validationMessage').innerHTML = '';
    document.getElementById('roleSuggestions').classList.add('hidden');
    document.getElementById('validationModal').classList.remove('hidden');
}

function closeValidationModal() {
    document.getElementById('validationModal').classList.add('hidden');
    document.getElementById('roleSuggestions').classList.add('hidden');
    STATE.ui.validationContext = null;
}

/**
 * Show existing roles in a popup
 */
function showExistingRoles() {
    const suggestionsDiv = document.getElementById('roleSuggestions');
    if (!suggestionsDiv) return;
    
    if (STATE.existingRoles && STATE.existingRoles.length > 0) {
        suggestionsDiv.innerHTML = `
            <div class="bg-white border rounded-xl p-3 shadow-lg absolute z-50 max-h-60 overflow-y-auto" style="width: 300px; margin-top: 5px;">
                <p class="text-xs font-bold text-gray-500 mb-2 flex justify-between">
                    <span>Popular Roles</span>
                    <span class="text-gray-400">count</span>
                </p>
                ${STATE.existingRoles.map(role => `
                    <div onclick="selectRole('${escapeHTML(role.role_name)}')" 
                         class="flex justify-between items-center p-2 hover:bg-gray-50 cursor-pointer rounded">
                        <span class="text-sm">${escapeHTML(role.role_name)}</span>
                        <span class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">${role.usage_count}</span>
                    </div>
                `).join('')}
            </div>
        `;
        suggestionsDiv.classList.remove('hidden');
    } else {
        loadExistingRoles().then(() => {
            if (STATE.existingRoles.length > 0) {
                showExistingRoles();
            }
        });
    }
}

function selectRole(role) {
    document.getElementById('clinicianRoleInput').value = role;
    document.getElementById('roleSuggestions').classList.add('hidden');
}

// Close role suggestions when clicking outside
document.addEventListener('click', function(e) {
    const suggestions = document.getElementById('roleSuggestions');
    const roleBtn = document.querySelector('[onclick="showExistingRoles()"]');
    if (suggestions && !suggestions.contains(e.target) && roleBtn && !roleBtn.contains(e.target)) {
        suggestions.classList.add('hidden');
    }
});

/**
 * Update variant validation stats
 */
async function updateVariantValidationStats(variantId) {
    try {
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/validation_history?` +
            `variant_id=eq.${variantId}&select=clinician_name,clinician_role,created_at&order=created_at.desc`,
            {
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                }
            }
        );
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const validations = await response.json();
        
        if (validations.length === 0) return;
        
        const total = validations.length;
        const uniqueValidators = new Set(validations.map(v => v.clinician_name)).size;
        const uniqueRoles = new Set(validations.map(v => v.clinician_role)).size;
        const latest = validations[0];
        
        // Update variant in database (if validation_count column exists)
        try {
            await fetch(
                `${CONFIG.SUPABASE.URL}/rest/v1/variants?id=eq.${variantId}`,
                {
                    method: 'PATCH',
                    headers: {
                        'apikey': CONFIG.SUPABASE.KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        validation_count: total,
                        last_validated_at: latest.created_at,
                        last_validator_name: latest.clinician_name,
                        last_validator_role: latest.clinician_role
                    })
                }
            ).catch(() => {
                // Columns might not exist yet - that's ok
                console.log('Validation columns not yet added to variants table');
            });
        } catch (e) {
            // Silently fail - database schema update pending
        }
        
        // Update local state
        const variant = STATE.variants.find(v => v.id === variantId);
        if (variant) {
            variant.validation_count = total;
            variant.last_validated_at = latest.created_at;
            variant.last_validator_name = latest.clinician_name;
            variant.last_validator_role = latest.clinician_role;
        }
        
        // Update UI stats if elements exist
        const uniqueSpan = document.getElementById(`uniqueValidators-${variantId}`);
        const roleSpan = document.getElementById(`roleCount-${variantId}`);
        
        if (uniqueSpan) uniqueSpan.textContent = uniqueValidators;
        if (roleSpan) roleSpan.textContent = uniqueRoles;
        
        return validations;
        
    } catch (error) {
        console.error('âŒ Failed to update validation stats:', error);
        return [];
    }
}

/**
 * Submit validation to database
 */
async function submitValidation() {
    if (!STATE.ui.validationContext) return;
    
    const name = document.getElementById('clinicianName').value.trim();
    const role = document.getElementById('clinicianRoleInput').value.trim();
    const notes = document.getElementById('validationNotes').value.trim();
    const messageDiv = document.getElementById('validationMessage');
    const btn = document.getElementById('submitValidationBtn');
    
    if (!name) {
        messageDiv.innerHTML = '<span class="text-[#b91c1c]">âŒ Please enter your name</span>';
        return;
    }
    if (!role) {
        messageDiv.innerHTML = '<span class="text-[#b91c1c]">âŒ Please enter your role</span>';
        return;
    }
    
    const { variantId, variantName } = STATE.ui.validationContext;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        messageDiv.innerHTML = '<span class="text-[#0e7c7b]">â³ Submitting validation...</span>';
        
        // Save to Supabase
        const response = await fetch(`${CONFIG.SUPABASE.URL}/rest/v1/validation_history`, {
            method: 'POST',
            headers: {
                'apikey': CONFIG.SUPABASE.KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                variant_id: variantId,
                clinician_name: name,
                clinician_role: role,
                action: 'VALIDATED',
                notes: notes || null,
                created_at: new Date().toISOString()
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const savedValidation = await response.json();
        
        // Try to update validator_roles if table exists
        try {
            await fetch(`${CONFIG.SUPABASE.URL}/rest/v1/validator_roles`, {
                method: 'POST',
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'resolution=merge-duplicates'
                },
                body: JSON.stringify({
                    role_name: role,
                    last_used_at: new Date().toISOString()
                })
            }).catch(() => {
                // Table might not exist, update local cache instead
                const existingRole = STATE.existingRoles.find(r => r.role_name === role);
                if (existingRole) {
                    existingRole.usage_count = (existingRole.usage_count || 0) + 1;
                } else {
                    STATE.existingRoles.push({ role_name: role, usage_count: 1 });
                }
            });
        } catch (e) {
            // Non-critical, continue
        }
        
        // Refresh validation stats
        const validations = await updateVariantValidationStats(variantId);
        
        // Refresh validation history display if it's visible
        const historyDiv = document.getElementById(`validationHistory-${variantId}`);
        if (historyDiv && !historyDiv.classList.contains('hidden')) {
            await loadValidationHistory(variantId);
        }
        
        // Update count badge
        const countSpan = document.getElementById(`validationCount-${variantId}`);
        if (countSpan && validations) {
            countSpan.textContent = validations.length;
        }
        
        messageDiv.innerHTML = '<span class="text-[#0e7b4e]">âœ… Validation saved successfully!</span>';
        showNotification(`âœ“ ${name} (${role}) validated ${variantName}`, 'success');
        
        // Refresh the variant details if this is the selected variant
        if (STATE.view.selectedVariant?.id === variantId) {
            STATE.view.selectedVariant.validation_count = (STATE.view.selectedVariant.validation_count || 0) + 1;
            STATE.view.selectedVariant.last_validator_name = name;
            STATE.view.selectedVariant.last_validator_role = role;
            STATE.view.selectedVariant.last_validated_at = new Date().toISOString();
            
            renderVariantDetails(STATE.view.selectedVariant);
        }
        
        // Refresh master stats
        calculateMasterStats();
        
        setTimeout(() => {
            closeValidationModal();
        }, 1500);
        
    } catch (error) {
        console.error('âŒ Validation failed:', error);
        messageDiv.innerHTML = `<span class="text-[#b91c1c]">âŒ Error: ${error.message}</span>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Validate';
    }
}

/**
 * Toggle validation history visibility
 */
function toggleValidationHistory(variantId) {
    const historyDiv = document.getElementById(`validationHistory-${variantId}`);
    const toggleBtn = document.getElementById(`historyToggle-${variantId}`);
    
    if (!historyDiv) return;
    
    if (historyDiv.classList.contains('hidden')) {
        historyDiv.classList.remove('hidden');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-history"></i> History <i class="fas fa-chevron-up text-xs ml-1"></i>';
        }
        
        const loadingDiv = document.getElementById(`validationLoading-${variantId}`);
        if (loadingDiv && loadingDiv.style.display !== 'none') {
            loadValidationHistory(variantId);
        }
    } else {
        historyDiv.classList.add('hidden');
        if (toggleBtn) {
            const count = document.getElementById(`validationCount-${variantId}`)?.textContent || '0';
            toggleBtn.innerHTML = `<i class="fas fa-history"></i> History <span class="text-xs bg-gray-300 px-1.5 rounded-full">${count}</span>`;
        }
    }
}

/**
 * Load validation history for a variant
 */
async function loadValidationHistory(variantId) {
    const historyDiv = document.getElementById(`validationHistory-${variantId}`);
    const loadingDiv = document.getElementById(`validationLoading-${variantId}`);
    const countSpan = document.getElementById(`validationCount-${variantId}`);
    
    if (!historyDiv) return;
    
    try {
        if (loadingDiv) loadingDiv.style.display = 'block';
        
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/validation_history?` +
            `variant_id=eq.${variantId}&order=created_at.desc`,
            {
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                }
            }
        );
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const validations = await response.json();
        
        if (loadingDiv) loadingDiv.style.display = 'none';
        
        if (countSpan) {
            countSpan.textContent = validations.length;
        }
        
        // Update stats in UI
        const uniqueValidators = new Set(validations.map(v => v.clinician_name)).size;
        const uniqueRoles = new Set(validations.map(v => v.clinician_role)).size;
        
        const uniqueSpan = document.getElementById(`uniqueValidators-${variantId}`);
        const roleSpan = document.getElementById(`roleCount-${variantId}`);
        
        if (uniqueSpan) uniqueSpan.textContent = uniqueValidators;
        if (roleSpan) roleSpan.textContent = uniqueRoles;
        
        if (validations.length === 0) {
            historyDiv.innerHTML = `
                <div class="text-center text-gray-500 py-4 text-sm">
                    <i class="fas fa-info-circle mr-1"></i>
                    No validations yet. Be the first to validate!
                </div>
            `;
            return;
        }
        
        historyDiv.innerHTML = validations.map((v, index) => `
            <div class="mb-3 p-3 bg-gray-50 rounded-lg border-l-4 border-[#0e7c7b] ${index === 0 ? 'bg-[#f0fdfa]' : ''}">
                <div class="flex justify-between items-start">
                    <div>
                        <span class="font-bold text-gray-900">${escapeHTML(v.clinician_name)}</span>
                        <span class="text-xs bg-[#0e7c7b]/10 text-[#0e7c7b] px-2 py-0.5 rounded-full ml-2">
                            ${escapeHTML(v.clinician_role)}
                        </span>
                    </div>
                    <span class="text-xs text-gray-500">
                        ${formatDate(v.created_at)}
                    </span>
                </div>
                ${v.notes ? `
                    <p class="text-sm text-gray-600 mt-2 italic bg-white p-2 rounded border border-gray-100">
                        "${escapeHTML(v.notes)}"
                    </p>
                ` : ''}
                <div class="flex items-center gap-2 mt-2">
                    <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        <i class="fas fa-check-circle mr-1"></i> Validated
                    </span>
                    ${index === 0 ? `
                        <span class="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                            <i class="fas fa-clock mr-1"></i> Latest
                        </span>
                    ` : ''}
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('âŒ Failed to load validations:', error);
        if (loadingDiv) loadingDiv.style.display = 'none';
        historyDiv.innerHTML = `
            <div class="text-center text-[#b91c1c] py-4 text-sm">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                Failed to load validations
            </div>
        `;
    }
}

// ===================================================================
// ðŸ”¬ VARIANT DETAILS - COMPREHENSIVE DISPLAY
// ===================================================================

function renderVariantDetails(variant) {
    if (!variant) return;
    
    STATE.view.selectedVariant = variant;
    const missingCount = countMissingFields(variant);
    const isExceptional = variant.class_subtype === 'exceptional';
    const isResponsive = variant.eti_prediction === 'responsive';
    
    let classColor = '#374151';
    if (variant.cftr_class) {
        if (isExceptional) classColor = '#b45309';
        else if (variant.cftr_class === 'I') classColor = '#b91c1c';
        else if (variant.cftr_class === 'II') classColor = '#b45309';
        else if (variant.cftr_class === 'III') classColor = '#0f766e';
        else if (variant.cftr_class === 'IV') classColor = '#1e40af';
        else if (variant.cftr_class === 'V') classColor = '#6d28d9';
    }
    
    const detailsHTML = `
        <div class="card mb-6 overflow-visible">
            <div class="card-body" style="background: linear-gradient(145deg, #ffffff, #f9fafb);">
                <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6">
                    <div class="flex-1">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="variant-pill">
                                <i class="fas fa-dna"></i>
                                <div class="variant-pill-content">
                                    <span class="variant-pill-primary">${escapeHTML(variant.legacy_name)}</span>
                                    <span class="variant-pill-secondary">${escapeHTML(variant.protein_name || 'No protein notation')}</span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                ${missingCount > 0 ? 
                                    `<span class="badge" style="background: #ffedd5; color: #b45309; border-color: #fcd34d; border-width: 2px;">
                                        <i class="fas fa-exclamation-triangle"></i> ${missingCount} missing
                                    </span>` : 
                                    `<span class="badge" style="background: #d1fae5; color: #065f46; border-color: #a7f3d0; border-width: 2px;">
                                        <i class="fas fa-check-circle"></i> Complete
                                    </span>`
                                }
                                ${variant.data_status === 'complete_clinical' ? 
                                    `<span class="badge" style="background: #e0f2fe; color: #0369a1; border-color: #bae6fd;">
                                        <i class="fas fa-shield-alt"></i> Validated
                                    </span>` : ''
                                }
                                ${variant.validation_count > 0 ? 
                                    `<span class="badge" style="background: #0e7c7b; color: white; border: none;">
                                        <i class="fas fa-check-circle"></i> âœ“ ${variant.validation_count}
                                    </span>` : ''
                                }
                            </div>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 mb-2">
                            ${variant.cftr_class ? `
                                <span class="badge badge-class-${variant.cftr_class.toLowerCase()} text-sm py-1.5 px-3">
                                    <i class="fas fa-dna"></i> Class ${variant.cftr_class}
                                    ${isExceptional ? 'â€¢ Exceptional' : variant.class_subtype === 'true' ? 'â€¢ True Class I' : ''}
                                </span>
                            ` : ''}
                            
                            ${variant.eti_prediction ? `
                                <span class="badge text-sm py-1.5 px-3" style="background: ${isResponsive ? '#d1fae5' : '#fee2e2'}; 
                                      color: ${isResponsive ? '#065f46' : '#991b1b'}; 
                                      border-color: ${isResponsive ? '#a7f3d0' : '#fecaca'};">
                                    <i class="fas ${isResponsive ? 'fa-check' : 'fa-times'}"></i>
                                    ETI ${variant.eti_prediction === 'responsive' ? 'Responsive' : 'Non-responsive'}
                                </span>
                            ` : ''}
                            
                            ${variant.final_determination === 'CF-causing' ? `
                                <span class="badge text-sm py-1.5 px-3" style="background: #fee2e2; color: #991b1b; border-color: #fecaca;">
                                    <i class="fas fa-exclamation-triangle"></i> CF-causing
                                </span>
                            ` : variant.final_determination ? `
                                <span class="badge text-sm py-1.5 px-3" style="background: #f3f4f6; color: #374151; border-color: #e5e7eb;">
                                    ${escapeHTML(variant.final_determination)}
                                </span>
                            ` : ''}
                            
                            ${variant.class_subtype === 'exceptional' ? `
                                <span class="badge badge-exceptional text-sm py-1.5 px-3">
                                    <i class="fas fa-star"></i> Exceptional Case
                                </span>
                            ` : ''}
                        </div>
                        
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mt-3 text-xs text-gray-600">
                            ${variant.population_frequency ? 
                                `<span><i class="fas fa-globe mr-1 text-gray-400"></i> AF: ${variant.population_frequency}</span>` : ''}
                            ${variant.pubmed_ids ? 
                                `<span><i class="fas fa-book mr-1 text-gray-400"></i> PMID: ${variant.pubmed_ids}</span>` : ''}
                            ${variant.date_updated ? 
                                `<span><i class="fas fa-calendar mr-1 text-gray-400"></i> Updated: ${formatDate(variant.date_updated)}</span>` : ''}
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-2xl p-5 border border-gray-200 min-w-[200px] shadow-sm">
                        <p class="text-xs font-bold uppercase tracking-wider text-gray-500 mb-2 flex items-center gap-1">
                            <i class="fas fa-tag"></i> Classification
                        </p>
                        <p class="font-['Space_Grotesk'] text-3xl font-bold" style="color: ${classColor};">
                            ${variant.cftr_class || 'â€”'}
                        </p>
                        <p class="text-sm font-semibold text-gray-800 mt-1">
                            ${isExceptional ? 'Exceptional Case' : 
                              variant.class_subtype === 'true' ? 'True Class I' : 
                              variant.cftr_class ? `Class ${variant.cftr_class}` : 
                              'Not classified'}
                        </p>
                        ${variant.class_confidence ? `
                            <div class="flex items-center gap-1 mt-2 text-xs">
                                <span class="w-2 h-2 rounded-full ${
                                    variant.class_confidence === 'Confirmed' ? 'bg-[#0e7c7b]' : 
                                    variant.class_confidence === 'High' ? 'bg-[#059669]' : 
                                    variant.class_confidence === 'Moderate' ? 'bg-[#b45309]' : 'bg-gray-400'
                                }"></span>
                                <span class="font-medium text-gray-700">${variant.class_confidence}</span>
                            </div>
                        ` : ''}
                        ${variant.eti_recommendation ? `
                            <div class="mt-3 pt-3 border-t border-gray-100">
                                <p class="text-[10px] font-bold uppercase text-gray-400 mb-1">Recommendation</p>
                                <p class="text-xs font-medium text-[#0e7c7b]">${escapeHTML(variant.eti_recommendation)}</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="nomenclature-grid mb-6">
            ${createDataPoint('Legacy Name', variant.legacy_name, 'legacy_name', variant, true)}
            ${createDataPoint('Protein Notation', variant.protein_name, 'protein_name', variant)}
            ${createDataPoint('cDNA Notation', variant.cdna_name, 'cdna_name', variant)}
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <div class="card">
                <div class="card-header bg-gradient-to-r from-[#fef2f2] to-white border-b-2 border-[#b91c1c]/20">
                    <i class="fas fa-stethoscope text-[#b91c1c]"></i>
                    <span class="font-bold text-gray-900">Clinical Impact</span>
                    ${(!variant.final_determination || !variant.cftr_class) ? 
                        '<span class="missing-count text-xs ml-2">Missing</span>' : ''}
                </div>
                <div class="card-body">
                    <div class="space-y-3">
                        ${createDataPoint('Determination', variant.final_determination, 'final_determination', variant)}
                        ${createDataPoint('CFTR Class', variant.cftr_class, 'cftr_class', variant)}
                        ${createDataPoint('Subtype', variant.class_subtype, 'class_subtype', variant)}
                        ${createDataPoint('Confidence', variant.class_confidence, 'class_confidence', variant)}
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-gradient-to-r from-[#f0fdfa] to-white border-b-2 border-[#0e7c7b]/20">
                    <i class="fas fa-prescription-bottle-alt text-[#0e7c7b]"></i>
                    <span class="font-bold text-gray-900">Therapeutic Prediction</span>
                    ${!variant.eti_prediction ? '<span class="missing-count text-xs ml-2">Missing</span>' : ''}
                </div>
                <div class="card-body">
                    <div class="space-y-3">
                        ${createDataPoint('ETI Response', variant.eti_prediction, 'eti_prediction', variant)}
                        ${createDataPoint('Responsive', variant.therapy_responsive !== null ? (variant.therapy_responsive ? 'Yes' : 'No') : null, 'therapy_responsive', variant)}
                        ${createDataPoint('Evidence Level', variant.eti_evidence_level, 'eti_evidence_level', variant)}
                        ${createDataPoint('Recommendation', variant.eti_recommendation, 'eti_recommendation', variant)}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- EVIDENCE CHAIN - BEAUTIFUL WITH SCROLLABLE POPUP -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-microscope text-[#6d28d9]"></i>
                    <span>Evidence Chain</span>
                    <div class="ml-auto flex items-center gap-2">
                        <!-- Evidence count badge -->
                        <span class="text-xs bg-[#6d28d9]/10 text-[#6d28d9] px-3 py-1.5 rounded-full font-semibold flex items-center gap-1"
                              id="evidenceCount-${variant.id}"
                              onclick="showAllEvidence(${variant.id})"
                              style="cursor: pointer;">
                            <i class="fas fa-link"></i>
                            ${variant.evidence_links ? variant.evidence_links.length : 0} sources
                        </span>
                        
                        <!-- Add evidence button -->
                        <button onclick="showEvidenceModal('${variant.legacy_name}', ${variant.id})" 
                                class="text-xs bg-[#6d28d9] text-white px-3 py-1.5 rounded-lg hover:bg-[#5b21b6] transition-all flex items-center gap-1">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>
                
                <div class="card-body">
                    <!-- Preview of latest 3 evidence links (scrollable if more) -->
            <div class="space-y-2 max-h-[200px] overflow-y-auto pr-2 custom-scrollbar" id="evidencePreview-${variant.id}">
    ${variant.evidence_links && variant.evidence_links.length > 0 
        ? variant.evidence_links.slice(0,3).map(link => renderEvidenceLink(link)).join('')
        : '<div class="text-center py-4"><p class="text-sm text-gray-500">No evidence links yet</p></div>'}
</div>
                    
                    <!-- Source summary (if exists) -->
                    ${variant.source_summary ? `
                        <div class="mt-4 pt-3 border-t border-gray-200 flex items-center justify-between">
                            <div class="flex items-center gap-2 text-xs text-gray-500">
                                <i class="fas fa-database"></i>
                                <span>Source: ${escapeHTML(variant.source_summary)}</span>
                            </div>
                            ${variant.evidence_links?.length > 3 ? `
                                <button onclick="showAllEvidence(${variant.id})" 
                                        class="text-xs text-[#6d28d9] hover:underline font-medium">
                                    View all ${variant.evidence_links.length} sources â†’
                                </button>
                            ` : ''}
                        </div>
                    ` : variant.evidence_links?.length > 3 ? `
                        <div class="mt-4 pt-3 border-t border-gray-200 text-right">
                            <button onclick="showAllEvidence(${variant.id})" 
                                    class="text-xs text-[#6d28d9] hover:underline font-medium">
                                View all ${variant.evidence_links.length} sources â†’
                            </button>
                        </div>
                    ` : ''}
                </div>
            </div>
            
            <!-- CLINICAL VALIDATION CARD - ENHANCED VERSION -->
                        <!-- CLINICAL VALIDATION CARD - ENHANCED VERSION -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-shield-alt text-[#0e7c7b]"></i>
                    <span>Clinical Validation</span>
                    <div class="ml-auto flex items-center gap-2">
                        ${variant.validation_count > 0 ? `
                            <span class="bg-[#0e7c7b] text-white px-3 py-1 rounded-full text-xs font-bold flex items-center gap-1">
                                <i class="fas fa-check-circle"></i> Validated (${variant.validation_count})
                            </span>
                        ` : `
                            <span class="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs font-bold">
                                Not Validated
                            </span>
                        `}
                        <button onclick="showValidationModal('${variant.legacy_name}', ${variant.id})" 
                                class="text-xs bg-[#0e7c7b] text-white px-3 py-1.5 rounded-lg hover:bg-[#0a5e5d] transition-all flex items-center gap-1">
                            <i class="fas fa-check-circle"></i> Validate
                        </button>
                        <button onclick="toggleValidationHistory(${variant.id})" 
                                id="historyToggle-${variant.id}"
                                class="text-xs bg-gray-100 text-gray-700 px-3 py-1.5 rounded-lg hover:bg-gray-200 transition-all flex items-center gap-1">
                            <i class="fas fa-history"></i> History 
                            <span class="text-xs bg-gray-300 px-1.5 rounded-full" id="validationCount-${variant.id}">${variant.validation_count || 0}</span>
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="flex items-start gap-3 mb-3">
                        <div class="w-10 h-10 rounded-full ${variant.validation_count > 0 ? 'bg-[#0e7c7b]/20' : 'bg-[#e9f0f9]'} flex items-center justify-center flex-shrink-0">
                            <i class="fas ${variant.validation_count > 0 ? 'fa-check-circle text-[#0e7c7b]' : 'fa-clock text-[#0a2e5a]'}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-semibold text-gray-900">Validation Status</p>
                            ${variant.last_validator_name ? `
                                <p class="text-xs text-gray-600 mt-1">
                                    <span class="font-medium">Last validated by:</span> 
                                    ${escapeHTML(variant.last_validator_name)} 
                                    <span class="text-[#0e7c7b] bg-[#0e7c7b]/10 px-2 py-0.5 rounded-full text-[10px] ml-1">
                                        ${escapeHTML(variant.last_validator_role || 'Unknown')}
                                    </span>
                                </p>
                                <p class="text-xs text-gray-500 mt-0.5">
                                    ${variant.last_validated_at ? formatDate(variant.last_validated_at) : ''}
                                </p>
                            ` : `
                                <p class="text-xs text-gray-500 mt-1 italic">
                                    No validations yet. Be the first to validate!
                                </p>
                            `}
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 mt-3 pt-3 border-t border-gray-100">
                        <div class="text-center">
                            <span class="text-lg font-bold text-[#0e7c7b]">${variant.validation_count || 0}</span>
                            <p class="text-[10px] text-gray-500">Total</p>
                        </div>
                        <div class="text-center">
                            <span class="text-lg font-bold text-[#0e7c7b]" id="uniqueValidators-${variant.id}">â€”</span>
                            <p class="text-[10px] text-gray-500">Unique</p>
                        </div>
                        <div class="text-center">
                            <span class="text-lg font-bold text-[#0e7c7b]" id="roleCount-${variant.id}">â€”</span>
                            <p class="text-[10px] text-gray-500">Roles</p>
                        </div>
                    </div>
                    
                    <div id="validationHistory-${variant.id}" class="mt-4 pt-4 border-t border-gray-200 hidden">
                        <div class="text-center text-gray-500 py-4" id="validationLoading-${variant.id}">
                            <i class="fas fa-spinner fa-spin mr-2"></i> Loading validation history...
                        </div>
                    </div>
                </div>
            </div>
        
        ${CONFIG.FEATURES.ENABLE_DELETE ? `
            <div class="mt-4 flex justify-end">
                <button onclick="showDeleteModal('${variant.legacy_name}', ${variant.id})" 
                        class="px-5 py-2.5 text-xs font-bold text-[#b91c1c] bg-[#fee2e2] border-2 border-[#fecaca] rounded-xl hover:bg-[#fecaca] transition-all shadow-sm">
                    <i class="fas fa-trash-alt mr-1.5"></i> Delete Variant
                </button>
            </div>
        ` : ''}
    `;
    
    const container = document.getElementById('variantDetails');
    if (container) {
        container.innerHTML = detailsHTML;
    }
    document.getElementById('emptyState')?.classList.add('hidden');
    
    // Load validation stats and history
    setTimeout(() => {
        if (variant && variant.id) {
            updateVariantValidationStats(variant.id);
        }
    }, 100);
}

function createDataPoint(label, value, field, variant, isPrimary = false) {
    const isMissing = !value || value === 'null' || value === 'undefined' || value === '';
    const displayValue = isMissing ? 'Not specified' : escapeHTML(String(value));
    const escapedValue = value ? String(value).replace(/'/g, "\\'").replace(/"/g, '&quot;') : '';
    
    return `
        <div class="data-point ${isMissing ? 'missing' : ''} ${isPrimary ? 'border-l-4 border-l-[#0e7c7b]' : ''}">
            <div class="annotation-trigger" 
                 onclick="showAnnotationModal('${variant.legacy_name}', '${field}', '${escapedValue}')"
                 title="Annotate ${label}">
                <i class="fas ${isMissing ? 'fa-plus' : 'fa-pencil-alt'}"></i>
            </div>
            <div class="data-label">
                <i class="fas fa-tag"></i>
                ${label}
            </div>
            <div class="data-value ${isMissing ? 'text-[#b45309] font-semibold' : ''}">
                ${displayValue}
            </div>
        </div>
    `;
}
function renderEvidenceLink(link) {
    return `
        <div class="group relative bg-white rounded-lg border border-gray-200 hover:border-[#6d28d9] hover:shadow-md transition-all duration-200 p-3">
            <div class="flex items-start gap-3">
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-[#6d28d9]/10 to-[#6d28d9]/5 flex items-center justify-center flex-shrink-0">
                    <i class="fas ${getEvidenceIcon(link.type)} text-[#6d28d9] text-sm"></i>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="text-sm font-semibold text-gray-900 truncate">${escapeHTML(link.title)}</h4>
                    <div class="flex items-center gap-2 mt-1">
                        <span class="text-xs bg-[#6d28d9]/10 text-[#6d28d9] px-2 py-0.5 rounded-full">
                            ${escapeHTML(link.source || link.type)}
                        </span>
                        <span class="text-xs text-gray-500">
                            ${link.year ? link.year : ''}
                        </span>
                    </div>
                    <div class="mt-2 text-xs text-gray-400 truncate">
                        ${link.url ? link.url.substring(0, 40) + '...' : ''}
                    </div>
                </div>
            </div>
        </div>
    `;
}
// ===================================================================
// ðŸ“ ANNOTATION SYSTEM - FULL CRUD
// ===================================================================

function showAnnotationModal(variantName, field, currentValue) {
    const variant = STATE.variantsByLegacyName.get(variantName);
    if (!variant) {
        showNotification('Variant not found', 'error');
        return;
    }
    
    STATE.ui.annotationContext = { variant, field, currentValue: currentValue === '' ? null : currentValue };
    
    const labels = {
        'legacy_name': 'Legacy Name',
        'protein_name': 'Protein Notation',
        'cdna_name': 'cDNA Notation',
        'final_determination': 'Clinical Impact',
        'cftr_class': 'CFTR Class',
        'class_subtype': 'Subtype',
        'class_confidence': 'Confidence',
        'eti_prediction': 'ETI Response',
        'eti_recommendation': 'Recommendation',
        'therapy_responsive': 'Therapy Responsive',
        'eti_evidence_level': 'Evidence Level',
        'source_summary': 'Evidence Source',
        'population_frequency': 'Population Frequency',
        'pubmed_ids': 'PubMed IDs'
    };
    
    document.getElementById('annotationTitle').innerHTML = 
        `<i class="fas fa-pencil-alt mr-2"></i>Annotate ${variantName}`;
    document.getElementById('annotationField').textContent = labels[field] || field.replace(/_/g, ' ');
    
    let inputHTML = '';
    
    if (field === 'cftr_class') {
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select class</option>
            ${['I', 'II', 'III', 'IV', 'V'].map(c => 
                `<option value="${c}" ${currentValue === c ? 'selected' : ''}>Class ${c}</option>`
            ).join('')}
        </select>`;
    } else if (field === 'class_subtype') {
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select subtype</option>
            <option value="standard" ${currentValue === 'standard' ? 'selected' : ''}>Standard</option>
            <option value="exceptional" ${currentValue === 'exceptional' ? 'selected' : ''}>Exceptional (ETI-responsive Class I)</option>
            <option value="true" ${currentValue === 'true' ? 'selected' : ''}>True Class I</option>
        </select>`;
    } else if (field === 'eti_prediction') {
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select response</option>
            <option value="responsive" ${currentValue === 'responsive' ? 'selected' : ''}>Responsive</option>
            <option value="non_responsive" ${currentValue === 'non_responsive' ? 'selected' : ''}>Non-responsive</option>
            <option value="unknown" ${currentValue === 'unknown' ? 'selected' : ''}>Unknown</option>
        </select>`;
    } else if (field === 'therapy_responsive') {
        const isTrue = currentValue === true || currentValue === 'true';
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select</option>
            <option value="true" ${isTrue ? 'selected' : ''}>Yes â€” Responds to therapy</option>
            <option value="false" ${currentValue === false || currentValue === 'false' ? 'selected' : ''}>No â€” Does not respond</option>
        </select>`;
    } else if (field === 'class_confidence' || field === 'eti_evidence_level') {
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select level</option>
            ${['Confirmed', 'High', 'Moderate', 'Low'].map(l => 
                `<option value="${l}" ${currentValue === l ? 'selected' : ''}>${l}</option>`
            ).join('')}
        </select>`;
    } else if (field === 'final_determination') {
        inputHTML = `<select id="annotationValue" class="form-control">
            <option value="">Select determination</option>
            <option value="CF-causing" ${currentValue === 'CF-causing' ? 'selected' : ''}>CF-causing</option>
            <option value="Probably responsive to ETI" ${currentValue === 'Probably responsive to ETI' ? 'selected' : ''}>Probably responsive to ETI</option>
            <option value="Variant of unknown significance" ${currentValue === 'Variant of unknown significance' ? 'selected' : ''}>VUS</option>
            <option value="Likely CF-causing" ${currentValue === 'Likely CF-causing' ? 'selected' : ''}>Likely CF-causing</option>
            <option value="Non CF-causing" ${currentValue === 'Non CF-causing' ? 'selected' : ''}>Non CF-causing</option>
        </select>`;
    } else {
        inputHTML = `<textarea id="annotationValue" class="form-control font-mono" rows="3">${escapeHTML(currentValue || '')}</textarea>`;
    }
    
    document.getElementById('annotationContent').innerHTML = `
        <div class="bg-gray-50/80 rounded-xl p-5 mb-5 border border-gray-200">
            <p class="text-xs font-bold uppercase tracking-wider text-gray-600 mb-2">Current Value</p>
            <p class="font-mono text-sm bg-white p-3 rounded-lg border ${!currentValue ? 'text-gray-400 italic' : ''}">
                ${currentValue ? escapeHTML(String(currentValue)) : 'Not specified'}
            </p>
        </div>
        <div class="form-group">
            <label class="form-label">${labels[field] || field}</label>
            ${inputHTML}
        </div>
    `;
    
    document.getElementById('annotationModal').classList.remove('hidden');
}

function closeAnnotationModal() {
    document.getElementById('annotationModal').classList.add('hidden');
    STATE.ui.annotationContext = null;
}

async function saveAnnotation() {
    if (!STATE.ui.annotationContext) {
        showNotification('No annotation context', 'error');
        return;
    }
    
    const { variant, field } = STATE.ui.annotationContext;
    const input = document.getElementById('annotationValue');
    if (!input) return;
    
    let val = input.value;
    if (field === 'therapy_responsive') val = val === 'true';
    if (val === '') val = null;
    
    try {
        showNotification('Saving...', 'info', 2000);
        
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/variants?id=eq.${variant.id}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ 
                    [field]: val, 
                    updated_at: new Date().toISOString() 
                })
            }
        );
        
        STATE.system.apiCalls++;
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        STATE.variants = STATE.variants.map(v => 
            v.id === variant.id ? { ...v, [field]: val, updated_at: new Date().toISOString() } : v
        );
        
        const updatedVariant = STATE.variants.find(v => v.id === variant.id);
        STATE.variantsById.set(variant.id, updatedVariant);
        STATE.variantsByLegacyName.set(updatedVariant.legacy_name, updatedVariant);
        
        buildSearchIndex();
        calculateMasterStats();
        
        if (STATE.view.selectedVariant?.id === variant.id) {
            STATE.view.selectedVariant = updatedVariant;
            renderVariantDetails(updatedVariant);
        }
        
        closeAnnotationModal();
        showNotification(`âœ“ ${field.replace(/_/g, ' ')} updated successfully`, 'success');
        
        renderVariantList();
        applyFilterChain();
        
    } catch (error) {
        console.error('âŒ Annotation failed:', error);
        showNotification(`Failed to update: ${error.message}`, 'error');
    }
}

// ===================================================================
// ðŸ—‘ï¸ DELETE SYSTEM - WITH CONFIRMATION
// ===================================================================

function showDeleteModal(name, id) {
    STATE.ui.deleteContext = { variantName: name, variantId: id };
    document.getElementById('deleteVariantName').textContent = name;
    document.getElementById('deleteModal').classList.remove('hidden');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.add('hidden');
    STATE.ui.deleteContext = null;
}

async function confirmDeleteVariant() {
    if (!STATE.ui.deleteContext) return;
    
    const { variantName, variantId } = STATE.ui.deleteContext;
    
    try {
        showNotification(`Deleting ${variantName}...`, 'info', 3000);
        
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/variants?id=eq.${variantId}`,
            {
                method: 'DELETE',
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                }
            }
        );
        
        STATE.system.apiCalls++;
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        STATE.variants = STATE.variants.filter(v => v.id !== variantId);
        STATE.view.filteredVariants = STATE.view.filteredVariants.filter(v => v.id !== variantId);
        STATE.variantsById.delete(variantId);
        STATE.variantsByLegacyName.delete(variantName);
        
        buildSearchIndex();
        calculateMasterStats();
        
        if (STATE.view.selectedVariant?.id === variantId) {
            STATE.view.selectedVariant = null;
            document.getElementById('variantDetails').innerHTML = document.getElementById('emptyState')?.outerHTML || '';
        }
        
        closeDeleteModal();
        showNotification(`âœ“ Deleted ${variantName} permanently`, 'success');
        
        renderVariantList();
        updatePagination();
        renderViewUI();
        
    } catch (error) {
        console.error('âŒ Delete failed:', error);
        showNotification(`Delete failed: ${error.message}`, 'error');
        closeDeleteModal();
    }
}

// ===================================================================
// ðŸ“Š DASHBOARD - ANALYTICS CHARTS
// ===================================================================

function showDashboard() {
    document.getElementById('dashboardModal').classList.remove('hidden');
    renderCharts();
    updateDashboardStats();
}

function closeDashboard() {
    document.getElementById('dashboardModal').classList.add('hidden');
}

function refreshDashboardStats() {
    calculateMasterStats();
    renderCharts();
    updateDashboardStats();
    showNotification('Dashboard refreshed', 'success');
}

function updateDashboardStats() {
    const s = STATE.masterStats;
    safeSetText('dashboardExceptional', s.exceptional.toLocaleString());
    const pct = s.classI ? ((s.exceptional / s.classI) * 100).toFixed(1) : '0.0';
    safeSetText('exceptionalPercentile', pct + '%');
}

function renderCharts() {
    if (!window.Chart) {
        console.warn('Chart.js not loaded');
        return;
    }
    
    const s = STATE.masterStats;
    
    const classCtx = document.getElementById('classChart');
    if (classCtx) {
        if (STATE.ui.charts.classChart) STATE.ui.charts.classChart.destroy();
        STATE.ui.charts.classChart = new Chart(classCtx, {
            type: 'doughnut',
            data: {
                labels: ['Class I', 'Class II', 'Class III', 'Class IV', 'Class V'],
                datasets: [{
                    data: [s.classI, s.classII, s.classIII, s.classIV, s.classV],
                    backgroundColor: ['#b91c1c', '#b45309', '#0f766e', '#1e40af', '#6d28d9'],
                    borderWidth: 4,
                    borderColor: 'white'
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.raw} variants (${((ctx.raw/s.total)*100).toFixed(1)}%)` } }
                }
            }
        });
    }
    
    const respCtx = document.getElementById('responseChart');
    if (respCtx) {
        if (STATE.ui.charts.responseChart) STATE.ui.charts.responseChart.destroy();
        STATE.ui.charts.responseChart = new Chart(respCtx, {
            type: 'bar',
            data: {
                labels: ['Responsive', 'Non-responsive', 'Unknown'],
                datasets: [{
                    label: 'Variants',
                    data: [s.responsive, s.nonResponsive, s.unknown],
                    backgroundColor: ['#0f766e', '#b91c1c', '#b45309'],
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, ticks: { stepSize: 100 } } },
                plugins: { tooltip: { callbacks: { label: (ctx) => `${ctx.raw} variants` } } }
            }
        });
    }
    
    const compCtx = document.getElementById('completionChart');
    if (compCtx) {
        if (STATE.ui.charts.completionChart) STATE.ui.charts.completionChart.destroy();
        STATE.ui.charts.completionChart = new Chart(compCtx, {
            type: 'doughnut',
            data: {
                labels: ['Complete Clinical', 'Incomplete'],
                datasets: [{
                    data: [s.complete, s.total - s.complete],
                    backgroundColor: ['#0f766e', '#e5e7eb'],
                    borderWidth: 3,
                    borderColor: 'white'
                }]
            },
            options: {
                responsive: true,
                cutout: '70%',
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { callbacks: { label: (ctx) => `${ctx.raw} variants (${((ctx.raw/s.total)*100).toFixed(1)}%)` } }
                }
            }
        });
    }
}

function preloadCharts() {
    setTimeout(renderCharts, 100);
}

// ===================================================================
// ðŸ“¤ EXPORT SYSTEM - CSV REPORTS
// ===================================================================
// ===================================================================
// ðŸ“¤ EXPORT SYSTEM - CSV REPORTS
// ===================================================================

function exportReport() {
    const headers = ['Legacy Name', 'Protein', 'cDNA', 'Determination', 'CFTR Class', 
                    'Subtype', 'Confidence', 'ETI Response', 'Evidence Level', 
                    'Recommendation', 'Data Status', 'Source', 'Validation Count'];
    
    const rows = STATE.variants.map(v => [
        v.legacy_name, v.protein_name, v.cdna_name, v.final_determination,
        v.cftr_class, v.class_subtype, v.class_confidence, v.eti_prediction,
        v.eti_evidence_level, v.eti_recommendation, v.data_status, v.source_summary,
        v.validation_count || 0
    ]);
    
    generateCSV(headers, rows, `helix-export-${getCurrentDate()}.csv`);
    showNotification('âœ“ Export complete', 'success');
}

function exportFullReport() {
    const headers = ['ID', 'Legacy Name', 'Protein', 'cDNA', 'Determination', 'CFTR Class',
        'Subtype', 'Confidence', 'ETI Response', 'Evidence Level', 'Recommendation',
        'Therapy Responsive', 'Data Status', 'Source', 'Population Frequency', 
        'PubMed IDs', 'Date Updated', 'Validation Count', 'Last Validator', 'Last Validated'];
    
    const rows = STATE.variants.map(v => [
        v.id, v.legacy_name, v.protein_name, v.cdna_name, v.final_determination,
        v.cftr_class, v.class_subtype, v.class_confidence, v.eti_prediction,
        v.eti_evidence_level, v.eti_recommendation,
        v.therapy_responsive !== undefined ? (v.therapy_responsive ? 'Yes' : 'No') : '',
        v.data_status, v.source_summary, v.population_frequency, v.pubmed_ids, v.date_updated,
        v.validation_count || 0,
        v.last_validator_name || '',
        v.last_validated_at || ''
    ]);
    
    generateCSV(headers, rows, `helix-full-report-${getCurrentDate()}.csv`);
    showNotification('âœ“ Full export complete', 'success');
}

function generateCSV(headers, rows, filename) {
    const csv = [headers, ...rows]
        .map(row => row.map(cell => `"${String(cell || '').replace(/"/g, '""')}"`).join(','))
        .join('\n');
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(url);
}
// ===================================================================
// ðŸ“¥ IMPORT SYSTEM - JSON, FORM, BULK CSV
// ===================================================================

function showImportModal() {
    document.getElementById('importModal').classList.remove('hidden');
    switchImportTab('json');
}

function closeImportModal() {
    document.getElementById('importModal').classList.add('hidden');
    clearImportForm();
    clearManualForm();
}

function switchImportTab(tab) {
    ['json', 'form', 'bulk'].forEach(t => {
        document.getElementById(`${t}TabBtn`)?.classList.toggle('active', t === tab);
        document.getElementById(`${t}ImportPanel`)?.classList.toggle('hidden', t !== tab);
    });
}

function clearImportForm() {
    const input = document.getElementById('jsonInput');
    if (input) input.value = '';
    document.getElementById('importResults').innerHTML = '';
    
    const btn = document.getElementById('executeImportBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Import Data';
    }
    STATE.ui.validatedJson = null;
}

function clearManualForm() {
    ['formLegacyName', 'formProteinName', 'formCdnaName', 'formDetermination', 
     'formClass', 'formClassSubtype', 'formConfidence', 'formEtiResponse', 
     'formEvidenceLevel', 'formRecommendation'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
}

function validateImport() {
    const input = document.getElementById('jsonInput');
    const results = document.getElementById('importResults');
    const btn = document.getElementById('executeImportBtn');
    
    if (!input || !results) return;
    
    try {
        const parsed = JSON.parse(input.value.trim());
        
        const dataArray = Array.isArray(parsed) ? parsed : [parsed];
        
        const errors = [];
        const validItems = [];
        
        dataArray.forEach((item, index) => {
            const required = ['variant_legacy_name', 'variant_protein_name', 
                            'variant_cDNA_name', 'variant_final_determination'];
            
            const missing = required.filter(f => !item[f]);
            
            if (missing.length > 0) {
                errors.push({
                    index: index + 1,
                    name: item.variant_legacy_name || 'UNKNOWN',
                    missing: missing
                });
            } else {
                validItems.push(item);
            }
        });
        
        if (errors.length > 0) {
            let errorHtml = '';
            errors.forEach(err => {
                errorHtml += `<div class="text-xs mt-1">âŒ Item ${err.index}: ${err.name} - missing ${err.missing.join(', ')}</div>`;
            });
            
            results.innerHTML = `
                <div class="bg-[#fee2e2] border-2 border-[#b91c1c] rounded-xl p-5">
                    <p class="font-bold text-[#b91c1c]">âŒ Validation failed</p>
                    <p class="text-sm mt-1">${errors.length} of ${dataArray.length} item(s) have missing fields</p>
                    ${errorHtml}
                </div>
            `;
            
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Import Data';
            }
            STATE.ui.validatedJson = null;
            return;
        }
        
        STATE.ui.validatedJson = dataArray.length === 1 ? dataArray[0] : dataArray;
        
        const existsText = dataArray.length === 1 && STATE.variants.some(v => v.legacy_name === dataArray[0].variant_legacy_name) 
            ? 'will be updated' 
            : 'ready to import';
        
        results.innerHTML = `
            <div class="bg-[#e3f9e9] border-2 border-[#0e7b4e] rounded-xl p-5">
                <p class="font-bold text-[#0e7b4e]">âœ“ Valid JSON â€” ${validItems.length} variant(s) ready</p>
                <p class="text-sm mt-1">
                    ${dataArray.length === 1 
                        ? `<span class="font-mono">${escapeHTML(dataArray[0].variant_legacy_name)}</span> ${existsText}`
                        : `Found ${validItems.length} valid variants`
                    }
                </p>
            </div>
        `;
        
        if (btn) {
            btn.disabled = false;
            if (dataArray.length === 1) {
                btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Import ${dataArray[0].variant_legacy_name}`;
            } else {
                btn.innerHTML = `<i class="fas fa-cloud-upload-alt"></i> Import ${validItems.length} Variants`;
            }
        }
        
    } catch (e) {
        results.innerHTML = `
            <div class="bg-[#fee2e2] border-2 border-[#b91c1c] rounded-xl p-5">
                <p class="font-bold text-[#b91c1c]">âŒ Invalid JSON</p>
                <p class="text-sm mt-1">${escapeHTML(e.message)}</p>
            </div>
        `;
        
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Import Data';
        }
        STATE.ui.validatedJson = null;
    }
}

// ===================================================================
// ðŸ”„ BULK DUPLICATE RESOLUTION - SAVE HOURS OF CLICKING
// ===================================================================

let bulkImportDecision = null; // 'skip_all', 'update_all', 'merge_all', 'prompt'

async function promptForBulkDuplicateAction(duplicates) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '100000';
        
        // Count duplicates by type
        const existingCount = duplicates.length;
        const sampleNames = duplicates.slice(0, 5).map(d => d.name).join(', ');
        const moreText = existingCount > 5 ? ` and ${existingCount - 5} more` : '';
        
        modal.innerHTML = `
            <div class="modal" style="max-width: 600px;">
                <div class="modal-header bg-gradient-to-r from-[#b45309]/10 to-white border-b-2 border-[#b45309]">
                    <h3 class="heading-3 text-gray-900 flex items-center gap-2">
                        <i class="fas fa-layer-group text-[#b45309]"></i>
                        <span>Bulk Import: ${existingCount} Duplicates Found</span>
                    </h3>
                    <button onclick="this.closest('.modal-overlay').remove()" class="w-9 h-9 rounded-xl hover:bg-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="bg-[#ffedd5] rounded-xl p-5 border border-[#b45309]/20 mb-5">
                        <div class="flex items-start gap-3">
                            <div class="w-10 h-10 rounded-full bg-[#b45309]/20 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-exclamation-triangle text-[#b45309]"></i>
                            </div>
                            <div>
                                <p class="font-semibold text-[#b45309] mb-1">âš ï¸ Duplicate Variants Detected</p>
                                <p class="text-sm text-gray-700">
                                    ${existingCount} of the variants you're importing already exist in the database.
                                </p>
                                <p class="text-xs text-gray-600 mt-2 font-mono bg-white/50 p-2 rounded">
                                    ${escapeHTML(sampleNames)}${moreText}
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <p class="text-sm font-medium text-gray-700">How would you like to handle duplicates?</p>
                        
                        <!-- Option 1: Skip All -->
                        <div onclick="selectBulkOption('skip_all')" id="bulk-option-skip" 
                             class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:border-[#b45309] hover:bg-[#ffedd5]/20">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5" id="radio-skip">
                                    <div class="w-3 h-3 rounded-full hidden" id="radio-dot-skip"></div>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Skip all duplicates</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Keep existing records unchanged. Only import new variants that don't exist yet.
                                    </p>
                                    <div class="mt-2 text-xs bg-gray-100 p-2 rounded text-gray-700">
                                        <i class="fas fa-ban mr-1 text-[#b45309]"></i>
                                        ${existingCount} variant(s) will be skipped
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Option 2: Update All -->
                        <div onclick="selectBulkOption('update_all')" id="bulk-option-update" 
                             class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:border-[#0e7c7b] hover:bg-[#f0fdfa]">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5" id="radio-update">
                                    <div class="w-3 h-3 rounded-full hidden" id="radio-dot-update"></div>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Update all existing records</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Overwrite existing variants with imported data. Missing fields in import will be set to empty.
                                    </p>
                                    <div class="mt-2 text-xs bg-blue-50 p-2 rounded text-blue-700">
                                        <i class="fas fa-sync-alt mr-1"></i>
                                        ${existingCount} variant(s) will be UPDATED
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Option 3: Merge (only update fields that are empty in current) -->
                        <div onclick="selectBulkOption('merge_all')" id="bulk-option-merge" 
                             class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:border-[#6d28d9] hover:bg-[#f5f0ff]">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5" id="radio-merge">
                                    <div class="w-3 h-3 rounded-full hidden" id="radio-dot-merge"></div>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Merge (smart update)</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Only update fields that are empty in the current database. Keep existing data where present.
                                    </p>
                                    <div class="mt-2 text-xs bg-purple-50 p-2 rounded text-purple-700">
                                        <i class="fas fa-code-branch mr-1"></i>
                                        Preserves existing data, fills in missing fields
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Option 4: Prompt for each -->
                        <div onclick="selectBulkOption('prompt')" id="bulk-option-prompt" 
                             class="border-2 rounded-xl p-4 cursor-pointer transition-all hover:border-gray-400 hover:bg-gray-50">
                            <div class="flex items-start gap-3">
                                <div class="w-6 h-6 rounded-full border-2 border-gray-300 flex items-center justify-center flex-shrink-0 mt-0.5" id="radio-prompt">
                                    <div class="w-3 h-3 rounded-full hidden" id="radio-dot-prompt"></div>
                                </div>
                                <div class="flex-1">
                                    <p class="font-semibold text-gray-900">Ask me for each duplicate</p>
                                    <p class="text-sm text-gray-600 mt-1">
                                        Review each duplicate one by one (slower but gives you full control).
                                    </p>
                                    <div class="mt-2 text-xs bg-gray-100 p-2 rounded text-gray-700">
                                        <i class="fas fa-question-circle mr-1"></i>
                                        You'll see ${existingCount} prompts
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview of what will happen -->
                    <div class="mt-6 bg-gray-50 rounded-xl p-4 border border-gray-200" id="bulk-preview">
                        <p class="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1">
                            <i class="fas fa-eye"></i>
                            Preview
                        </p>
                        <p class="text-sm text-gray-700" id="bulk-preview-text">
                            Select an option above to see what will happen
                        </p>
                    </div>
                </div>
                
                <div class="modal-footer flex-col sm:flex-row gap-3">
                    <div class="flex-1 text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        This choice will apply to ALL ${existingCount} duplicates
                    </div>
                    <div class="flex gap-2">
                        <button onclick="cancelBulkImport()" class="btn btn-secondary">
                            Cancel Import
                        </button>
                        <button onclick="confirmBulkOption()" class="btn btn-primary" id="bulk-confirm-btn" disabled>
                            <i class="fas fa-check mr-1"></i> Apply & Continue
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Store resolve function globally for this modal
        window.bulkResolve = resolve;
    });
}

// Select bulk option
function selectBulkOption(option) {
    bulkImportDecision = option;
    
    // Reset all radio buttons
    ['skip', 'update', 'merge', 'prompt'].forEach(opt => {
        const radio = document.getElementById(`radio-${opt}`);
        const dot = document.getElementById(`radio-dot-${opt}`);
        if (radio) {
            radio.classList.remove('border-[#b45309]', 'border-[#0e7c7b]', 'border-[#6d28d9]');
            radio.classList.add('border-gray-300');
        }
        if (dot) dot.classList.add('hidden');
    });
    
    // Highlight selected
    const selectedRadio = document.getElementById(`radio-${option}`);
    const selectedDot = document.getElementById(`radio-dot-${option}`);
    const borders = {
        'skip_all': '#b45309',
        'update_all': '#0e7c7b',
        'merge_all': '#6d28d9',
        'prompt': '#6b7280'
    };
    
    if (selectedRadio) {
        selectedRadio.classList.remove('border-gray-300');
        selectedRadio.style.borderColor = borders[option];
    }
    if (selectedDot) {
        selectedDot.classList.remove('hidden');
        selectedDot.style.backgroundColor = borders[option];
    }
    
    // Update preview
    const preview = document.getElementById('bulk-preview-text');
    const previews = {
        'skip_all': 'â­ï¸ All duplicate variants will be SKIPPED. Only new variants will be imported.',
        'update_all': 'âœï¸ All existing variants will be OVERWRITTEN with imported data.',
        'merge_all': 'ðŸ”„ SMART MERGE: Only empty fields will be filled. Existing data preserved.',
        'prompt': 'â“ You will be prompted for each of the duplicate variants.'
    };
    if (preview) preview.textContent = previews[option];
    
    // Enable confirm button
    const confirmBtn = document.getElementById('bulk-confirm-btn');
    if (confirmBtn) confirmBtn.disabled = false;
}

function cancelBulkImport() {
    // Close modal and resolve with 'cancel'
    const modal = document.querySelector('.modal-overlay:last-child');
    if (modal) modal.remove();
    
    if (window.bulkResolve) {
        window.bulkResolve('cancel');
        window.bulkResolve = null;
    }
    bulkImportDecision = null;
}

function confirmBulkOption() {
    // Close modal and resolve with selected option
    const modal = document.querySelector('.modal-overlay:last-child');
    if (modal) modal.remove();
    
    if (window.bulkResolve) {
        window.bulkResolve(bulkImportDecision);
        window.bulkResolve = null;
    }
    // Don't reset bulkImportDecision yet - it's needed for the import loop
}

// ===================================================================
// ðŸ“¥ MODIFIED JSON IMPORT WITH BULK DUPLICATE HANDLING
// ===================================================================

async function executeJsonImport() {
    if (!STATE.ui.validatedJson) {
        showNotification('Please validate JSON first', 'warning');
        return;
    }
    
    const btn = document.getElementById('executeImportBtn');
    const originalHTML = btn.innerHTML;
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        const importData = Array.isArray(STATE.ui.validatedJson) 
            ? STATE.ui.validatedJson 
            : [STATE.ui.validatedJson];
        
        const results = {
            total: importData.length,
            added: [],
            updated: [],
            skipped: [],
            errors: []
        };
        
        // First, identify all duplicates
        const duplicates = [];
        const newVariants = [];
        
        importData.forEach((data, index) => {
            const name = data.variant_legacy_name;
            const existing = STATE.variants.find(v => 
                v.legacy_name && v.legacy_name.toLowerCase() === name.toLowerCase()
            );
            
            if (existing) {
                duplicates.push({
                    index,
                    name,
                    data,
                    existing
                });
            } else {
                newVariants.push({
                    index,
                    name,
                    data
                });
            }
        });
        
        // If there are duplicates, ask user for bulk action
        let duplicateAction = null;
        if (duplicates.length > 0) {
            if (duplicates.length === 1) {
                // Single duplicate - use existing prompt
                const shouldUpdate = await promptUserForDuplicateAction(duplicates[0].name, duplicates[0].existing);
                duplicateAction = shouldUpdate === 'update' ? 'update_all' : 'skip_all';
            } else {
                // Multiple duplicates - show bulk modal
                duplicateAction = await promptForBulkDuplicateAction(duplicates);
                
                if (duplicateAction === 'cancel') {
                    showNotification('Import cancelled', 'warning');
                    btn.disabled = false;
                    btn.innerHTML = originalHTML;
                    return;
                }
            }
        }
        
        // Process new variants (always added)
        for (const item of newVariants) {
            try {
                await insertNewVariant(item.data);
                results.added.push(item.name);
            } catch (error) {
                results.errors.push({
                    name: item.name,
                    reason: error.message
                });
            }
        }
        
        // Process duplicates based on selected action
        for (const dup of duplicates) {
            try {
                if (duplicateAction === 'skip_all') {
                    results.skipped.push(dup.name);
                    continue;
                }
                
                if (duplicateAction === 'update_all') {
                    await updateExistingVariant(dup.existing.id, dup.data, false);
                    results.updated.push(dup.name);
                    continue;
                }
                
                if (duplicateAction === 'merge_all') {
                    await updateExistingVariant(dup.existing.id, dup.data, true);
                    results.updated.push(dup.name);
                    continue;
                }
                
                if (duplicateAction === 'prompt') {
                    // Prompt for each one individually
                    const shouldUpdate = await promptUserForDuplicateAction(dup.name, dup.existing);
                    
                    if (shouldUpdate === 'update') {
                        await updateExistingVariant(dup.existing.id, dup.data, false);
                        results.updated.push(dup.name);
                    } else {
                        results.skipped.push(dup.name);
                    }
                }
            } catch (error) {
                results.errors.push({
                    name: dup.name,
                    reason: error.message
                });
            }
        }
        
        // Refresh data if any changes were made
        if (results.added.length > 0 || results.updated.length > 0) {
            buildSearchIndex();
            calculateMasterStats();
            
            STATE.view.filteredVariants = [...STATE.variants];
            STATE.view.dataViewMode = 'all';
            STATE.view.activeFilter = 'all';
            
            applyFilterChain();
        }
        
        showImportSummary(results);
        clearImportForm();
        
        if (importData.length === 1 && results.added.length === 1) {
            setTimeout(closeImportModal, 2500);
        }
        
        // Reset bulk decision
        bulkImportDecision = null;
        
    } catch (error) {
        console.error('âŒ Import failed:', error);
        showNotification(`Import failed: ${error.message}`, 'error');
    } finally {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
        STATE.ui.validatedJson = null;
    }
}

// Helper: Insert new variant
async function insertNewVariant(data) {
    const insertResponse = await fetch(`${CONFIG.SUPABASE.URL}/rest/v1/variants`, {
        method: 'POST',
        headers: {
            'apikey': CONFIG.SUPABASE.KEY,
            'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
        },
        body: JSON.stringify({
            legacy_name: data.variant_legacy_name,
            protein_name: data.variant_protein_name,
            cdna_name: data.variant_cDNA_name,
            final_determination: data.variant_final_determination,
            cftr_class: data.cftr_class || null,
            eti_prediction: data.eti_prediction || null,
            data_status: 'minimal',
            source_summary: 'Manual_JSON_Import',
            validation_count: 0,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        })
    });
    
    if (!insertResponse.ok) throw new Error(`HTTP ${insertResponse.status}`);
    
    const insertedData = await insertResponse.json();
    const savedVariant = insertedData[0];
    
    const newVariant = {
        id: savedVariant.id,
        legacy_name: savedVariant.legacy_name,
        protein_name: savedVariant.protein_name,
        cdna_name: savedVariant.cdna_name,
        final_determination: savedVariant.final_determination,
        cftr_class: savedVariant.cftr_class,
        eti_prediction: savedVariant.eti_prediction,
        class_subtype: savedVariant.class_subtype,
        class_confidence: savedVariant.class_confidence,
        data_status: savedVariant.data_status,
        source_summary: savedVariant.source_summary,
        validation_count: 0,
        created_at: savedVariant.created_at,
        updated_at: savedVariant.updated_at
    };
    
    STATE.variants.push(newVariant);
    STATE.variantsByLegacyName.set(newVariant.legacy_name, newVariant);
    STATE.variantsById.set(newVariant.id, newVariant);
}

// Helper: Update existing variant
async function updateExistingVariant(id, data, mergeMode = false) {
    if (mergeMode) {
        // Get current variant
        const current = STATE.variants.find(v => v.id === id);
        
        // Only update fields that are empty/null in current
        const updates = {};
        if (!current.protein_name && data.variant_protein_name) 
            updates.protein_name = data.variant_protein_name;
        if (!current.cdna_name && data.variant_cDNA_name) 
            updates.cdna_name = data.variant_cDNA_name;
        if (!current.final_determination && data.variant_final_determination) 
            updates.final_determination = data.variant_final_determination;
        if (!current.cftr_class && data.cftr_class) 
            updates.cftr_class = data.cftr_class;
        if (!current.eti_prediction && data.eti_prediction) 
            updates.eti_prediction = data.eti_prediction;
        
        if (Object.keys(updates).length === 0) {
            return; // Nothing to update
        }
        
        updates.updated_at = new Date().toISOString();
        
        await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/variants?id=eq.${id}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify(updates)
            }
        );
        
        // Update local state
        const index = STATE.variants.findIndex(v => v.id === id);
        if (index !== -1) {
            STATE.variants[index] = { ...STATE.variants[index], ...updates };
            STATE.variantsById.set(id, STATE.variants[index]);
            STATE.variantsByLegacyName.set(STATE.variants[index].legacy_name, STATE.variants[index]);
        }
        
    } else {
        // Overwrite mode - update all fields
        await updateVariantField(id, 'protein_name', data.variant_protein_name);
        await updateVariantField(id, 'cdna_name', data.variant_cDNA_name);
        await updateVariantField(id, 'final_determination', data.variant_final_determination);
        
        if (data.cftr_class) await updateVariantField(id, 'cftr_class', data.cftr_class);
        if (data.eti_prediction) await updateVariantField(id, 'eti_prediction', data.eti_prediction);
    }
}

async function promptUserForDuplicateAction(name, existingVariant) {
    return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.className = 'modal-overlay';
        modal.style.zIndex = '100000';
        
        modal.innerHTML = `
            <div class="modal" style="max-width: 500px;">
                <div class="modal-header">
                    <h3 class="heading-3 text-gray-900 flex items-center gap-2">
                        <i class="fas fa-exclamation-triangle text-[#b45309]"></i>
                        Duplicate Variant Detected
                    </h3>
                    <button onclick="this.closest('.modal-overlay').remove()" class="w-9 h-9 rounded-xl hover:bg-gray-200">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="bg-[#ffedd5] rounded-xl p-5 border border-[#b45309]/20">
                        <p class="text-sm font-medium text-[#b45309] mb-2">${escapeHTML(name)} already exists</p>
                        <div class="grid grid-cols-2 gap-3 mt-3 text-sm">
                            <div>
                                <p class="text-xs font-bold text-gray-500">Current Class:</p>
                                <p class="font-mono">${escapeHTML(existingVariant.cftr_class || 'Not set')}</p>
                            </div>
                            <div>
                                <p class="text-xs font-bold text-gray-500">Current ETI:</p>
                                <p class="font-mono">${escapeHTML(existingVariant.eti_prediction || 'Not set')}</p>
                            </div>
                        </div>
                    </div>
                    <p class="text-sm text-gray-700 mt-4 mb-4">How would you like to proceed?</p>
                </div>
                <div class="modal-footer">
                    <button onclick="this.closest('.modal-overlay').remove(); resolve('skip')" 
                            class="btn btn-secondary">
                        <i class="fas fa-ban mr-1"></i> Skip
                    </button>
                    <button onclick="this.closest('.modal-overlay').remove(); resolve('update')" 
                            class="btn btn-primary">
                        <i class="fas fa-sync-alt mr-1"></i> Update Existing
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        window.resolve = resolve;
    });
}

function showImportSummary(results) {
    const resultsDiv = document.getElementById('importResults');
    if (!resultsDiv) return;
    
    const hasSuccess = results.added.length > 0 || results.updated.length > 0;
    
    let summaryHtml = `
        <div class="bg-white rounded-xl p-5 border-2 ${hasSuccess ? 'border-[#0e7b4e]' : 'border-gray-200'} shadow-sm mt-4">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-xl ${hasSuccess ? 'bg-[#e3f9e9]' : 'bg-gray-100'} flex items-center justify-center">
                    <i class="fas ${hasSuccess ? 'fa-check-circle text-[#0e7b4e]' : 'fa-info-circle text-gray-600'}"></i>
                </div>
                <div>
                    <p class="font-bold text-gray-900">Import Summary</p>
                    <p class="text-xs text-gray-500">${results.total} variant(s) processed</p>
                </div>
            </div>
            
            <div class="space-y-2 text-sm">
                ${results.added.length > 0 ? `
                    <div class="flex items-center gap-2 text-[#0e7b4e]">
                        <i class="fas fa-plus-circle w-4"></i>
                        <span class="font-medium">Added:</span>
                        <span class="font-mono text-xs">${results.added.join(', ')}</span>
                    </div>
                ` : ''}
                
                ${results.updated.length > 0 ? `
                    <div class="flex items-center gap-2 text-[#0e7c7b]">
                        <i class="fas fa-sync-alt w-4"></i>
                        <span class="font-medium">Updated:</span>
                        <span class="font-mono text-xs">${results.updated.join(', ')}</span>
                    </div>
                ` : ''}
                
                ${results.skipped.length > 0 ? `
                    <div class="flex items-center gap-2 text-[#b45309]">
                        <i class="fas fa-ban w-4"></i>
                        <span class="font-medium">Skipped (already exist):</span>
                        <span class="font-mono text-xs">${results.skipped.join(', ')}</span>
                    </div>
                ` : ''}
                
                ${results.errors.length > 0 ? `
                    <div class="flex items-start gap-2 text-[#b91c1c]">
                        <i class="fas fa-exclamation-circle w-4 mt-0.5"></i>
                        <div>
                            <span class="font-medium">Errors:</span>
                            ${results.errors.map(e => `
                                <div class="text-xs mt-1">${escapeHTML(e.name)}: ${escapeHTML(e.reason)}</div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    const existing = resultsDiv.innerHTML;
    resultsDiv.innerHTML = existing + summaryHtml;
    
    if (results.total === 1) {
        if (results.added.length === 1) {
            showNotification(`âœ“ Added ${results.added[0]}`, 'success');
        } else if (results.updated.length === 1) {
            showNotification(`âœ“ Updated ${results.updated[0]}`, 'success');
        } else if (results.skipped.length === 1) {
            showNotification(`â­ï¸ Skipped ${results.skipped[0]} (already exists)`, 'warning');
        }
    } else {
        const totalSuccess = results.added.length + results.updated.length;
        if (totalSuccess > 0) {
            showNotification(`âœ“ Imported ${totalSuccess} of ${results.total} variants`, 'success', 5000);
        }
    }
}

async function updateVariantField(id, field, value) {
    const response = await fetch(
        `${CONFIG.SUPABASE.URL}/rest/v1/variants?id=eq.${id}`,
        {
            method: 'PATCH',
            headers: {
                'apikey': CONFIG.SUPABASE.KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=minimal'
            },
            body: JSON.stringify({ 
                [field]: value, 
                updated_at: new Date().toISOString() 
            })
        }
    );
    
    STATE.system.apiCalls++;
    
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    return true;
}

async function submitManualForm() {
    const name = document.getElementById('formLegacyName')?.value.trim();
    const prot = document.getElementById('formProteinName')?.value.trim();
    const cdna = document.getElementById('formCdnaName')?.value.trim();
    const det = document.getElementById('formDetermination')?.value;
    
    if (!name || !prot || !cdna || !det) {
        showNotification('Please fill all required fields', 'warning');
        return;
    }
    
    const c = document.getElementById('formClass')?.value || null;
    const sub = document.getElementById('formClassSubtype')?.value || null;
    const conf = document.getElementById('formConfidence')?.value || null;
    const eti = document.getElementById('formEtiResponse')?.value || null;
    const ev = document.getElementById('formEvidenceLevel')?.value || null;
    const rec = document.getElementById('formRecommendation')?.value.trim() || null;
    
    try {
        showNotification('Processing...', 'info', 2000);
        
        const exists = STATE.variants.find(v => v.legacy_name === name);
        
        if (exists) {
            await updateVariantField(exists.id, 'protein_name', prot);
            await updateVariantField(exists.id, 'cdna_name', cdna);
            await updateVariantField(exists.id, 'final_determination', det);
            if (c) await updateVariantField(exists.id, 'cftr_class', c);
            if (sub) await updateVariantField(exists.id, 'class_subtype', sub);
            if (conf) await updateVariantField(exists.id, 'class_confidence', conf);
            if (eti) await updateVariantField(exists.id, 'eti_prediction', eti);
            if (ev) await updateVariantField(exists.id, 'eti_evidence_level', ev);
            if (rec) await updateVariantField(exists.id, 'eti_recommendation', rec);
            
            showNotification(`âœ“ Updated ${name}`, 'success');
        } else {
            const newVariant = {
                id: STATE.variants.length + 1,
                legacy_name: name,
                protein_name: prot,
                cdna_name: cdna,
                final_determination: det,
                cftr_class: c,
                class_subtype: sub,
                class_confidence: conf,
                eti_prediction: eti,
                eti_evidence_level: ev,
                eti_recommendation: rec,
                data_status: 'minimal',
                source_summary: 'Manual_Form_Import',
                validation_count: 0,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString()
            };
            
            STATE.variants.push(newVariant);
            STATE.variantsByLegacyName.set(newVariant.legacy_name, newVariant);
            STATE.variantsById.set(newVariant.id, newVariant);
            
            showNotification(`âœ“ Added ${name}`, 'success');
        }
        
        buildSearchIndex();
        calculateMasterStats();
        STATE.view.filteredVariants = [...STATE.variants];
        applyFilterChain();
        
        clearManualForm();
        setTimeout(closeImportModal, 1500);
        
    } catch (error) {
        console.error('âŒ Save failed:', error);
        showNotification(`Save failed: ${error.message}`, 'error');
    }
}

// ========== BULK IMPORT ==========
function initializeBulkImport() {
    const drop = document.getElementById('dropZone');
    const file = document.getElementById('csvFileInput');
    
    if (!drop || !file) return;
    
    drop.addEventListener('click', () => file.click());
    
    drop.addEventListener('dragover', (e) => {
        e.preventDefault();
        drop.classList.add('border-[#0e7c7b]', 'bg-[#f0fdfa]');
    });
    
    drop.addEventListener('dragleave', (e) => {
        e.preventDefault();
        drop.classList.remove('border-[#0e7c7b]', 'bg-[#f0fdfa]');
    });
    
    drop.addEventListener('drop', (e) => {
        e.preventDefault();
        drop.classList.remove('border-[#0e7c7b]', 'bg-[#f0fdfa]');
        if (e.dataTransfer.files.length) {
            handleCSVFile(e.dataTransfer.files[0]);
        }
    });
    
    file.addEventListener('change', (e) => {
        if (e.target.files.length) {
            handleCSVFile(e.target.files[0]);
        }
    });
}

function handleCSVFile(file) {
    if (!file.name.endsWith('.csv')) {
        showNotification('Please upload a CSV file', 'error');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = async (e) => {
        try {
            showNotification(`ðŸ“„ Parsing ${file.name}...`, 'info', 2000);
            
            const content = e.target.result;
            const lines = content.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            
            const requiredHeaders = ['variant_legacy_name', 'variant_protein_name', 
                                   'variant_cDNA_name', 'variant_final_determination',
                                   'cftr_class', 'eti_prediction'];
            
            const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
            if (missingHeaders.length > 0) {
                throw new Error(`Missing columns: ${missingHeaders.join(', ')}`);
            }
            
            const variants = [];
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const values = lines[i].split('\t');
                const variant = {};
                
                headers.forEach((header, index) => {
                    variant[header] = values[index]?.trim() || '';
                });
                
                const missing = requiredHeaders.filter(f => !variant[f]);
                if (missing.length > 0) {
                    showNotification(`â­ï¸ Skipping row ${i + 1}: missing ${missing.join(', ')}`, 'warning', 3000);
                    continue;
                }
                
                variants.push(variant);
            }
            
            if (variants.length === 0) {
                throw new Error('No valid variants found in CSV');
            }
            
            STATE.ui.validatedJson = variants;
            
            const resultsDiv = document.getElementById('importResults');
            resultsDiv.innerHTML = `
                <div class="bg-[#e3f9e9] border-2 border-[#0e7b4e] rounded-xl p-5">
                    <p class="font-bold text-[#0e7b4e]">âœ“ CSV parsed successfully</p>
                    <p class="text-sm mt-1">
                        Found ${variants.length} variants ready to import
                    </p>
                </div>
            `;
            
            await executeJsonImport();
            
        } catch (error) {
            console.error('âŒ CSV parsing failed:', error);
            showNotification(`CSV import failed: ${error.message}`, 'error');
            
            const resultsDiv = document.getElementById('importResults');
            resultsDiv.innerHTML = `
                <div class="bg-[#fee2e2] border-2 border-[#b91c1c] rounded-xl p-5">
                    <p class="font-bold text-[#b91c1c]">âŒ CSV import failed</p>
                    <p class="text-sm mt-1">${escapeHTML(error.message)}</p>
                </div>
            `;
        }
    };
    
    reader.onerror = () => {
        showNotification('âŒ Failed to read file', 'error');
    };
    
    reader.readAsText(file);
}

function processBulkImport() {
    document.getElementById('csvFileInput')?.click();
}

function downloadTemplate() {
    const template = 'variant_legacy_name\tvariant_protein_name\tvariant_cDNA_name\tvariant_final_determination\tcftr_class\teti_prediction\n' +
                    'G542X\tp.Gly542X\tc.1624G>T\tCF-causing\tI\tresponsive\n' +
                    'F508del\tp.Phe508del\tc.1521_1523delCTT\tCF-causing\tII\tresponsive\n' +
                    'G551D\tp.Gly551Asp\tc.1652G>A\tCF-causing\tIII\tresponsive';
    
    const blob = new Blob([template], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'helix_import_template.csv';
    a.click();
    URL.revokeObjectURL(url);
    showNotification('âœ“ Template downloaded (TAB-separated)', 'success');
}

// ===================================================================
// ðŸ”§ UTILITIES - HELPERS, FORMATTERS, VALIDATORS
// ===================================================================

function hasMissingData(v) {
    return ['cftr_class', 'eti_prediction', 'final_determination'].some(f => !v[f]);
}

function countMissingFields(v) {
    return ['cftr_class', 'eti_prediction', 'final_determination', 'class_confidence']
        .filter(f => !v[f]).length;
}

function escapeHTML(s) {
    if (!s) return '';
    return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
}

function escapeRegExp(s) {
    return s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function safeSetText(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text;
}

function formatDate(dateString) {
    if (!dateString) return '';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch {
        return dateString;
    }
}
// ===================================================================
// ðŸ”— EVIDENCE SYSTEM FUNCTIONS
// ===================================================================
// ===================================================================
// ðŸ”— EVIDENCE SYSTEM - COMPLETE CRUD
// ===================================================================

let currentVariantId = null;
let currentVariantName = '';

function renderEvidencePreview(variant) {
    if (!variant.evidence_links || variant.evidence_links.length === 0) {
        return `
            <div class="text-center py-6">
                <div class="w-12 h-12 bg-[#6d28d9]/10 rounded-xl mx-auto mb-3 flex items-center justify-center">
                    <i class="fas fa-link text-xl text-[#6d28d9]/40"></i>
                </div>
                <p class="text-sm text-gray-500 mb-3">No evidence links yet</p>
                <button onclick="showEvidenceModal('${variant.legacy_name}', ${variant.id})" 
                        class="text-xs bg-[#6d28d9] text-white px-4 py-2 rounded-lg hover:bg-[#5b21b6] transition-all">
                    <i class="fas fa-plus mr-1"></i> Add First Link
                </button>
            </div>
        `;
    }
    
    // Show only first 3 links in preview
    const previewLinks = variant.evidence_links.slice(0, 3);
    
    return previewLinks.map(link => `
        <div class="group relative bg-white rounded-lg border border-gray-200 hover:border-[#6d28d9] hover:shadow-md transition-all duration-200 p-3">
            <div class="flex items-start gap-3">
                <!-- Icon -->
                <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-[#6d28d9]/10 to-[#6d28d9]/5 flex items-center justify-center flex-shrink-0 group-hover:scale-110 transition-transform">
                    <i class="fas ${getEvidenceIcon(link.type)} text-[#6d28d9] text-sm"></i>
                </div>
                
                <!-- Content -->
                <div class="flex-1 min-w-0">
                    <div class="flex items-start justify-between gap-2">
                        <div>
                            <h4 class="text-sm font-semibold text-gray-900 group-hover:text-[#6d28d9] transition-colors truncate max-w-[200px]">
                                ${escapeHTML(link.title)}
                            </h4>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs bg-[#6d28d9]/10 text-[#6d28d9] px-2 py-0.5 rounded-full">
                                    <i class="fas ${getEvidenceIcon(link.type)} mr-1"></i>${escapeHTML(link.source || link.type)}
                                </span>
                                <span class="text-xs text-gray-500">
                                    <i class="far fa-clock mr-1"></i>${formatDate(link.date_added)}
                                </span>
                            </div>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <a href="${escapeHTML(link.url)}" 
                               target="_blank"
                               class="w-7 h-7 rounded-lg hover:bg-gray-100 flex items-center justify-center text-gray-500 hover:text-[#6d28d9] transition-colors"
                               title="Open link">
                                <i class="fas fa-external-link-alt text-xs"></i>
                            </a>
                            <button onclick="copyToClipboard('${escapeHTML(link.url)}')"
                                    class="w-7 h-7 rounded-lg hover:bg-gray-100 flex items-center justify-center text-gray-500 hover:text-[#6d28d9] transition-colors"
                                    title="Copy link">
                                <i class="fas fa-copy text-xs"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- URL preview on hover -->
                    <div class="mt-2 hidden group-hover:block">
                        <div class="bg-gray-50 rounded-lg px-3 py-2 text-xs font-mono text-gray-500 truncate">
                            ðŸ”— ${escapeHTML(link.url)}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function getEvidenceIcon(type) {
    const icons = {
        'pubmed': 'fa-book-open',
        'cftr2': 'fa-dna',
        'clinvar': 'fa-clinic-medical',
        'article': 'fa-file-alt',
        'study': 'fa-flask',
        'guideline': 'fa-file-contract',
        'pdf': 'fa-file-pdf',
        'default': 'fa-link'
    };
    return icons[type?.toLowerCase()] || icons.default;
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        showNotification('âœ“ Link copied to clipboard', 'success');
    }).catch(() => {
        showNotification('âŒ Failed to copy', 'error');
    });
}

function showAllEvidence(variantId) {
    const variant = STATE.variantsById.get(variantId);
    if (!variant) return;
    
    currentVariantId = variantId;
    currentVariantName = variant.legacy_name;
    
    const modalList = document.getElementById('allEvidenceList');
    const evidence = variant.evidence_links || [];
    
    if (evidence.length === 0) {
        modalList.innerHTML = `
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-[#6d28d9]/10 rounded-2xl mx-auto mb-4 flex items-center justify-center">
                    <i class="fas fa-link text-3xl text-[#6d28d9]/40"></i>
                </div>
                <p class="text-gray-700 font-medium mb-2">No evidence links yet</p>
                <p class="text-sm text-gray-500 mb-6">Add your first evidence source</p>
                <button onclick="showEvidenceModal('${currentVariantName}', ${variantId}); closeAllEvidenceModal();" 
                        class="btn btn-primary bg-[#6d28d9] hover:bg-[#5b21b6]">
                    <i class="fas fa-plus mr-2"></i> Add Evidence
                </button>
            </div>
        `;
    } else {
        modalList.innerHTML = evidence.map(link => `
            <div class="group relative bg-white rounded-xl border border-gray-200 hover:border-[#6d28d9] hover:shadow-lg transition-all duration-200 mb-4 p-4">
                <div class="flex items-start gap-4">
                    <!-- Icon -->
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#6d28d9]/10 to-[#6d28d9]/5 flex items-center justify-center flex-shrink-0">
                        <i class="fas ${getEvidenceIcon(link.type)} text-[#6d28d9]"></i>
                    </div>
                    
                    <!-- Content -->
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <div>
                                <h4 class="font-semibold text-gray-900">${escapeHTML(link.title)}</h4>
                                <div class="flex items-center gap-3 mt-2">
                                    <span class="text-xs bg-[#6d28d9]/10 text-[#6d28d9] px-2 py-1 rounded-full">
                                        <i class="fas ${getEvidenceIcon(link.type)} mr-1"></i>
                                        ${escapeHTML(link.source || link.type)}
                                    </span>
                                    <span class="text-xs text-gray-500">
                                        <i class="far fa-clock mr-1"></i>${formatDate(link.date_added)}
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex items-center gap-2">
                                <a href="${escapeHTML(link.url)}" 
                                   target="_blank"
                                   class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center text-gray-500 hover:text-[#6d28d9] transition-colors"
                                   title="Open link">
                                    <i class="fas fa-external-link-alt"></i>
                                </a>
                                <button onclick="copyToClipboard('${escapeHTML(link.url)}')"
                                        class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center text-gray-500 hover:text-[#6d28d9] transition-colors"
                                        title="Copy link">
                                    <i class="fas fa-copy"></i>
                                </button>
                                <button onclick="deleteEvidence(${variantId}, ${link.id})"
                                        class="w-8 h-8 rounded-lg hover:bg-gray-100 flex items-center justify-center text-gray-500 hover:text-[#b91c1c] transition-colors"
                                        title="Delete">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- URL -->
                        <div class="mt-3 bg-gray-50 rounded-lg px-3 py-2 text-xs font-mono text-gray-500 truncate">
                            ðŸ”— ${escapeHTML(link.url)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    document.getElementById('allEvidenceModal').classList.remove('hidden');
}

function closeAllEvidenceModal() {
    document.getElementById('allEvidenceModal').classList.add('hidden');
}

// Show Add Evidence Modal
function showEvidenceModal(variantName, variantId) {
    currentVariantName = variantName;
    currentVariantId = variantId;
    
    // Reset form
    document.getElementById('evidenceVariantName').textContent = variantName;
    document.getElementById('evidenceTitle').value = '';
    document.getElementById('evidenceUrl').value = '';
    document.getElementById('evidenceSource').value = '';
    document.getElementById('evidenceNotes').value = '';
    document.getElementById('evidenceMessage').innerHTML = '';
    
    // Reset type buttons
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.remove('bg-[#6d28d9]', 'text-white', 'border-[#6d28d9]');
        btn.classList.add('border-gray-200');
    });
    document.getElementById('evidenceType').value = '';
    
    // Show modal
    document.getElementById('addEvidenceModal').classList.remove('hidden');
}

// Close Add Evidence Modal
function closeAddEvidenceModal() {
    document.getElementById('addEvidenceModal').classList.add('hidden');
}

// Select evidence type
function selectEvidenceType(type) {
    // Remove active class from all
    document.querySelectorAll('.type-btn').forEach(btn => {
        btn.classList.remove('bg-[#6d28d9]', 'text-white', 'border-[#6d28d9]');
        btn.classList.add('border-gray-200');
    });
    
    // Add active class to selected
    const selectedBtn = document.getElementById(`type-${type}`);
    if (selectedBtn) {
        selectedBtn.classList.remove('border-gray-200');
        selectedBtn.classList.add('bg-[#6d28d9]', 'text-white', 'border-[#6d28d9]');
    }
    
    document.getElementById('evidenceType').value = type;
}

// Save evidence link to database
async function saveEvidenceLink() {
    const type = document.getElementById('evidenceType').value;
    const title = document.getElementById('evidenceTitle').value.trim();
    const url = document.getElementById('evidenceUrl').value.trim();
    const source = document.getElementById('evidenceSource').value.trim();
    const notes = document.getElementById('evidenceNotes').value.trim();
    const messageDiv = document.getElementById('evidenceMessage');
    const btn = document.getElementById('saveEvidenceBtn');
    
    // Validate
    if (!type) {
        messageDiv.innerHTML = '<span class="text-[#b91c1c]">âŒ Please select a source type</span>';
        return;
    }
    if (!title) {
        messageDiv.innerHTML = '<span class="text-[#b91c1c]">âŒ Please enter a title</span>';
        return;
    }
    if (!url) {
        messageDiv.innerHTML = '<span class="text-[#b91c1c]">âŒ Please enter a URL</span>';
        return;
    }
    
    try {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        messageDiv.innerHTML = '<span class="text-[#6d28d9]">â³ Adding evidence...</span>';
        
        // Save to Supabase
        const response = await fetch(`${CONFIG.SUPABASE.URL}/rest/v1/evidence_links`, {
            method: 'POST',
            headers: {
                'apikey': CONFIG.SUPABASE.KEY,
                'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
            },
            body: JSON.stringify({
                variant_id: currentVariantId,
                type: type,
                title: title,
                url: url,
                source: source || type,
                notes: notes || null,
                date_added: new Date().toISOString()
            })
        });
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const newEvidence = await response.json();
        
        // Update local state
        const variant = STATE.variants.find(v => v.id === currentVariantId);
        if (variant) {
            if (!variant.evidence_links) variant.evidence_links = [];
            variant.evidence_links.push(newEvidence[0] || newEvidence);
        }
        
        // Refresh UI if this variant is selected
        if (STATE.view.selectedVariant?.id === currentVariantId) {
            renderVariantDetails(variant);
        }
        
        messageDiv.innerHTML = '<span class="text-[#0e7b4e]">âœ… Evidence added successfully!</span>';
        showNotification('âœ“ Evidence link added', 'success');
        
        // Close modal after success
        setTimeout(() => {
            closeAddEvidenceModal();
        }, 1500);
        
    } catch (error) {
        console.error('âŒ Failed to add evidence:', error);
        messageDiv.innerHTML = `<span class="text-[#b91c1c]">âŒ Error: ${error.message}</span>`;
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-save mr-1"></i> Save Evidence';
    }
}

// Delete evidence link
async function deleteEvidence(variantId, evidenceId) {
    if (!confirm('Are you sure you want to delete this evidence link?')) return;
    
    try {
        const response = await fetch(
            `${CONFIG.SUPABASE.URL}/rest/v1/evidence_links?id=eq.${evidenceId}`,
            {
                method: 'DELETE',
                headers: {
                    'apikey': CONFIG.SUPABASE.KEY,
                    'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`
                }
            }
        );
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        // Update local state
        const variant = STATE.variants.find(v => v.id === variantId);
        if (variant && variant.evidence_links) {
            variant.evidence_links = variant.evidence_links.filter(e => e.id !== evidenceId);
        }
        
        // Refresh UI if this variant is selected
        if (STATE.view.selectedVariant?.id === variantId) {
            renderVariantDetails(variant);
        }
        
        // Also close the all evidence modal if open
        closeAllEvidenceModal();
        
        showNotification('âœ“ Evidence link deleted', 'success');
        
    } catch (error) {
        console.error('âŒ Failed to delete evidence:', error);
        showNotification('Failed to delete evidence link', 'error');
    }
}
function getCurrentDate() {
    return new Date().toISOString().split('T')[0];
}

function showLoadingState(message) {
    const container = document.getElementById('variantList');
    if (!container) return;
    
    container.innerHTML = `
        <div class="p-12 text-center">
            <div class="relative mx-auto w-16 h-16">
                <div class="absolute inset-0 border-4 border-[#0e7c7b]/20 rounded-full"></div>
                <div class="absolute inset-0 border-4 border-[#0e7c7b] border-t-transparent rounded-full animate-spin"></div>
            </div>
            <p class="mt-5 text-gray-800 font-semibold text-lg">${escapeHTML(message)}</p>
            <p class="text-xs text-gray-500 mt-2">Loading 2,094 CFTR variants...</p>
        </div>
    `;
}

function showNotification(msg, type = 'info', duration = CONFIG.UI.NOTIFICATION_DURATION) {
    let container = document.getElementById('notification-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notification-container';
        container.className = 'fixed bottom-6 right-6 z-[99999] space-y-3';
        document.body.appendChild(container);
    }
    
    const styles = {
        success: { bg: '#e3f9e9', text: '#0e7b4e', border: '#0e7b4e', icon: 'fa-check-circle' },
        error: { bg: '#fee2e2', text: '#b91c1c', border: '#b91c1c', icon: 'fa-exclamation-circle' },
        warning: { bg: '#ffedd5', text: '#b45309', border: '#b45309', icon: 'fa-exclamation-triangle' },
        info: { bg: '#eff6ff', text: '#1e40af', border: '#1e40af', icon: 'fa-info-circle' }
    };
    
    const s = styles[type] || styles.info;
    
    const notification = document.createElement('div');
    notification.className = 'notification';
    notification.style.backgroundColor = s.bg;
    notification.style.color = s.text;
    notification.style.borderLeftColor = s.border;
    notification.innerHTML = `
        <i class="fas ${s.icon} text-lg"></i>
        <span class="text-sm font-semibold flex-1">${escapeHTML(msg)}</span>
        <button onclick="this.parentElement.remove()" class="ml-auto w-7 h-7 rounded-lg hover:bg-white/50">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    container.appendChild(notification);
    
    if (duration > 0) {
        setTimeout(() => notification.remove(), duration);
    }
}

// ===================================================================
// ðŸŽ¯ SEARCH INITIALIZATION - KEYBOARD SHORTCUTS
// ===================================================================

function initializeSearch() {
    const input = document.getElementById('searchInput');
    const clear = document.getElementById('searchClear');
    
    if (!input) return;
    
    input.placeholder = 'ðŸ” Search by name, cDNA, protein, class... (2,094 variants)';
    
    input.addEventListener('focus', function() {
        this.style.borderColor = '#b45309';
        this.style.boxShadow = '0 0 0 4px rgba(180,83,9,0.15)';
    });
    
    input.addEventListener('blur', function() {
        this.style.borderColor = '#e2e8f0';
        this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.02)';
    });
    
    input.addEventListener('input', function() {
        clearTimeout(STATE.ui.searchTimeout);
        if (clear) {
            if (this.value) {
                clear.classList.remove('hidden');
                clear.style.display = 'flex';
            } else {
                clear.classList.add('hidden');
            }
        }
        
        STATE.ui.searchTimeout = setTimeout(() => {
            STATE.view.searchQuery = this.value;
            applyFilterChain();
        }, CONFIG.UI.SEARCH_DELAY);
    });
    
    if (clear) {
        clear.addEventListener('click', function(e) {
            e.stopPropagation();
            input.value = '';
            input.focus();
            this.classList.add('hidden');
            STATE.view.searchQuery = '';
            applyFilterChain();
        });
    }
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            input.value = '';
            if (clear) clear.classList.add('hidden');
            STATE.view.searchQuery = '';
            applyFilterChain();
        }
        if (e.key === 'Enter' && input.value) {
            e.preventDefault();
            STATE.view.searchQuery = input.value;
            applyFilterChain();
        }
    });
    
    document.addEventListener('keydown', (e) => {
        if (e.key === '/' && !e.ctrlKey && !e.metaKey && 
            !e.target.matches('input, textarea, button')) {
            e.preventDefault();
            input.focus();
        }
    });
}

// ===================================================================
// ðŸŽ¬ EVENT LISTENERS - GLOBAL
// ===================================================================

function attachEventListeners() {
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeImportModal?.();
            closeDashboard?.();
            closeAnnotationModal?.();
            closeDeleteModal?.();
            closeValidationModal?.();
        }
    });
    
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeImportModal?.();
            closeDashboard?.();
            closeAnnotationModal?.();
            closeDeleteModal?.();
            closeValidationModal?.();
        }
    });
}

// ===================================================================
// ðŸš€ EXPOSE GLOBAL FUNCTIONS - FOR HTML ONCLICK
// ===================================================================

function exposeGlobals() {
    const globals = {
        selectVariant,
        filterVariants,
        quickSearch,
        clearSearch,
        setDataView,
        previousPage,
        nextPage,
        
        showImportModal,
        closeImportModal,
        switchImportTab,
        validateImport,
        executeJsonImport,
        submitManualForm,
        clearImportForm,
        clearManualForm,
        downloadTemplate,
        processBulkImport,
          
        showDashboard,
        closeDashboard,
        refreshDashboardStats,
        exportReport,
        exportFullReport,
        
        showAnnotationModal,
        closeAnnotationModal,
        saveAnnotation,
        
        showDeleteModal,
        closeDeleteModal,
        confirmDeleteVariant,
        
        // NEW VALIDATION FUNCTIONS
        showValidationModal,
        closeValidationModal,
        submitValidation,
        toggleValidationHistory,
        showExistingRoles,
        selectRole,
        // NEW EVIDENCE FUNCTIONS
        showAllEvidence,
        closeAllEvidenceModal,
        showEvidenceModal,
        deleteEvidence,
        copyToClipboard,
        closeAddEvidenceModal,
selectEvidenceType,
saveEvidenceLink,
        
        showNotification
    };
    
    Object.assign(window, globals);
    console.log('âœ… Global functions exposed');
}

// ===================================================================
// âš¡ INITIALIZATION - ENTRY POINT
// ===================================================================

async function initializeApp() {
    const startTime = performance.now();
    
    try {
        console.log(`ðŸš€ Î” Helix v${CONFIG.VERSION} initializing...`);
        
        showLoadingState('ðŸš€ Initializing Î” Helix Clinical Intelligence...');
        
        await loadVariants();
        
        attachEventListeners();
        initializeSearch();
        initializeBulkImport();
        exposeGlobals();
        
        setDataView('all');
        
        const initTime = (performance.now() - startTime).toFixed(0);
        console.log(`âœ… Î” Helix v${CONFIG.VERSION} initialized in ${initTime}ms`);
        console.log(`ðŸ“Š Master Stats - Class II: ${STATE.masterStats.classII}, Class III: ${STATE.masterStats.classIII}`);
        
    } catch (error) {
        console.error('âŒ Failed to initialize:', error);
        showNotification('âŒ Failed to initialize system', 'error');
        
        STATE.system.errorCount++;
        STATE.system.lastError = error;
    }
}

document.addEventListener('DOMContentLoaded', initializeApp);
</script>
</body>
</html>

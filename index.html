<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Δ Helix | CFTR Clinical Intelligence System — COMPLETE</title>
    
    <!-- Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Grotesk:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Tailwind (grid only) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* ===================================================================
           Δ HELIX DESIGN SYSTEM 5.0 — COMPLETE
           =================================================================== */
        
        :root {
            --color-primary: #0a2e5a;
            --color-primary-light: #1a4a7a;
            --color-primary-lighter: #e9f0f9;
            
            --color-accent: #0e7c7b;
            --color-accent-light: #d5f5f5;
            --color-accent-lighter: #f0fdfa;
            
            --color-class-i: #b91c1c;
            --color-class-i-light: #fee2e2;
            --color-class-ii: #b45309;
            --color-class-ii-light: #ffedd5;
            --color-class-iii: #0f766e;
            --color-class-iii-light: #ccfbf1;
            --color-class-iv: #1e40af;
            --color-class-iv-light: #dbeafe;
            --color-class-v: #6d28d9;
            --color-class-v-light: #ede9fe;
            
            --color-success: #0e7b4e;
            --color-success-light: #e3f9e9;
            --color-warning: #b45309;
            --color-warning-light: #ffedd5;
            --color-error: #b91c1c;
            --color-error-light: #fee2e2;
            
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            --font-display: 'Space Grotesk', var(--font-sans);
            --font-mono: 'JetBrains Mono', 'SF Mono', Monaco, 'Cascadia Code', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            font-size: 1rem;
            line-height: 1.6;
            color: #111827;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            -webkit-font-smoothing: antialiased;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 0.75rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.2s;
            overflow: hidden;
        }
        .card:hover { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .card-header {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .card-body { padding: 1.25rem; }

        /* Variant Pill */
        .variant-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1.25rem;
            background: linear-gradient(135deg, #059669 0%, #10b981 100%);
            border-radius: 100px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            width: fit-content;
        }
        .variant-pill:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(5, 150, 105, 0.35);
        }
        .variant-pill i {
            font-size: 1rem;
            color: white;
            margin-right: 0.75rem;
            opacity: 0.9;
        }
        .variant-pill-content {
            display: flex;
            flex-direction: column;
            color: white;
        }
        .variant-pill-primary {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.01em;
            line-height: 1.2;
        }
        .variant-pill-secondary {
            font-size: 0.75rem;
            opacity: 0.9;
            font-weight: 500;
        }

        /* Data Point */
        .data-point {
            position: relative;
            padding: 1rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }
        .data-point:hover {
            border-color: var(--color-accent);
            background: #f9fafb;
        }
        .data-point.missing {
            background: var(--color-warning-light);
            border-color: #fcd34d;
        }
        .data-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            margin-bottom: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .data-value {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            font-weight: 500;
            color: #111827;
            word-break: break-word;
        }
        .annotation-trigger {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 32px;
            height: 32px;
            border-radius: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
            z-index: 10;
            opacity: 1;
        }
        .annotation-trigger:hover {
            background: var(--color-accent);
            border-color: var(--color-accent);
            color: white;
            transform: scale(1.05);
        }
        .data-point.missing .annotation-trigger {
            background: #ffedd5;
            color: var(--color-warning);
            border-color: #fed7aa;
        }
        .data-point.missing .annotation-trigger:hover {
            background: var(--color-warning);
            color: white;
            border-color: var(--color-warning);
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.625rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            letter-spacing: 0.025em;
            text-transform: uppercase;
            border: 1px solid;
        }
        .badge-class-i { background: var(--color-class-i-light); color: var(--color-class-i); border-color: #fecaca; }
        .badge-class-ii { background: var(--color-class-ii-light); color: var(--color-class-ii); border-color: #fed7aa; }
        .badge-class-iii { background: var(--color-class-iii-light); color: var(--color-class-iii); border-color: #bbf7d0; }
        .badge-class-iv { background: var(--color-class-iv-light); color: var(--color-class-iv); border-color: #bfdbfe; }
        .badge-class-v { background: var(--color-class-v-light); color: var(--color-class-v); border-color: #ddd6fe; }
        .badge-exceptional {
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            color: #92400e;
            border-color: #fbbf24;
            border-width: 2px;
        }

        /* Variant List */
        .variant-list {
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        .variant-item {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
        }
        .variant-item:hover { background: #f9fafb; }
        .variant-item.selected {
            background: var(--color-accent-light);
            border-left: 3px solid var(--color-accent);
        }
        .variant-name {
            font-family: var(--font-display);
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            letter-spacing: -0.01em;
        }
        .variant-subtitle {
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .search-highlight {
            background: rgba(14, 124, 123, 0.15);
            padding: 0.125rem 0.25rem;
            border-radius: 4px;
            font-weight: 600;
            color: var(--color-accent);
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.25rem;
        }
        .view-toggle-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-radius: 0.375rem;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .view-toggle-btn.active {
            background: var(--color-accent);
            color: white;
        }
        .view-toggle-btn:not(.active):hover {
            background: #f3f4f6;
            color: #374151;
        }
        .view-count {
            background: rgba(255,255,255,0.2);
            padding: 0.125rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
        }
        .view-toggle-btn.active .view-count {
            background: rgba(255,255,255,0.3);
        }

        /* Search */
        .search-wrapper {
            position: relative;
        }
        .search-input {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            font-family: var(--font-sans);
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            transition: all 0.2s;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(14,124,123,0.1);
        }
        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }
        .search-clear {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            background: transparent;
            border: none;
            cursor: pointer;
        }
        .search-clear:hover { color: #4b5563; }

        /* Evidence Chain */
        .evidence-step {
            padding: 0.375rem 0.75rem;
            background: #f3f4f6;
            border-radius: 0.5rem;
            font-family: var(--font-mono);
            font-size: 0.75rem;
            color: #4b5563;
            border: 1px solid #e5e7eb;
        }
        .evidence-arrow {
            color: #d1d5db;
            font-size: 0.75rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        .modal {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);
            animation: modalSlideUp 0.3s ease;
        }
        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-body { padding: 1.5rem; }
        .modal-footer {
            padding: 1.25rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        /* Form */
        .form-group { margin-bottom: 1.25rem; }
        .form-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }
        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            font-family: var(--font-sans);
            font-size: 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            background: white;
            transition: all 0.2s;
        }
        .form-control:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(14,124,123,0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.5rem;
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            min-height: 40px;
        }
        .btn-primary {
            background: var(--color-accent);
            color: white;
        }
        .btn-primary:hover {
            background: var(--color-class-iii);
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn-secondary {
            background: white;
            border-color: #d1d5db;
            color: #374151;
        }
        .btn-secondary:hover {
            background: #f9fafb;
            border-color: #9ca3af;
        }
        .btn-secondary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-accent);
            color: var(--color-accent);
        }
        .btn-outline:hover {
            background: var(--color-accent);
            color: white;
        }
        .btn-sm { padding: 0.25rem 0.75rem; font-size: 0.75rem; min-height: 32px; }

        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            border: 2px solid rgba(0,0,0,0.1);
            border-radius: 50%;
            border-top-color: var(--color-accent);
            animation: spin 0.6s linear infinite;
        }
        .spinner-light {
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            padding: 1rem 1.5rem;
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            max-width: 400px;
            animation: slideIn 0.3s ease;
            border-left: 4px solid;
            z-index: 2000;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        .notification.success { border-left-color: var(--color-success); }
        .notification.error { border-left-color: var(--color-error); }
        .notification.warning { border-left-color: var(--color-warning); }
        .notification.info { border-left-color: var(--color-primary); }

        /* Missing Count */
        .missing-count {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 22px;
            height: 22px;
            border-radius: 9999px;
            background: var(--color-warning);
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0 0.375rem;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.5rem;
            margin-bottom: 1.25rem;
        }
        .tab {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #6b7280;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tab:hover {
            color: #111827;
            background: #f3f4f6;
        }
        .tab.active {
            color: var(--color-accent);
            background: var(--color-accent-light);
            font-weight: 600;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: inherit;
        }

        /* Utilities */
        .hidden { display: none !important; }
        .text-accent { color: var(--color-accent); }
        .bg-accent-light { background: var(--color-accent-light); }

        @media (max-width: 768px) {
            .variant-pill-primary { font-size: 1rem; }
            .variant-pill { padding: 0.375rem 1rem; }
            .view-toggle { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay (Global) -->
    <div id="globalLoadingOverlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[9999] hidden flex items-center justify-center">
        <div class="bg-white p-8 rounded-2xl shadow-2xl flex flex-col items-center">
            <div class="w-16 h-16 border-4 border-[#0e7c7b] border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg font-semibold text-gray-900" id="loadingMessage">Loading...</p>
            <p class="text-sm text-gray-500 mt-2">Please wait</p>
        </div>
    </div>

    <!-- ==================== HEADER ==================== -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-50" style="backdrop-filter: blur(10px); background: rgba(255,255,255,0.95);">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#0a2e5a] to-[#1a4a7a] flex items-center justify-center">
                        <i class="fas fa-dna text-white text-lg"></i>
                    </div>
                    <div>
                        <h1 class="font-['Space_Grotesk'] text-xl font-bold text-[#0a2e5a] leading-none">Δ Helix</h1>
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-500">CFTR Clinical Intelligence</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="UI.showDashboard()" class="btn btn-secondary hidden sm:flex">
                        <i class="fas fa-chart-line"></i> Analytics
                    </button>
                    <button onclick="UI.showImportModal()" class="btn btn-primary">
                        <i class="fas fa-cloud-upload-alt"></i> <span class="hidden sm:inline">Import</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- ==================== MAIN ==================== -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Grid -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Total Variants</p>
                            <p class="font-['Space_Grotesk'] text-3xl font-bold text-[#0a2e5a]" id="statTotal">—</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-[#e9f0f9] flex items-center justify-center">
                            <i class="fas fa-database text-[#0a2e5a]"></i>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2" id="statContext">All variants</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Class I</p>
                            <p class="font-['Space_Grotesk'] text-3xl font-bold text-[#b91c1c]" id="statClassI">—</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-[#fee2e2] flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle text-[#b91c1c]"></i>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2" id="classIPercentage">—% of view</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Exceptional</p>
                            <p class="font-['Space_Grotesk'] text-3xl font-bold text-[#b45309]" id="statExceptional">—</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-[#ffedd5] flex items-center justify-center">
                            <i class="fas fa-bolt text-[#b45309]"></i>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2" id="exceptionalPercentage">—% of Class I</div>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="flex items-start justify-between">
                        <div>
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">ETI Responsive</p>
                            <p class="font-['Space_Grotesk'] text-3xl font-bold text-[#0f766e]" id="statResponsive">—</p>
                        </div>
                        <div class="w-10 h-10 rounded-lg bg-[#ccfbf1] flex items-center justify-center">
                            <i class="fas fa-check-circle text-[#0f766e]"></i>
                        </div>
                    </div>
                    <div class="text-xs text-gray-400 mt-2" id="responsivePercentage">—% of total</div>
                </div>
            </div>
        </div>

        <!-- View Toggle -->
        <div class="card mb-8">
            <div class="card-body">
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-4">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">DATA VIEW</p>
                        <p class="font-['Space_Grotesk'] text-xl font-semibold text-gray-900" id="currentModeText">All Variants</p>
                    </div>
                    <div class="flex items-center gap-2 px-3 py-2 bg-gray-50 rounded-lg">
                        <i class="fas fa-database text-gray-400"></i>
                        <span class="text-sm font-medium text-gray-700">
                            <span id="databaseTotal">—</span> total variants
                        </span>
                    </div>
                </div>
                <div class="view-toggle">
                    <button onclick="View.setDataView('all')" class="view-toggle-btn active" id="allViewBtn">
                        <i class="fas fa-database"></i> All Variants
                        <span class="view-count" id="allCount">—</span>
                    </button>
                    <button onclick="View.setDataView('complete')" class="view-toggle-btn" id="completeViewBtn">
                        <i class="fas fa-check-circle"></i> Complete Clinical
                        <span class="view-count" id="completeCount">—</span>
                    </button>
                    <button onclick="View.setDataView('clinical')" class="view-toggle-btn" id="clinicalViewBtn">
                        <i class="fas fa-clipboard-check"></i> Clinical Data
                        <span class="view-count" id="clinicalCount">—</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- LEFT: Variant Explorer -->
            <div class="lg:col-span-3">
                <div class="card h-full flex flex-col relative" id="variantExplorerCard">
                    <div id="variantExplorerLoading" class="loading-overlay hidden">
                        <div class="spinner"></div>
                    </div>
                    <div class="card-header">
                        <i class="fas fa-list-ul text-[#0a2e5a]"></i> Variant Explorer
                    </div>
                    <div class="card-body flex-1">
                        <!-- Search -->
                        <div class="search-wrapper mb-4">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="searchInput" class="search-input" placeholder="Search by name, protein, cDNA..." autocomplete="off">
                            <button class="search-clear hidden" id="searchClear"><i class="fas fa-times"></i></button>
                        </div>
                        <!-- Quick Filters -->
                        <div class="flex gap-2 mb-4">
                            <button onclick="Filter.setFilter('all')" id="filterAll" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg border border-gray-200" style="border-color: #0e7c7b; color: #0e7c7b; font-weight: 600;">
                                <i class="fas fa-list-ul mr-1"></i>All
                            </button>
                            <button onclick="Filter.setFilter('missing')" id="filterMissing" class="flex-1 px-3 py-2 text-sm font-medium rounded-lg border border-gray-200 hover:border-[#b45309] hover:text-[#b45309] transition-all">
                                <i class="fas fa-exclamation-triangle mr-1"></i>Missing
                            </button>
                        </div>
                        <!-- Metadata -->
                        <div class="flex items-center justify-between text-xs border-t border-gray-100 pt-3">
                            <span class="text-gray-500">
                                <i class="fas fa-dna mr-1"></i>
                                <span id="variantCount" class="font-semibold text-gray-700">—</span> variants
                            </span>
                            <span id="viewBadge" class="px-2 py-1 bg-[#0e7c7b] text-white rounded-full text-xs font-medium">All</span>
                        </div>
                    </div>
                    <!-- Variant List -->
                    <div class="variant-list px-4 pb-4" id="variantList"></div>
                    <!-- Pagination -->
                    <div class="border-t border-gray-200 px-4 py-3 flex justify-between items-center" id="paginationControls" style="display: none;">
                        <button onclick="Pagination.previousPage()" class="btn btn-secondary btn-sm" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
                        <span class="text-sm text-gray-700">Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                        <button onclick="Pagination.nextPage()" class="btn btn-secondary btn-sm" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Variant Details -->
            <div class="lg:col-span-9">
                <div id="variantDetails" class="relative">
                    <div id="variantDetailsLoading" class="loading-overlay hidden">
                        <div class="spinner"></div>
                    </div>
                    <!-- Empty State -->
                    <div id="emptyState" class="card py-12">
                        <div class="text-center max-w-md mx-auto">
                            <div class="w-20 h-20 rounded-2xl bg-gradient-to-br from-[#0e7c7b]/10 to-[#0e7c7b]/5 mx-auto mb-6 flex items-center justify-center">
                                <i class="fas fa-dna text-4xl text-[#0e7c7b]"></i>
                            </div>
                            <h2 class="font-['Space_Grotesk'] text-2xl font-bold text-gray-900 mb-3">No Variant Selected</h2>
                            <p class="text-gray-600 mb-8">Select a variant from the list to view clinical intelligence.</p>
                            <div class="flex flex-wrap justify-center gap-2">
                                <button onclick="Variant.quickSearch('G542X')" class="btn btn-outline btn-sm">G542X</button>
                                <button onclick="Variant.quickSearch('F508del')" class="btn btn-outline btn-sm">F508del</button>
                                <button onclick="Variant.quickSearch('W1282X')" class="btn btn-outline btn-sm">W1282X</button>
                                <button onclick="Variant.quickSearch('R334W')" class="btn btn-outline btn-sm">R334W</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Import Modal -->
    <div id="importModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <div>
                    <h2 class="font-['Space_Grotesk'] text-xl font-semibold text-gray-900">Import Clinical Data</h2>
                    <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mt-1">Add new variants or update existing</p>
                </div>
                <button onclick="UI.closeImportModal()" class="w-8 h-8 rounded-lg hover:bg-gray-200 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <button id="jsonTabBtn" class="tab active" onclick="Import.switchTab('json')"><i class="fas fa-code"></i>JSON Import</button>
                    <button id="formTabBtn" class="tab" onclick="Import.switchTab('form')"><i class="fas fa-edit"></i>Manual Entry</button>
                </div>
                <!-- JSON Panel -->
                <div id="jsonImportPanel">
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-5">
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3 flex items-center gap-2">
                            <i class="fas fa-info-circle text-[#0e7c7b]"></i>Expected JSON Format
                        </p>
                        <pre class="font-mono text-xs bg-white p-3 rounded-lg border border-gray-200 overflow-x-auto">
{
  "variant_legacy_name": "G542X",
  "variant_protein_name": "p.Gly542X",
  "variant_cDNA_name": "c.1624G>T",
  "variant_final_determination": "CF-causing"
}</pre>
                    </div>
                    <div class="form-group">
                        <label class="form-label">JSON Data</label>
                        <textarea id="jsonInput" class="form-control font-mono" rows="6" placeholder='Paste JSON here...' spellcheck="false"></textarea>
                    </div>
                    <div id="importResults" class="space-y-3"></div>
                    <div class="flex justify-end gap-3">
                        <button onclick="Import.clearForm()" class="btn btn-secondary">Clear</button>
                        <button onclick="Import.validate()" class="btn btn-secondary">Validate</button>
                        <button onclick="Import.executeJson()" class="btn btn-primary" id="executeImportBtn" disabled>Import Data</button>
                    </div>
                </div>
                <!-- Form Panel -->
                <div id="formImportPanel" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Legacy Name *</label>
                            <input type="text" id="formLegacyName" class="form-control font-mono" placeholder="e.g., G542X">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Protein Name *</label>
                            <input type="text" id="formProteinName" class="form-control font-mono" placeholder="e.g., p.Gly542X">
                        </div>
                        <div class="form-group">
                            <label class="form-label">cDNA Name *</label>
                            <input type="text" id="formCdnaName" class="form-control font-mono" placeholder="e.g., c.1624G>T">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Determination *</label>
                            <select id="formDetermination" class="form-control">
                                <option value="">Select determination</option>
                                <option value="CF-causing">CF-causing</option>
                                <option value="Probably responsive to ETI">Probably responsive to ETI</option>
                                <option value="Variant of unknown significance">VUS</option>
                            </select>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mt-4">
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">Optional Clinical Data</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="form-label">CFTR Class</label>
                                <select id="formClass" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="I">Class I</option>
                                    <option value="II">Class II</option>
                                    <option value="III">Class III</option>
                                    <option value="IV">Class IV</option>
                                    <option value="V">Class V</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label">ETI Response</label>
                                <select id="formEtiResponse" class="form-control">
                                    <option value="">Not specified</option>
                                    <option value="responsive">Responsive</option>
                                    <option value="non_responsive">Non-responsive</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-3 mt-6">
                        <button onclick="Import.clearManualForm()" class="btn btn-secondary">Clear</button>
                        <button onclick="Import.submitManual()" class="btn btn-primary">Save Variant</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <span class="text-xs text-gray-500 flex-1"><i class="fas fa-shield-alt mr-1"></i>All data validated against clinical standards</span>
                <button onclick="UI.closeImportModal()" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Annotation Modal -->
    <div id="annotationModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <div>
                    <h3 class="font-['Space_Grotesk'] text-lg font-semibold text-gray-900" id="annotationTitle">Annotate Data</h3>
                    <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mt-1" id="annotationField"></p>
                </div>
                <button onclick="UI.closeAnnotationModal()" class="w-8 h-8 rounded-lg hover:bg-gray-200 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body" id="annotationContent"></div>
            <div class="modal-footer">
                <button onclick="UI.closeAnnotationModal()" class="btn btn-secondary">Cancel</button>
                <button onclick="Annotation.save()" class="btn btn-primary">Save Annotation</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Modal -->
    <div id="dashboardModal" class="modal-overlay hidden">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 class="font-['Space_Grotesk'] text-xl font-semibold text-gray-900">Δ Helix Analytics</h3>
                <button onclick="UI.closeDashboard()" class="w-8 h-8 rounded-lg hover:bg-gray-200 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="card">
                        <div class="card-body">
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">Classification Distribution</p>
                            <canvas id="classChart" height="200"></canvas>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-3">ETI Response Prediction</p>
                            <canvas id="responseChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="Report.exportCSV()" class="btn btn-primary">Export Report</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-6 right-6 z-[2000] space-y-2"></div>

    <script>
        // ===================================================================
        // Δ HELIX COMPLETE v6.0.0
        // Fully functional with all fixes applied
        // ===================================================================
        
        // ------------------------------------------------------------------
        // CONFIGURATION
        // ------------------------------------------------------------------
        const CONFIG = {
            SUPABASE: {
                URL: 'https://oxlkisjwfarseyqgeyuw.supabase.co',
                KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94bGtpc2p3ZmFyc2V5cWdleXV3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2NjU2MzgsImV4cCI6MjA4NjI0MTYzOH0.O3RSGW2eMF_M_kywWsjXK9DM0saxvtu9aQUu8-YPkdU'
            },
            UI: {
                ITEMS_PER_PAGE: 15,
                SEARCH_DELAY: 300,
                NOTIFICATION_DURATION: 4000
            },
            VERSION: '6.0.0-COMPLETE'
        };

        // ------------------------------------------------------------------
        // CORE STATE - COMPLETE
        // ------------------------------------------------------------------
        const STATE = {
            variants: [],
            filteredVariants: [],
            selectedVariant: null,
            
            activeFilter: 'all',
            currentPage: 1,
            searchQuery: '',
            dataViewMode: 'all',
            
            annotationContext: null,
            validatedJson: null,
            
            charts: {},
            searchTimeout: null,
            loadingCount: 0,
            
            databaseStats: {
                total: 0,
                complete: 0,
                clinical: 0,
                classI: 0,
                classII: 0,
                classIII: 0,
                classIV: 0,
                classV: 0,
                exceptional: 0,
                responsive: 0,
                nonResponsive: 0,
                unknown: 0
            }
        };

        // ------------------------------------------------------------------
        // DEMO DATA - COMPLETE
        // ------------------------------------------------------------------
        const DEMO_VARIANTS = [
            {
                id: 1,
                legacy_name: 'G542X',
                protein_name: 'p.Gly542X',
                cdna_name: 'c.1624G>T',
                final_determination: 'CF-causing',
                cftr_class: 'I',
                class_subtype: 'exceptional',
                eti_prediction: 'responsive',
                eti_evidence_level: 'High',
                therapy_responsive: true,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'ClinVar_CFTR2_Evidence'
            },
            {
                id: 2,
                legacy_name: 'F508del',
                protein_name: 'p.Phe508del',
                cdna_name: 'c.1521_1523delCTT',
                final_determination: 'CF-causing',
                cftr_class: 'II',
                class_subtype: 'standard',
                eti_prediction: 'responsive',
                eti_evidence_level: 'High',
                therapy_responsive: true,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'ClinVar_CFTR2'
            },
            {
                id: 3,
                legacy_name: 'W1282X',
                protein_name: 'p.Trp1282X',
                cdna_name: 'c.3846G>A',
                final_determination: 'CF-causing',
                cftr_class: 'I',
                class_subtype: 'true',
                eti_prediction: 'non_responsive',
                eti_evidence_level: 'Moderate',
                therapy_responsive: false,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'ClinVar'
            },
            {
                id: 4,
                legacy_name: 'R334W',
                protein_name: 'p.Arg334Trp',
                cdna_name: 'c.1000C>T',
                final_determination: 'CF-causing',
                cftr_class: 'IV',
                class_subtype: 'standard',
                eti_prediction: 'responsive',
                eti_evidence_level: 'High',
                therapy_responsive: true,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'CFTR2_ClinVar'
            },
            {
                id: 5,
                legacy_name: 'N1303K',
                protein_name: 'p.Asn1303Lys',
                cdna_name: 'c.3909C>G',
                final_determination: 'CF-causing',
                cftr_class: 'II',
                class_subtype: 'standard',
                eti_prediction: 'non_responsive',
                eti_evidence_level: 'Moderate',
                therapy_responsive: false,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'ClinVar'
            },
            {
                id: 6,
                legacy_name: 'G551D',
                protein_name: 'p.Gly551Asp',
                cdna_name: 'c.1652G>A',
                final_determination: 'CF-causing',
                cftr_class: 'III',
                class_subtype: 'standard',
                eti_prediction: 'responsive',
                eti_evidence_level: 'High',
                therapy_responsive: true,
                class_confidence: 'Confirmed',
                data_status: 'complete_clinical',
                source_summary: 'CFTR2_ClinVar'
            },
            {
                id: 7,
                legacy_name: 'E831X',
                protein_name: 'p.Glu831X',
                cdna_name: 'c.2491G>T',
                final_determination: 'Probably responsive to ETI',
                cftr_class: 'I',
                class_subtype: 'exceptional',
                eti_prediction: 'responsive',
                eti_evidence_level: 'High',
                therapy_responsive: true,
                class_confidence: 'High',
                data_status: 'complete_clinical',
                source_summary: 'CFTR2_2026_Bulk_Import'
            },
            {
                id: 8,
                legacy_name: 'R117H',
                protein_name: 'p.Arg117His',
                cdna_name: 'c.350G>A',
                final_determination: 'Variant of unknown significance',
                cftr_class: 'IV',
                class_subtype: 'standard',
                eti_prediction: 'unknown',
                eti_evidence_level: 'Low',
                therapy_responsive: null,
                class_confidence: 'Moderate',
                data_status: 'partial_clinical',
                source_summary: 'CFTR2'
            },
            {
                id: 9,
                legacy_name: '3849+10kbC>T',
                protein_name: 'p.??',
                cdna_name: 'c.3718-2477C>T',
                final_determination: 'CF-causing',
                cftr_class: 'V',
                class_subtype: 'standard',
                eti_prediction: 'unknown',
                eti_evidence_level: 'Low',
                therapy_responsive: null,
                class_confidence: 'Moderate',
                data_status: 'partial_clinical',
                source_summary: 'CFTR2'
            },
            {
                id: 10,
                legacy_name: '2789+5G>A',
                protein_name: 'p.??',
                cdna_name: 'c.2657+5G>A',
                final_determination: 'CF-causing',
                cftr_class: 'V',
                class_subtype: 'standard',
                eti_prediction: 'unknown',
                eti_evidence_level: 'Low',
                therapy_responsive: null,
                class_confidence: 'Moderate',
                data_status: 'partial_clinical',
                source_summary: 'CFTR2'
            }
        ];

        // ------------------------------------------------------------------
        // LOADING MANAGER
        // ------------------------------------------------------------------
        const LoadingManager = {
            showGlobal(message = 'Loading...') {
                const overlay = document.getElementById('globalLoadingOverlay');
                const msgEl = document.getElementById('loadingMessage');
                if (msgEl) msgEl.textContent = message;
                if (overlay) {
                    overlay.classList.remove('hidden');
                    STATE.loadingCount++;
                }
            },
            
            hideGlobal() {
                STATE.loadingCount = Math.max(0, STATE.loadingCount - 1);
                if (STATE.loadingCount === 0) {
                    const overlay = document.getElementById('globalLoadingOverlay');
                    if (overlay) overlay.classList.add('hidden');
                }
            },
            
            showExplorer() {
                const el = document.getElementById('variantExplorerLoading');
                if (el) el.classList.remove('hidden');
            },
            
            hideExplorer() {
                const el = document.getElementById('variantExplorerLoading');
                if (el) el.classList.add('hidden');
            },
            
            showDetails() {
                const el = document.getElementById('variantDetailsLoading');
                if (el) el.classList.remove('hidden');
            },
            
            hideDetails() {
                const el = document.getElementById('variantDetailsLoading');
                if (el) el.classList.add('hidden');
            }
        };

        // ------------------------------------------------------------------
        // DATABASE SERVICE
        // ------------------------------------------------------------------
        const DatabaseService = {
            async request(endpoint, options = {}) {
                try {
                    const url = `${CONFIG.SUPABASE.URL}/rest/v1/${endpoint}`;
                    const headers = {
                        'apikey': CONFIG.SUPABASE.KEY,
                        'Authorization': `Bearer ${CONFIG.SUPABASE.KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    };
                    
                    const response = await fetch(url, { ...options, headers });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    if (response.status === 204) return { data: null };
                    
                    const data = await response.json();
                    return { data, error: null };
                } catch (error) {
                    console.error('Database request failed:', error);
                    return { data: null, error };
                }
            },
            
            async loadVariants() {
                const { data, error } = await this.request('clinical_variants?select=*&order=legacy_name.asc');
                if (error) throw error;
                return data || [];
            },
            
            async loadStats() {
                const endpoints = [
                    { key: 'total', url: 'clinical_variants?select=count' },
                    { key: 'complete', url: 'clinical_variants?data_status=eq.complete_clinical&select=count' },
                    { key: 'clinical', url: 'clinical_variants?or=(data_status.eq.complete_clinical,data_status.eq.partial_clinical)&select=count' },
                    { key: 'classI', url: 'clinical_variants?cftr_class=eq.I&select=count' },
                    { key: 'classII', url: 'clinical_variants?cftr_class=eq.II&select=count' },
                    { key: 'classIII', url: 'clinical_variants?cftr_class=eq.III&select=count' },
                    { key: 'classIV', url: 'clinical_variants?cftr_class=eq.IV&select=count' },
                    { key: 'classV', url: 'clinical_variants?cftr_class=eq.V&select=count' },
                    { key: 'exceptional', url: 'clinical_variants?class_subtype=eq.exceptional&select=count' },
                    { key: 'responsive', url: 'clinical_variants?eti_prediction=eq.responsive&select=count' },
                    { key: 'nonResponsive', url: 'clinical_variants?eti_prediction=eq.non_responsive&select=count' },
                    { key: 'unknown', url: 'clinical_variants?eti_prediction=eq.unknown&select=count' }
                ];
                
                const results = await Promise.all(
                    endpoints.map(async e => {
                        const { data } = await this.request(e.url);
                        return { key: e.key, count: data?.[0]?.count || 0 };
                    })
                );
                
                const stats = {};
                results.forEach(r => { stats[r.key] = r.count; });
                return stats;
            },
            
            async upsertVariant(data) {
                if (!data.legacy_name || !data.protein_name || !data.cdna_name || !data.final_determination) {
                    throw new Error('Missing required fields');
                }
                
                const exists = STATE.variants.find(v => v.legacy_name === data.legacy_name);
                
                if (exists) {
                    const { error } = await this.request(
                        `clinical_variants?legacy_name=eq.${encodeURIComponent(data.legacy_name)}`,
                        {
                            method: 'PATCH',
                            body: JSON.stringify({ ...data, updated_at: new Date().toISOString() })
                        }
                    );
                    if (error) throw error;
                    return { status: 'updated' };
                } else {
                    const { error } = await this.request(
                        'clinical_variants',
                        {
                            method: 'POST',
                            body: JSON.stringify({ 
                                ...data, 
                                created_at: new Date().toISOString(), 
                                updated_at: new Date().toISOString() 
                            })
                        }
                    );
                    if (error) throw error;
                    return { status: 'created' };
                }
            },
            
            async updateField(legacyName, field, value) {
                const { error } = await this.request(
                    `clinical_variants?legacy_name=eq.${encodeURIComponent(legacyName)}`,
                    {
                        method: 'PATCH',
                        body: JSON.stringify({ [field]: value, updated_at: new Date().toISOString() })
                    }
                );
                if (error) throw error;
            },
            
            async deleteVariant(legacyName) {
                const { error } = await this.request(
                    `clinical_variants?legacy_name=eq.${encodeURIComponent(legacyName)}`,
                    { method: 'DELETE' }
                );
                if (error) throw error;
            }
        };

        // ------------------------------------------------------------------
        // VARIANT SERVICE
        // ------------------------------------------------------------------
        const VariantService = {
            async loadAll() {
                LoadingManager.showGlobal('Loading variant catalog...');
                try {
                    const variants = await DatabaseService.loadVariants();
                    STATE.variants = variants;
                    STATE.filteredVariants = [...variants];
                    Notification.show(`✓ Loaded ${variants.length} variants`, 'success');
                } catch (error) {
                    console.error('Failed to load variants, using demo data:', error);
                    STATE.variants = [...DEMO_VARIANTS];
                    STATE.filteredVariants = [...DEMO_VARIANTS];
                    Notification.show('⚠️ Using demo data - database connection failed', 'warning');
                } finally {
                    LoadingManager.hideGlobal();
                }
            },
            
            async refreshStats() {
                try {
                    const stats = await DatabaseService.loadStats();
                    STATE.databaseStats = { ...STATE.databaseStats, ...stats };
                } catch (error) {
                    console.warn('Failed to load stats, using local counts:', error);
                    this.updateLocalStats();
                }
                StatsUI.updateAll();
            },
            
            updateLocalStats() {
                const v = STATE.variants;
                STATE.databaseStats = {
                    total: v.length,
                    complete: v.filter(v => v.data_status === 'complete_clinical').length,
                    clinical: v.filter(v => v.data_status === 'complete_clinical' || v.data_status === 'partial_clinical').length,
                    classI: v.filter(v => v.cftr_class === 'I').length,
                    classII: v.filter(v => v.cftr_class === 'II').length,
                    classIII: v.filter(v => v.cftr_class === 'III').length,
                    classIV: v.filter(v => v.cftr_class === 'IV').length,
                    classV: v.filter(v => v.cftr_class === 'V').length,
                    exceptional: v.filter(v => v.class_subtype === 'exceptional').length,
                    responsive: v.filter(v => v.eti_prediction === 'responsive').length,
                    nonResponsive: v.filter(v => v.eti_prediction === 'non_responsive').length,
                    unknown: v.filter(v => v.eti_prediction === 'unknown').length
                };
            },
            
            hasMissingData(variant) {
                const critical = ['cftr_class', 'eti_prediction', 'final_determination'];
                return critical.some(f => !variant[f] || variant[f] === 'null' || variant[f] === 'undefined');
            },
            
            countMissingFields(variant) {
                let count = 0;
                if (!variant.cftr_class) count++;
                if (!variant.eti_prediction) count++;
                if (!variant.final_determination) count++;
                if (!variant.class_confidence) count++;
                return count;
            },
            
            async delete(legacyName) {
                if (!confirm(`Delete variant ${legacyName}? This action cannot be undone.`)) return false;
                
                LoadingManager.showGlobal(`Deleting ${legacyName}...`);
                try {
                    await DatabaseService.deleteVariant(legacyName);
                    
                    STATE.variants = STATE.variants.filter(v => v.legacy_name !== legacyName);
                    STATE.filteredVariants = STATE.filteredVariants.filter(v => v.legacy_name !== legacyName);
                    
                    if (STATE.selectedVariant?.legacy_name === legacyName) {
                        STATE.selectedVariant = null;
                        Renderer.showEmptyState();
                    }
                    
                    Notification.show(`✓ Deleted ${legacyName}`, 'success');
                    Filter.apply();
                    await this.refreshStats();
                    return true;
                } catch (error) {
                    Notification.show(`Delete failed: ${error.message}`, 'error');
                    return false;
                } finally {
                    LoadingManager.hideGlobal();
                }
            },
            
            async updateField(legacyName, field, value) {
                LoadingManager.showGlobal('Saving...');
                try {
                    await DatabaseService.updateField(legacyName, field, value);
                    
                    STATE.variants = STATE.variants.map(v => 
                        v.legacy_name === legacyName ? { ...v, [field]: value } : v
                    );
                    
                    if (STATE.selectedVariant?.legacy_name === legacyName) {
                        STATE.selectedVariant = { ...STATE.selectedVariant, [field]: value };
                        Renderer.renderVariantDetails(STATE.selectedVariant);
                    }
                    
                    Notification.show(`✓ ${field.replace(/_/g, ' ')} updated`, 'success');
                    Filter.apply();
                    await this.refreshStats();
                    return true;
                } catch (error) {
                    Notification.show(`Update failed: ${error.message}`, 'error');
                    return false;
                } finally {
                    LoadingManager.hideGlobal();
                }
            }
        };

        // ------------------------------------------------------------------
        // FILTER SERVICE
        // ------------------------------------------------------------------
        const Filter = {
            apply() {
                let filtered = [...STATE.variants];
                
                // Apply search
                if (STATE.searchQuery) {
                    const q = STATE.searchQuery.toLowerCase().trim();
                    filtered = filtered.filter(v => 
                        (v.legacy_name?.toLowerCase().includes(q)) ||
                        (v.protein_name?.toLowerCase().includes(q)) ||
                        (v.cdna_name?.toLowerCase().includes(q))
                    );
                }
                
                // Apply view mode
                if (STATE.dataViewMode === 'complete') {
                    filtered = filtered.filter(v => v.data_status === 'complete_clinical');
                } else if (STATE.dataViewMode === 'clinical') {
                    filtered = filtered.filter(v => v.data_status === 'complete_clinical' || v.data_status === 'partial_clinical');
                }
                
                // Apply missing filter
                if (STATE.activeFilter === 'missing') {
                    filtered = filtered.filter(v => VariantService.hasMissingData(v));
                }
                
                STATE.filteredVariants = filtered;
                STATE.currentPage = 1;
                
                Renderer.renderVariantList();
                Pagination.update();
                StatsUI.updateFromView();
                ViewCounts.update();
            },
            
            setFilter(filter) {
                STATE.activeFilter = filter;
                
                const allBtn = document.getElementById('filterAll');
                const missBtn = document.getElementById('filterMissing');
                
                if (allBtn && missBtn) {
                    if (filter === 'all') {
                        allBtn.style.borderColor = '#0e7c7b';
                        allBtn.style.color = '#0e7c7b';
                        allBtn.style.fontWeight = '600';
                        missBtn.style.borderColor = '#d1d5db';
                        missBtn.style.color = '#374151';
                        missBtn.style.fontWeight = '400';
                    } else {
                        allBtn.style.borderColor = '#d1d5db';
                        allBtn.style.color = '#374151';
                        allBtn.style.fontWeight = '400';
                        missBtn.style.borderColor = '#b45309';
                        missBtn.style.color = '#b45309';
                        missBtn.style.fontWeight = '600';
                    }
                }
                
                this.apply();
            }
        };

        // ------------------------------------------------------------------
        // RENDERER
        // ------------------------------------------------------------------
        const Renderer = {
            renderVariantList() {
                const container = document.getElementById('variantList');
                if (!container) return;
                
                const start = (STATE.currentPage - 1) * CONFIG.UI.ITEMS_PER_PAGE;
                const end = start + CONFIG.UI.ITEMS_PER_PAGE;
                const page = STATE.filteredVariants.slice(start, end);
                
                if (!page.length) {
                    container.innerHTML = `
                        <div class="p-8 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full mx-auto mb-4 flex items-center justify-center">
                                <i class="fas fa-dna text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-700 font-medium">No variants found</p>
                            <p class="text-sm text-gray-500 mt-2">
                                ${STATE.searchQuery ? 'Try adjusting your search terms' : 'No variants match current filters'}
                            </p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = page.map(v => {
                    const selected = STATE.selectedVariant?.id === v.id;
                    const missing = VariantService.countMissingFields(v);
                    
                    let displayName = Utils.escapeHTML(v.legacy_name || '');
                    if (STATE.searchQuery) {
                        const regex = new RegExp(`(${Utils.escapeRegExp(STATE.searchQuery)})`, 'gi');
                        displayName = displayName.replace(regex, '<span class="search-highlight">$1</span>');
                    }
                    
                    let badge = '';
                    if (v.cftr_class) {
                        badge = `<span class="badge badge-class-${v.cftr_class.toLowerCase()}">
                            <i class="fas fa-dna"></i>Class ${v.cftr_class}
                        </span>`;
                    } else if (v.class_subtype === 'exceptional') {
                        badge = `<span class="badge badge-exceptional">
                            <i class="fas fa-bolt"></i>Exceptional
                        </span>`;
                    }
                    
                    return `
                        <div class="variant-item ${selected ? 'selected' : ''}" onclick="Variant.select('${v.legacy_name}')">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <h4 class="variant-name">${displayName}</h4>
                                    ${v.protein_name ? `<p class="variant-subtitle">${Utils.escapeHTML(v.protein_name)}</p>` : ''}
                                </div>
                                ${badge}
                            </div>
                            <div class="flex justify-between items-center mt-2">
                                <span class="text-xs text-gray-600">${v.final_determination || 'Not specified'}</span>
                                ${missing ? `<span class="missing-count">${missing}</span>` : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            },
            
            renderVariantDetails(v) {
                if (!v) return;
                
                STATE.selectedVariant = v;
                const missing = VariantService.countMissingFields(v);
                const isExceptional = v.class_subtype === 'exceptional';
                const isResponsive = v.eti_prediction === 'responsive';
                
                let classColor = '#374151';
                if (v.cftr_class) {
                    if (isExceptional) classColor = '#b45309';
                    else if (v.cftr_class === 'I') classColor = '#b91c1c';
                    else if (v.cftr_class === 'II') classColor = '#b45309';
                    else if (v.cftr_class === 'III') classColor = '#0f766e';
                    else if (v.cftr_class === 'IV') classColor = '#1e40af';
                    else if (v.cftr_class === 'V') classColor = '#6d28d9';
                }
                
                const html = `
                    <div class="card mb-6">
                        <div class="card-body" style="background: linear-gradient(135deg, #f9fafb 0%, #ffffff 100%);">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="variant-pill">
                                            <i class="fas fa-dna"></i>
                                            <div class="variant-pill-content">
                                                <span class="variant-pill-primary">${Utils.escapeHTML(v.legacy_name)}</span>
                                                <span class="variant-pill-secondary">${Utils.escapeHTML(v.protein_name || 'No protein notation')}</span>
                                            </div>
                                        </div>
                                        ${missing ? 
                                            `<span class="badge" style="background: #ffedd5; color: #b45309; border-color: #fcd34d;">
                                                <i class="fas fa-exclamation-triangle"></i>${missing} missing
                                            </span>` : 
                                            `<span class="badge" style="background: #ccfbf1; color: #0f766e; border-color: #bbf7d0;">
                                                <i class="fas fa-check-circle"></i>Complete
                                            </span>`
                                        }
                                    </div>
                                    <div class="flex flex-wrap gap-2">
                                        ${v.cftr_class ? `
                                            <span class="badge badge-class-${v.cftr_class.toLowerCase()}">
                                                <i class="fas fa-dna"></i>Class ${v.cftr_class}${isExceptional ? ' • Exceptional' : ''}
                                            </span>
                                        ` : ''}
                                        ${v.eti_prediction ? `
                                            <span class="badge" style="background: ${isResponsive ? '#ccfbf1' : '#fee2e2'}; 
                                                color: ${isResponsive ? '#0f766e' : '#b91c1c'}; 
                                                border-color: ${isResponsive ? '#bbf7d0' : '#fecaca'};">
                                                <i class="fas ${isResponsive ? 'fa-check' : 'fa-times'}"></i>
                                                ETI ${isResponsive ? 'Responsive' : 'Non-responsive'}
                                            </span>
                                        ` : ''}
                                        ${v.final_determination === 'CF-causing' ? `
                                            <span class="badge" style="background: #fee2e2; color: #b91c1c; border-color: #fecaca;">
                                                <i class="fas fa-exclamation-triangle"></i>CF-causing
                                            </span>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 min-w-[160px]">
                                    <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-1">Classification</p>
                                    <p class="font-['Space_Grotesk'] text-2xl font-bold" style="color: ${classColor};">${v.cftr_class || '—'}</p>
                                    <p class="text-sm font-medium text-gray-700 mt-1">${isExceptional ? 'Exceptional Case' : v.cftr_class ? `Class ${v.cftr_class}` : 'Not classified'}</p>
                                    ${v.class_confidence ? `
                                        <p class="text-xs text-gray-500 mt-1">
                                            <i class="fas fa-shield-alt mr-1"></i>${v.class_confidence}
                                        </p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        ${this.createDataPoint('Legacy Name', v.legacy_name, 'legacy_name', v)}
                        ${this.createDataPoint('Protein Notation', v.protein_name, 'protein_name', v)}
                        ${this.createDataPoint('cDNA Notation', v.cdna_name, 'cdna_name', v)}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-stethoscope text-[#b91c1c]"></i> 
                                Clinical Impact
                                ${(!v.final_determination || !v.cftr_class) ? '<span class="missing-count text-xs ml-2">Missing</span>' : ''}
                            </div>
                            <div class="card-body">
                                <div class="space-y-3">
                                    ${this.createDataPoint('Determination', v.final_determination, 'final_determination', v)}
                                    ${this.createDataPoint('CFTR Class', v.cftr_class, 'cftr_class', v)}
                                    ${this.createDataPoint('Subtype', v.class_subtype, 'class_subtype', v)}
                                    ${this.createDataPoint('Confidence', v.class_confidence, 'class_confidence', v)}
                                </div>
                            </div>
                        </div>
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-prescription-bottle-alt text-[#0f766e]"></i> 
                                Therapeutic Prediction
                                ${!v.eti_prediction ? '<span class="missing-count text-xs ml-2">Missing</span>' : ''}
                            </div>
                            <div class="card-body">
                                <div class="space-y-3">
                                    ${this.createDataPoint('ETI Response', v.eti_prediction, 'eti_prediction', v)}
                                    ${this.createDataPoint('Responsive', v.therapy_responsive !== null ? (v.therapy_responsive ? 'Yes' : 'No') : null, 'therapy_responsive', v)}
                                    ${this.createDataPoint('Evidence Level', v.eti_evidence_level, 'eti_evidence_level', v)}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <i class="fas fa-microscope text-[#6d28d9]"></i> Evidence Chain
                        </div>
                        <div class="card-body">
                            ${v.source_summary ? `
                                <div class="flex flex-wrap items-center gap-2">
                                    ${v.source_summary.split('_').map((part, i) => `
                                        <span class="evidence-step">${Utils.escapeHTML(part)}</span>
                                        ${i < v.source_summary.split('_').length - 1 ? '<i class="fas fa-arrow-right evidence-arrow"></i>' : ''}
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="flex items-center gap-2">
                                    <p class="text-sm text-gray-500 italic">No evidence chain available</p>
                                    <button onclick="Annotation.show('${v.legacy_name}', 'source_summary', '')" 
                                            class="px-3 py-1.5 text-xs bg-[#0e7c7b] text-white rounded-lg hover:bg-[#0f766e]">
                                        <i class="fas fa-plus mr-1"></i>Add Source
                                    </button>
                                </div>
                            `}
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-end">
                        <button onclick="VariantService.delete('${v.legacy_name}')" 
                                class="px-4 py-2 text-xs font-medium text-red-600 bg-red-50 border border-red-200 rounded-lg hover:bg-red-100">
                            <i class="fas fa-trash-alt mr-1"></i>Delete Variant
                        </button>
                    </div>
                `;
                
                document.getElementById('variantDetails').innerHTML = html;
                document.getElementById('emptyState')?.classList.add('hidden');
            },
            
            createDataPoint(label, value, field, variant) {
                const missing = !value || value === 'null' || value === 'undefined';
                const display = missing ? 'Not specified' : Utils.escapeHTML(String(value));
                const escapedValue = value ? String(value).replace(/'/g, "\\'") : '';
                
                return `
                    <div class="data-point ${missing ? 'missing' : ''}">
                        <div class="annotation-trigger" 
                             onclick="Annotation.show('${variant.legacy_name}', '${field}', '${escapedValue}')" 
                             title="Annotate ${label}">
                            <i class="fas ${missing ? 'fa-plus' : 'fa-pencil-alt'}"></i>
                        </div>
                        <div class="data-label"><i class="fas fa-tag"></i>${label}</div>
                        <div class="data-value ${missing ? 'text-[#b45309]' : ''}">${display}</div>
                    </div>
                `;
            },
            
            showEmptyState() {
                const container = document.getElementById('variantDetails');
                if (container) {
                    container.innerHTML = document.getElementById('emptyState').outerHTML;
                }
            }
        };

        // ------------------------------------------------------------------
        // VARIANT SELECTION
        // ------------------------------------------------------------------
        const Variant = {
            select(name) {
                const v = STATE.variants.find(v => v.legacy_name === name);
                if (v) {
                    Renderer.renderVariantDetails(v);
                    Renderer.renderVariantList();
                }
            },
            
            quickSearch(name) {
                const input = document.getElementById('searchInput');
                if (input) {
                    input.value = name;
                    STATE.searchQuery = name;
                    Filter.apply();
                    setTimeout(() => this.select(name), 100);
                }
            }
        };

        // ------------------------------------------------------------------
        // VIEW CONTROLS
        // ------------------------------------------------------------------
        const View = {
            setDataView(mode) {
                if (STATE.dataViewMode === mode) return;
                
                STATE.dataViewMode = mode;
                
                ['all', 'complete', 'clinical'].forEach(m => {
                    document.getElementById(`${m}ViewBtn`)?.classList.toggle('active', m === mode);
                });
                
                const badge = document.getElementById('viewBadge');
                if (badge) {
                    const labels = { all: 'All', complete: 'Complete', clinical: 'Clinical' };
                    badge.textContent = labels[mode] || 'All';
                    badge.className = `px-2 py-1 rounded-full text-xs font-medium ${
                        mode === 'complete' ? 'bg-[#0e7c7b]' : 
                        mode === 'clinical' ? 'bg-[#0a2e5a]' : 'bg-gray-600'
                    } text-white`;
                }
                
                Filter.apply();
                
                const modeNames = { 
                    all: 'All Variants', 
                    complete: 'Complete Clinical Data', 
                    clinical: 'Clinical Data' 
                };
                document.getElementById('currentModeText').textContent = modeNames[mode];
            }
        };

        // ------------------------------------------------------------------
        // PAGINATION
        // ------------------------------------------------------------------
        const Pagination = {
            update() {
                const total = Math.ceil(STATE.filteredVariants.length / CONFIG.UI.ITEMS_PER_PAGE);
                const el = document.getElementById('paginationControls');
                
                if (!el) return;
                
                if (total > 1) {
                    el.style.display = 'flex';
                    document.getElementById('currentPage').textContent = STATE.currentPage;
                    document.getElementById('totalPages').textContent = total;
                    
                    const prevBtn = document.getElementById('prevBtn');
                    const nextBtn = document.getElementById('nextBtn');
                    
                    if (prevBtn) {
                        prevBtn.disabled = STATE.currentPage === 1;
                        prevBtn.style.opacity = STATE.currentPage === 1 ? '0.5' : '1';
                    }
                    
                    if (nextBtn) {
                        nextBtn.disabled = STATE.currentPage === total;
                        nextBtn.style.opacity = STATE.currentPage === total ? '0.5' : '1';
                    }
                } else {
                    el.style.display = 'none';
                }
            },
            
            previousPage() {
                if (STATE.currentPage > 1) {
                    STATE.currentPage--;
                    Renderer.renderVariantList();
                    this.update();
                }
            },
            
            nextPage() {
                const total = Math.ceil(STATE.filteredVariants.length / CONFIG.UI.ITEMS_PER_PAGE);
                if (STATE.currentPage < total) {
                    STATE.currentPage++;
                    Renderer.renderVariantList();
                    this.update();
                }
            }
        };

        // ------------------------------------------------------------------
        // SEARCH
        // ------------------------------------------------------------------
        const Search = {
            initialize() {
                const input = document.getElementById('searchInput');
                const clear = document.getElementById('searchClear');
                
                if (!input) return;
                
                input.addEventListener('input', () => {
                    clearTimeout(STATE.searchTimeout);
                    clear?.classList.toggle('hidden', !input.value);
                    
                    STATE.searchTimeout = setTimeout(() => {
                        STATE.searchQuery = input.value;
                        STATE.currentPage = 1;
                        Filter.apply();
                    }, CONFIG.UI.SEARCH_DELAY);
                });
                
                clear?.addEventListener('click', () => {
                    input.value = '';
                    clear.classList.add('hidden');
                    STATE.searchQuery = '';
                    Filter.apply();
                    input.focus();
                });
                
                input.addEventListener('keydown', e => {
                    if (e.key === 'Escape') {
                        input.value = '';
                        clear?.classList.add('hidden');
                        STATE.searchQuery = '';
                        Filter.apply();
                    }
                });
            }
        };

        // ------------------------------------------------------------------
        // ANNOTATION
        // ------------------------------------------------------------------
        const Annotation = {
            show(name, field, current) {
                const variant = STATE.variants.find(v => v.legacy_name === name);
                if (!variant) {
                    Notification.show('Variant not found', 'error');
                    return;
                }
                
                STATE.annotationContext = { variant, field, currentValue: current };
                
                const labels = {
                    'legacy_name': 'Legacy Name',
                    'protein_name': 'Protein',
                    'cdna_name': 'cDNA',
                    'final_determination': 'Clinical Impact',
                    'cftr_class': 'CFTR Class',
                    'class_subtype': 'Subtype',
                    'class_confidence': 'Confidence',
                    'eti_prediction': 'ETI Response',
                    'eti_evidence_level': 'Evidence Level',
                    'therapy_responsive': 'Therapy Responsive',
                    'source_summary': 'Evidence Source'
                };
                
                document.getElementById('annotationTitle').textContent = `Annotate ${name}`;
                document.getElementById('annotationField').textContent = labels[field] || field;
                
                let input = '';
                
                if (field === 'cftr_class') {
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="I" ${current === 'I' ? 'selected' : ''}>Class I</option>
                            <option value="II" ${current === 'II' ? 'selected' : ''}>Class II</option>
                            <option value="III" ${current === 'III' ? 'selected' : ''}>Class III</option>
                            <option value="IV" ${current === 'IV' ? 'selected' : ''}>Class IV</option>
                            <option value="V" ${current === 'V' ? 'selected' : ''}>Class V</option>
                        </select>
                    `;
                } else if (field === 'class_subtype') {
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="standard" ${current === 'standard' ? 'selected' : ''}>Standard</option>
                            <option value="exceptional" ${current === 'exceptional' ? 'selected' : ''}>Exceptional</option>
                            <option value="true" ${current === 'true' ? 'selected' : ''}>True Class I</option>
                        </select>
                    `;
                } else if (field === 'eti_prediction') {
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="responsive" ${current === 'responsive' ? 'selected' : ''}>Responsive</option>
                            <option value="non_responsive" ${current === 'non_responsive' ? 'selected' : ''}>Non-responsive</option>
                            <option value="unknown" ${current === 'unknown' ? 'selected' : ''}>Unknown</option>
                        </select>
                    `;
                } else if (field === 'therapy_responsive') {
                    const bool = current === true || current === 'true';
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="true" ${bool ? 'selected' : ''}>Yes</option>
                            <option value="false" ${current === false || current === 'false' ? 'selected' : ''}>No</option>
                        </select>
                    `;
                } else if (field === 'class_confidence' || field === 'eti_evidence_level') {
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="High" ${current === 'High' ? 'selected' : ''}>High</option>
                            <option value="Moderate" ${current === 'Moderate' ? 'selected' : ''}>Moderate</option>
                            <option value="Low" ${current === 'Low' ? 'selected' : ''}>Low</option>
                            <option value="Confirmed" ${current === 'Confirmed' ? 'selected' : ''}>Confirmed</option>
                        </select>
                    `;
                } else if (field === 'final_determination') {
                    input = `
                        <select id="annotationValue" class="form-control">
                            <option value="">Select</option>
                            <option value="CF-causing" ${current === 'CF-causing' ? 'selected' : ''}>CF-causing</option>
                            <option value="Probably responsive to ETI" ${current === 'Probably responsive to ETI' ? 'selected' : ''}>Probably responsive to ETI</option>
                            <option value="Variant of unknown significance" ${current === 'Variant of unknown significance' ? 'selected' : ''}>VUS</option>
                        </select>
                    `;
                } else {
                    input = `<textarea id="annotationValue" class="form-control font-mono" rows="3">${Utils.escapeHTML(current || '')}</textarea>`;
                }
                
                document.getElementById('annotationContent').innerHTML = `
                    <div class="bg-gray-50 rounded-lg p-4 mb-4 border border-gray-200">
                        <p class="text-xs font-semibold uppercase tracking-wider text-gray-500 mb-2">Current Value</p>
                        <p class="font-mono text-sm ${!current ? 'text-gray-400 italic' : ''}">
                            ${current ? Utils.escapeHTML(String(current)) : 'Not specified'}
                        </p>
                    </div>
                    <div class="form-group">
                        <label class="form-label">${labels[field] || field}</label>
                        ${input}
                    </div>
                `;
                
                document.getElementById('annotationModal').classList.remove('hidden');
            },
            
            close() {
                document.getElementById('annotationModal').classList.add('hidden');
                STATE.annotationContext = null;
            },
            
            async save() {
                if (!STATE.annotationContext) {
                    Notification.show('No annotation context', 'error');
                    return;
                }
                
                const { variant, field } = STATE.annotationContext;
                const input = document.getElementById('annotationValue');
                
                if (!input) {
                    Notification.show('Input field not found', 'error');
                    return;
                }
                
                let newValue = input.value;
                if (field === 'therapy_responsive') {
                    newValue = newValue === 'true';
                }
                
                const success = await VariantService.updateField(variant.legacy_name, field, newValue);
                if (success) {
                    this.close();
                }
            }
        };

        // ------------------------------------------------------------------
        // IMPORT
        // ------------------------------------------------------------------
        const Import = {
            switchTab(tab) {
                const jt = document.getElementById('jsonTabBtn');
                const ft = document.getElementById('formTabBtn');
                const jp = document.getElementById('jsonImportPanel');
                const fp = document.getElementById('formImportPanel');
                
                if (tab === 'json') {
                    jt?.classList.add('active');
                    ft?.classList.remove('active');
                    jp?.classList.remove('hidden');
                    fp?.classList.add('hidden');
                } else {
                    jt?.classList.remove('active');
                    ft?.classList.add('active');
                    jp?.classList.add('hidden');
                    fp?.classList.remove('hidden');
                }
            },
            
            clearForm() {
                document.getElementById('jsonInput').value = '';
                document.getElementById('importResults').innerHTML = '';
                document.getElementById('executeImportBtn').disabled = true;
                STATE.validatedJson = null;
            },
            
            clearManualForm() {
                ['formLegacyName', 'formProteinName', 'formCdnaName', 'formDetermination', 'formClass', 'formEtiResponse'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.value = '';
                });
            },
            
            validate() {
                const input = document.getElementById('jsonInput');
                const results = document.getElementById('importResults');
                const btn = document.getElementById('executeImportBtn');
                
                try {
                    const d = JSON.parse(input.value.trim());
                    const required = ['variant_legacy_name', 'variant_protein_name', 'variant_cDNA_name', 'variant_final_determination'];
                    const missing = required.filter(f => !d[f]);
                    
                    if (missing.length) throw new Error(`Missing: ${missing.join(', ')}`);
                    
                    STATE.validatedJson = d;
                    
                    results.innerHTML = `
                        <div class="bg-[#e3f9e9] border border-[#0e7b4e] rounded-lg p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-[#0e7b4e]/10 flex items-center justify-center">
                                    <i class="fas fa-check-circle text-[#0e7b4e]"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-[#0e7b4e]">✓ Valid JSON</p>
                                    <p class="text-sm text-gray-700 mt-1">Ready to import: <span class="font-mono font-medium">${d.variant_legacy_name}</span></p>
                                </div>
                            </div>
                        </div>
                    `;
                    btn.disabled = false;
                } catch(e) {
                    results.innerHTML = `
                        <div class="bg-[#fee2e2] border border-[#b91c1c] rounded-lg p-4">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-[#b91c1c]/10 flex items-center justify-center">
                                    <i class="fas fa-exclamation-circle text-[#b91c1c]"></i>
                                </div>
                                <div>
                                    <p class="font-medium text-[#b91c1c]">Invalid JSON</p>
                                    <p class="text-sm text-gray-700 mt-1">${Utils.escapeHTML(e.message)}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    btn.disabled = true;
                    STATE.validatedJson = null;
                }
            },
            
            async executeJson() {
                if (!STATE.validatedJson) {
                    Notification.show('Validate JSON first', 'warning');
                    return;
                }
                
                const d = STATE.validatedJson;
                
                try {
                    await DatabaseService.upsertVariant({
                        legacy_name: d.variant_legacy_name,
                        protein_name: d.variant_protein_name,
                        cdna_name: d.variant_cDNA_name,
                        final_determination: d.variant_final_determination,
                        data_status: 'partial_clinical'
                    });
                    
                    Notification.show(`✓ Imported ${d.variant_legacy_name}`, 'success');
                    
                    await VariantService.loadAll();
                    await VariantService.refreshStats();
                    Filter.apply();
                    this.clearForm();
                    
                    setTimeout(() => UI.closeImportModal(), 1500);
                } catch(e) {
                    Notification.show(`Import failed: ${e.message}`, 'error');
                }
            },
            
            async submitManual() {
                const legacy = document.getElementById('formLegacyName')?.value.trim();
                const protein = document.getElementById('formProteinName')?.value.trim();
                const cdna = document.getElementById('formCdnaName')?.value.trim();
                const det = document.getElementById('formDetermination')?.value;
                
                if (!legacy || !protein || !cdna || !det) {
                    Notification.show('Required fields missing', 'warning');
                    return;
                }
                
                try {
                    await DatabaseService.upsertVariant({
                        legacy_name: legacy,
                        protein_name: protein,
                        cdna_name: cdna,
                        final_determination: det,
                        cftr_class: document.getElementById('formClass')?.value || null,
                        eti_prediction: document.getElementById('formEtiResponse')?.value || null,
                        data_status: 'partial_clinical'
                    });
                    
                    Notification.show(`✓ Saved ${legacy}`, 'success');
                    
                    await VariantService.loadAll();
                    await VariantService.refreshStats();
                    Filter.apply();
                    this.clearManualForm();
                    
                    setTimeout(() => UI.closeImportModal(), 1500);
                } catch(e) {
                    Notification.show(`Save failed: ${e.message}`, 'error');
                }
            }
        };

        // ------------------------------------------------------------------
        // UI CONTROLS
        // ------------------------------------------------------------------
        const UI = {
            showImportModal() {
                document.getElementById('importModal').classList.remove('hidden');
                Import.switchTab('json');
            },
            
            closeImportModal() {
                document.getElementById('importModal').classList.add('hidden');
                Import.clearForm();
                Import.clearManualForm();
            },
            
            showDashboard() {
                document.getElementById('dashboardModal').classList.remove('hidden');
                Charts.render();
            },
            
            closeDashboard() {
                document.getElementById('dashboardModal').classList.add('hidden');
            },
            
            closeAnnotationModal() {
                Annotation.close();
            }
        };

        // ------------------------------------------------------------------
        // CHARTS
        // ------------------------------------------------------------------
        const Charts = {
            render() {
                setTimeout(() => {
                    this.renderClassChart();
                    this.renderResponseChart();
                }, 100);
            },
            
            renderClassChart() {
                const ctx = document.getElementById('classChart');
                if (!ctx) return;
                
                if (STATE.charts.classChart) STATE.charts.classChart.destroy();
                
                STATE.charts.classChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Class I', 'Class II', 'Class III', 'Class IV', 'Class V'],
                        datasets: [{
                            data: [
                                STATE.databaseStats.classI || 0,
                                STATE.databaseStats.classII || 0,
                                STATE.databaseStats.classIII || 0,
                                STATE.databaseStats.classIV || 0,
                                STATE.databaseStats.classV || 0
                            ],
                            backgroundColor: ['#b91c1c', '#b45309', '#0f766e', '#1e40af', '#6d28d9'],
                            borderWidth: 3,
                            borderColor: 'white'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom', labels: { font: { size: 11 } } }
                        },
                        cutout: '60%'
                    }
                });
            },
            
            renderResponseChart() {
                const ctx = document.getElementById('responseChart');
                if (!ctx) return;
                
                if (STATE.charts.responseChart) STATE.charts.responseChart.destroy();
                
                STATE.charts.responseChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Responsive', 'Non-responsive', 'Unknown'],
                        datasets: [{
                            label: 'Variants',
                            data: [
                                STATE.databaseStats.responsive || 0,
                                STATE.databaseStats.nonResponsive || 0,
                                STATE.databaseStats.unknown || 0
                            ],
                            backgroundColor: ['#0f766e', '#b91c1c', '#b45309'],
                            borderRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        scales: {
                            y: { 
                                beginAtZero: true,
                                grid: { color: '#f3f4f6' }
                            }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            }
        };

        // ------------------------------------------------------------------
        // REPORT
        // ------------------------------------------------------------------
        const Report = {
            exportCSV() {
                const headers = ['Legacy Name', 'Protein', 'cDNA', 'Determination', 'CFTR Class', 'Subtype', 'ETI Response', 'Evidence Level', 'Responsive', 'Confidence', 'Source'];
                const rows = STATE.variants.map(v => [
                    v.legacy_name || '',
                    v.protein_name || '',
                    v.cdna_name || '',
                    v.final_determination || '',
                    v.cftr_class || '',
                    v.class_subtype || '',
                    v.eti_prediction || '',
                    v.eti_evidence_level || '',
                    v.therapy_responsive !== null ? (v.therapy_responsive ? 'Yes' : 'No') : '',
                    v.class_confidence || '',
                    v.source_summary || ''
                ]);
                
                const csv = [headers, ...rows].map(row => 
                    row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',')
                ).join('\n');
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `helix-export-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                Notification.show('Report exported successfully', 'success');
            }
        };

        // ------------------------------------------------------------------
        // STATS UI
        // ------------------------------------------------------------------
        const StatsUI = {
            updateAll() {
                const s = STATE.databaseStats;
                
                Utils.setText('statTotal', s.total.toLocaleString());
                Utils.setText('statClassI', s.classI.toLocaleString());
                Utils.setText('statExceptional', s.exceptional.toLocaleString());
                Utils.setText('statResponsive', s.responsive.toLocaleString());
                Utils.setText('databaseTotal', s.total.toLocaleString());
                Utils.setText('allCount', s.total.toLocaleString());
                Utils.setText('completeCount', s.complete.toLocaleString());
                Utils.setText('clinicalCount', s.clinical.toLocaleString());
                
                if (s.total > 0) {
                    Utils.setText('classIPercentage', ((s.classI / s.total) * 100).toFixed(1) + '%');
                    Utils.setText('responsivePercentage', ((s.responsive / s.total) * 100).toFixed(1) + '%');
                }
                if (s.classI > 0) {
                    Utils.setText('exceptionalPercentage', ((s.exceptional / s.classI) * 100).toFixed(1) + '%');
                }
            },
            
            updateFromView() {
                const f = STATE.filteredVariants;
                
                Utils.setText('statTotal', f.length.toLocaleString());
                Utils.setText('statClassI', f.filter(v => v.cftr_class === 'I').length.toLocaleString());
                Utils.setText('statExceptional', f.filter(v => v.class_subtype === 'exceptional').length.toLocaleString());
                Utils.setText('statResponsive', f.filter(v => v.eti_prediction === 'responsive').length.toLocaleString());
                Utils.setText('variantCount', f.length.toLocaleString());
            }
        };

        // ------------------------------------------------------------------
        // VIEW COUNTS
        // ------------------------------------------------------------------
        const ViewCounts = {
            update() {
                const all = STATE.variants.length;
                const comp = STATE.variants.filter(v => v.data_status === 'complete_clinical').length;
                const clin = STATE.variants.filter(v => v.data_status === 'complete_clinical' || v.data_status === 'partial_clinical').length;
                
                Utils.setText('allCount', all.toLocaleString());
                Utils.setText('completeCount', comp.toLocaleString());
                Utils.setText('clinicalCount', clin.toLocaleString());
            }
        };

        // ------------------------------------------------------------------
        // NOTIFICATION
        // ------------------------------------------------------------------
        const Notification = {
            show(message, type = 'info', duration = CONFIG.UI.NOTIFICATION_DURATION) {
                let container = document.getElementById('notification-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'notification-container';
                    container.className = 'fixed bottom-6 right-6 z-[2000] space-y-2';
                    document.body.appendChild(container);
                }
                
                const styles = {
                    success: { bg: '#e3f9e9', text: '#0e7b4e', border: '#0e7b4e', icon: 'fa-check-circle' },
                    error: { bg: '#fee2e2', text: '#b91c1c', border: '#b91c1c', icon: 'fa-exclamation-circle' },
                    warning: { bg: '#ffedd5', text: '#b45309', border: '#b45309', icon: 'fa-exclamation-triangle' },
                    info: { bg: '#eff6ff', text: '#1e40af', border: '#1e40af', icon: 'fa-info-circle' }
                };
                
                const style = styles[type] || styles.info;
                
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.style.backgroundColor = style.bg;
                notification.style.color = style.text;
                notification.style.borderLeftColor = style.border;
                notification.style.border = `1px solid ${style.border}20`;
                notification.style.borderLeftWidth = '4px';
                
                notification.innerHTML = `
                    <i class="fas ${style.icon}"></i>
                    <span class="text-sm font-medium">${message}</span>
                    <button onclick="this.parentElement.remove()" class="ml-auto text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    notification.style.transition = 'all 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        };

        // ------------------------------------------------------------------
        // UTILITIES
        // ------------------------------------------------------------------
        const Utils = {
            escapeHTML(str) {
                if (!str) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            },
            
            escapeRegExp(str) {
                return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            },
            
            setText(id, text) {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            }
        };

        // ------------------------------------------------------------------
        // EVENT LISTENERS
        // ------------------------------------------------------------------
        function attachEventListeners() {
            document.addEventListener('keydown', e => {
                if (e.key === 'Escape') {
                    UI.closeImportModal();
                    UI.closeDashboard();
                    Annotation.close();
                }
            });
            
            document.addEventListener('click', e => {
                if (e.target.classList.contains('modal-overlay')) {
                    UI.closeImportModal();
                    UI.closeDashboard();
                    Annotation.close();
                }
            });
        }

        // ------------------------------------------------------------------
        // INITIALIZATION
        // ------------------------------------------------------------------
        async function initialize() {
            console.log(`🚀 Δ Helix v${CONFIG.VERSION} initializing...`);
            
            attachEventListeners();
            Search.initialize();
            
            await VariantService.loadAll();
            await VariantService.refreshStats();
            
            StatsUI.updateAll();
            Filter.apply();
            ViewCounts.update();
            
            Notification.show(`✓ System ready • ${STATE.variants.length} variants loaded`, 'success');
        }

        // ------------------------------------------------------------------
        // EXPOSE TO WINDOW
        // ------------------------------------------------------------------
        window.VariantService = VariantService;
        window.Variant = Variant;
        window.Filter = Filter;
        window.View = View;
        window.Pagination = Pagination;
        window.Import = Import;
        window.Annotation = Annotation;
        window.UI = UI;
        window.Report = Report;
        window.Notification = Notification;
        window.Utils = Utils;

        // Start the application
        initialize();
    </script>
</body>
</html>
